(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function a(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(o){if(o.ep)return;o.ep=!0;const i=a(o);fetch(o.href,i)}})();function ra(e,t){return e==null||t==null?NaN:e<t?-1:e>t?1:e>=t?0:NaN}function vs(e,t){return e==null||t==null?NaN:t<e?-1:t>e?1:t>=e?0:NaN}function Lr(e){let t,a,r;e.length!==2?(t=ra,a=(s,c)=>ra(e(s),c),r=(s,c)=>e(s)-c):(t=e===ra||e===vs?e:xs,a=e,r=e);function o(s,c,d=0,u=s.length){if(d<u){if(t(c,c)!==0)return u;do{const f=d+u>>>1;a(s[f],c)<0?d=f+1:u=f}while(d<u)}return d}function i(s,c,d=0,u=s.length){if(d<u){if(t(c,c)!==0)return u;do{const f=d+u>>>1;a(s[f],c)<=0?d=f+1:u=f}while(d<u)}return d}function l(s,c,d=0,u=s.length){const f=o(s,c,d,u-1);return f>d&&r(s[f-1],c)>-r(s[f],c)?f-1:f}return{left:o,center:l,right:i}}function xs(){return 0}function Zo(e){return e===null?NaN:+e}const ws=Lr(ra),Ss=ws.right;Lr(Zo).center;const Ms=Math.sqrt(50),$s=Math.sqrt(10),ks=Math.sqrt(2);function ha(e,t,a){const r=(t-e)/Math.max(0,a),o=Math.floor(Math.log10(r)),i=r/Math.pow(10,o),l=i>=Ms?10:i>=$s?5:i>=ks?2:1;let s,c,d;return o<0?(d=Math.pow(10,-o)/l,s=Math.round(e*d),c=Math.round(t*d),s/d<e&&++s,c/d>t&&--c,d=-d):(d=Math.pow(10,o)*l,s=Math.round(e/d),c=Math.round(t/d),s*d<e&&++s,c*d>t&&--c),c<s&&.5<=a&&a<2?ha(e,t,a*2):[s,c,d]}function Ds(e,t,a){if(t=+t,e=+e,a=+a,!(a>0))return[];if(e===t)return[e];const r=t<e,[o,i,l]=r?ha(t,e,a):ha(e,t,a);if(!(i>=o))return[];const s=i-o+1,c=new Array(s);if(r)if(l<0)for(let d=0;d<s;++d)c[d]=(i-d)/-l;else for(let d=0;d<s;++d)c[d]=(i-d)*l;else if(l<0)for(let d=0;d<s;++d)c[d]=(o+d)/-l;else for(let d=0;d<s;++d)c[d]=(o+d)*l;return c}function ir(e,t,a){return t=+t,e=+e,a=+a,ha(e,t,a)[2]}function sr(e,t,a){t=+t,e=+e,a=+a;const r=t<e,o=r?ir(t,e,a):ir(e,t,a);return(r?-1:1)*(o<0?1/-o:o)}function Ts(e,t){let a;for(const r of e)r!=null&&(a<r||a===void 0&&r>=r)&&(a=r);return a}function Ls(e,t){let a;for(const r of e)r!=null&&(a>r||a===void 0&&r>=r)&&(a=r);return a}function Xa(e,t,a=Zo){if(!(!(r=e.length)||isNaN(t=+t))){if(t<=0||r<2)return+a(e[0],0,e);if(t>=1)return+a(e[r-1],r-1,e);var r,o=(r-1)*t,i=Math.floor(o),l=+a(e[i],i,e),s=+a(e[i+1],i+1,e);return l+(s-l)*(o-i)}}function Es(e,t){let a=0,r=0;for(let o of e)o!=null&&(o=+o)>=o&&(++a,r+=o);if(a)return r/a}var Rs={value:()=>{}};function Er(){for(var e=0,t=arguments.length,a={},r;e<t;++e){if(!(r=arguments[e]+"")||r in a||/[\s.]/.test(r))throw new Error("illegal type: "+r);a[r]=[]}return new oa(a)}function oa(e){this._=e}function Ps(e,t){return e.trim().split(/^|\s+/).map(function(a){var r="",o=a.indexOf(".");if(o>=0&&(r=a.slice(o+1),a=a.slice(0,o)),a&&!t.hasOwnProperty(a))throw new Error("unknown type: "+a);return{type:a,name:r}})}oa.prototype=Er.prototype={constructor:oa,on:function(e,t){var a=this._,r=Ps(e+"",a),o,i=-1,l=r.length;if(arguments.length<2){for(;++i<l;)if((o=(e=r[i]).type)&&(o=Cs(a[o],e.name)))return o;return}if(t!=null&&typeof t!="function")throw new Error("invalid callback: "+t);for(;++i<l;)if(o=(e=r[i]).type)a[o]=Jr(a[o],e.name,t);else if(t==null)for(o in a)a[o]=Jr(a[o],e.name,null);return this},copy:function(){var e={},t=this._;for(var a in t)e[a]=t[a].slice();return new oa(e)},call:function(e,t){if((o=arguments.length-2)>0)for(var a=new Array(o),r=0,o,i;r<o;++r)a[r]=arguments[r+2];if(!this._.hasOwnProperty(e))throw new Error("unknown type: "+e);for(i=this._[e],r=0,o=i.length;r<o;++r)i[r].value.apply(t,a)},apply:function(e,t,a){if(!this._.hasOwnProperty(e))throw new Error("unknown type: "+e);for(var r=this._[e],o=0,i=r.length;o<i;++o)r[o].value.apply(t,a)}};function Cs(e,t){for(var a=0,r=e.length,o;a<r;++a)if((o=e[a]).name===t)return o.value}function Jr(e,t,a){for(var r=0,o=e.length;r<o;++r)if(e[r].name===t){e[r]=Rs,e=e.slice(0,r).concat(e.slice(r+1));break}return a!=null&&e.push({name:t,value:a}),e}var lr="http://www.w3.org/1999/xhtml";const eo={svg:"http://www.w3.org/2000/svg",xhtml:lr,xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};function _a(e){var t=e+="",a=t.indexOf(":");return a>=0&&(t=e.slice(0,a))!=="xmlns"&&(e=e.slice(a+1)),eo.hasOwnProperty(t)?{space:eo[t],local:e}:e}function Is(e){return function(){var t=this.ownerDocument,a=this.namespaceURI;return a===lr&&t.documentElement.namespaceURI===lr?t.createElement(e):t.createElementNS(a,e)}}function _s(e){return function(){return this.ownerDocument.createElementNS(e.space,e.local)}}function Jo(e){var t=_a(e);return(t.local?_s:Is)(t)}function As(){}function Rr(e){return e==null?As:function(){return this.querySelector(e)}}function Ns(e){typeof e!="function"&&(e=Rr(e));for(var t=this._groups,a=t.length,r=new Array(a),o=0;o<a;++o)for(var i=t[o],l=i.length,s=r[o]=new Array(l),c,d,u=0;u<l;++u)(c=i[u])&&(d=e.call(c,c.__data__,u,i))&&("__data__"in c&&(d.__data__=c.__data__),s[u]=d);return new ze(r,this._parents)}function Bs(e){return e==null?[]:Array.isArray(e)?e:Array.from(e)}function Vs(){return[]}function ei(e){return e==null?Vs:function(){return this.querySelectorAll(e)}}function Fs(e){return function(){return Bs(e.apply(this,arguments))}}function Us(e){typeof e=="function"?e=Fs(e):e=ei(e);for(var t=this._groups,a=t.length,r=[],o=[],i=0;i<a;++i)for(var l=t[i],s=l.length,c,d=0;d<s;++d)(c=l[d])&&(r.push(e.call(c,c.__data__,d,l)),o.push(c));return new ze(r,o)}function ti(e){return function(){return this.matches(e)}}function ni(e){return function(t){return t.matches(e)}}var Os=Array.prototype.find;function qs(e){return function(){return Os.call(this.children,e)}}function zs(){return this.firstElementChild}function Hs(e){return this.select(e==null?zs:qs(typeof e=="function"?e:ni(e)))}var Ws=Array.prototype.filter;function Ys(){return Array.from(this.children)}function Xs(e){return function(){return Ws.call(this.children,e)}}function js(e){return this.selectAll(e==null?Ys:Xs(typeof e=="function"?e:ni(e)))}function Ks(e){typeof e!="function"&&(e=ti(e));for(var t=this._groups,a=t.length,r=new Array(a),o=0;o<a;++o)for(var i=t[o],l=i.length,s=r[o]=[],c,d=0;d<l;++d)(c=i[d])&&e.call(c,c.__data__,d,i)&&s.push(c);return new ze(r,this._parents)}function ai(e){return new Array(e.length)}function Gs(){return new ze(this._enter||this._groups.map(ai),this._parents)}function ga(e,t){this.ownerDocument=e.ownerDocument,this.namespaceURI=e.namespaceURI,this._next=null,this._parent=e,this.__data__=t}ga.prototype={constructor:ga,appendChild:function(e){return this._parent.insertBefore(e,this._next)},insertBefore:function(e,t){return this._parent.insertBefore(e,t)},querySelector:function(e){return this._parent.querySelector(e)},querySelectorAll:function(e){return this._parent.querySelectorAll(e)}};function Qs(e){return function(){return e}}function Zs(e,t,a,r,o,i){for(var l=0,s,c=t.length,d=i.length;l<d;++l)(s=t[l])?(s.__data__=i[l],r[l]=s):a[l]=new ga(e,i[l]);for(;l<c;++l)(s=t[l])&&(o[l]=s)}function Js(e,t,a,r,o,i,l){var s,c,d=new Map,u=t.length,f=i.length,m=new Array(u),p;for(s=0;s<u;++s)(c=t[s])&&(m[s]=p=l.call(c,c.__data__,s,t)+"",d.has(p)?o[s]=c:d.set(p,c));for(s=0;s<f;++s)p=l.call(e,i[s],s,i)+"",(c=d.get(p))?(r[s]=c,c.__data__=i[s],d.delete(p)):a[s]=new ga(e,i[s]);for(s=0;s<u;++s)(c=t[s])&&d.get(m[s])===c&&(o[s]=c)}function el(e){return e.__data__}function tl(e,t){if(!arguments.length)return Array.from(this,el);var a=t?Js:Zs,r=this._parents,o=this._groups;typeof e!="function"&&(e=Qs(e));for(var i=o.length,l=new Array(i),s=new Array(i),c=new Array(i),d=0;d<i;++d){var u=r[d],f=o[d],m=f.length,p=nl(e.call(u,u&&u.__data__,d,r)),v=p.length,M=s[d]=new Array(v),S=l[d]=new Array(v),x=c[d]=new Array(m);a(u,f,M,S,x,p,t);for(var b=0,T=0,P,R;b<v;++b)if(P=M[b]){for(b>=T&&(T=b+1);!(R=S[T])&&++T<v;);P._next=R||null}}return l=new ze(l,r),l._enter=s,l._exit=c,l}function nl(e){return typeof e=="object"&&"length"in e?e:Array.from(e)}function al(){return new ze(this._exit||this._groups.map(ai),this._parents)}function rl(e,t,a){var r=this.enter(),o=this,i=this.exit();return typeof e=="function"?(r=e(r),r&&(r=r.selection())):r=r.append(e+""),t!=null&&(o=t(o),o&&(o=o.selection())),a==null?i.remove():a(i),r&&o?r.merge(o).order():o}function ol(e){for(var t=e.selection?e.selection():e,a=this._groups,r=t._groups,o=a.length,i=r.length,l=Math.min(o,i),s=new Array(o),c=0;c<l;++c)for(var d=a[c],u=r[c],f=d.length,m=s[c]=new Array(f),p,v=0;v<f;++v)(p=d[v]||u[v])&&(m[v]=p);for(;c<o;++c)s[c]=a[c];return new ze(s,this._parents)}function il(){for(var e=this._groups,t=-1,a=e.length;++t<a;)for(var r=e[t],o=r.length-1,i=r[o],l;--o>=0;)(l=r[o])&&(i&&l.compareDocumentPosition(i)^4&&i.parentNode.insertBefore(l,i),i=l);return this}function sl(e){e||(e=ll);function t(f,m){return f&&m?e(f.__data__,m.__data__):!f-!m}for(var a=this._groups,r=a.length,o=new Array(r),i=0;i<r;++i){for(var l=a[i],s=l.length,c=o[i]=new Array(s),d,u=0;u<s;++u)(d=l[u])&&(c[u]=d);c.sort(t)}return new ze(o,this._parents).order()}function ll(e,t){return e<t?-1:e>t?1:e>=t?0:NaN}function cl(){var e=arguments[0];return arguments[0]=this,e.apply(null,arguments),this}function dl(){return Array.from(this)}function ul(){for(var e=this._groups,t=0,a=e.length;t<a;++t)for(var r=e[t],o=0,i=r.length;o<i;++o){var l=r[o];if(l)return l}return null}function fl(){let e=0;for(const t of this)++e;return e}function ml(){return!this.node()}function pl(e){for(var t=this._groups,a=0,r=t.length;a<r;++a)for(var o=t[a],i=0,l=o.length,s;i<l;++i)(s=o[i])&&e.call(s,s.__data__,i,o);return this}function hl(e){return function(){this.removeAttribute(e)}}function gl(e){return function(){this.removeAttributeNS(e.space,e.local)}}function yl(e,t){return function(){this.setAttribute(e,t)}}function bl(e,t){return function(){this.setAttributeNS(e.space,e.local,t)}}function vl(e,t){return function(){var a=t.apply(this,arguments);a==null?this.removeAttribute(e):this.setAttribute(e,a)}}function xl(e,t){return function(){var a=t.apply(this,arguments);a==null?this.removeAttributeNS(e.space,e.local):this.setAttributeNS(e.space,e.local,a)}}function wl(e,t){var a=_a(e);if(arguments.length<2){var r=this.node();return a.local?r.getAttributeNS(a.space,a.local):r.getAttribute(a)}return this.each((t==null?a.local?gl:hl:typeof t=="function"?a.local?xl:vl:a.local?bl:yl)(a,t))}function ri(e){return e.ownerDocument&&e.ownerDocument.defaultView||e.document&&e||e.defaultView}function Sl(e){return function(){this.style.removeProperty(e)}}function Ml(e,t,a){return function(){this.style.setProperty(e,t,a)}}function $l(e,t,a){return function(){var r=t.apply(this,arguments);r==null?this.style.removeProperty(e):this.style.setProperty(e,r,a)}}function kl(e,t,a){return arguments.length>1?this.each((t==null?Sl:typeof t=="function"?$l:Ml)(e,t,a??"")):ln(this.node(),e)}function ln(e,t){return e.style.getPropertyValue(t)||ri(e).getComputedStyle(e,null).getPropertyValue(t)}function Dl(e){return function(){delete this[e]}}function Tl(e,t){return function(){this[e]=t}}function Ll(e,t){return function(){var a=t.apply(this,arguments);a==null?delete this[e]:this[e]=a}}function El(e,t){return arguments.length>1?this.each((t==null?Dl:typeof t=="function"?Ll:Tl)(e,t)):this.node()[e]}function oi(e){return e.trim().split(/^|\s+/)}function Pr(e){return e.classList||new ii(e)}function ii(e){this._node=e,this._names=oi(e.getAttribute("class")||"")}ii.prototype={add:function(e){var t=this._names.indexOf(e);t<0&&(this._names.push(e),this._node.setAttribute("class",this._names.join(" ")))},remove:function(e){var t=this._names.indexOf(e);t>=0&&(this._names.splice(t,1),this._node.setAttribute("class",this._names.join(" ")))},contains:function(e){return this._names.indexOf(e)>=0}};function si(e,t){for(var a=Pr(e),r=-1,o=t.length;++r<o;)a.add(t[r])}function li(e,t){for(var a=Pr(e),r=-1,o=t.length;++r<o;)a.remove(t[r])}function Rl(e){return function(){si(this,e)}}function Pl(e){return function(){li(this,e)}}function Cl(e,t){return function(){(t.apply(this,arguments)?si:li)(this,e)}}function Il(e,t){var a=oi(e+"");if(arguments.length<2){for(var r=Pr(this.node()),o=-1,i=a.length;++o<i;)if(!r.contains(a[o]))return!1;return!0}return this.each((typeof t=="function"?Cl:t?Rl:Pl)(a,t))}function _l(){this.textContent=""}function Al(e){return function(){this.textContent=e}}function Nl(e){return function(){var t=e.apply(this,arguments);this.textContent=t??""}}function Bl(e){return arguments.length?this.each(e==null?_l:(typeof e=="function"?Nl:Al)(e)):this.node().textContent}function Vl(){this.innerHTML=""}function Fl(e){return function(){this.innerHTML=e}}function Ul(e){return function(){var t=e.apply(this,arguments);this.innerHTML=t??""}}function Ol(e){return arguments.length?this.each(e==null?Vl:(typeof e=="function"?Ul:Fl)(e)):this.node().innerHTML}function ql(){this.nextSibling&&this.parentNode.appendChild(this)}function zl(){return this.each(ql)}function Hl(){this.previousSibling&&this.parentNode.insertBefore(this,this.parentNode.firstChild)}function Wl(){return this.each(Hl)}function Yl(e){var t=typeof e=="function"?e:Jo(e);return this.select(function(){return this.appendChild(t.apply(this,arguments))})}function Xl(){return null}function jl(e,t){var a=typeof e=="function"?e:Jo(e),r=t==null?Xl:typeof t=="function"?t:Rr(t);return this.select(function(){return this.insertBefore(a.apply(this,arguments),r.apply(this,arguments)||null)})}function Kl(){var e=this.parentNode;e&&e.removeChild(this)}function Gl(){return this.each(Kl)}function Ql(){var e=this.cloneNode(!1),t=this.parentNode;return t?t.insertBefore(e,this.nextSibling):e}function Zl(){var e=this.cloneNode(!0),t=this.parentNode;return t?t.insertBefore(e,this.nextSibling):e}function Jl(e){return this.select(e?Zl:Ql)}function ec(e){return arguments.length?this.property("__data__",e):this.node().__data__}function tc(e){return function(t){e.call(this,t,this.__data__)}}function nc(e){return e.trim().split(/^|\s+/).map(function(t){var a="",r=t.indexOf(".");return r>=0&&(a=t.slice(r+1),t=t.slice(0,r)),{type:t,name:a}})}function ac(e){return function(){var t=this.__on;if(t){for(var a=0,r=-1,o=t.length,i;a<o;++a)i=t[a],(!e.type||i.type===e.type)&&i.name===e.name?this.removeEventListener(i.type,i.listener,i.options):t[++r]=i;++r?t.length=r:delete this.__on}}}function rc(e,t,a){return function(){var r=this.__on,o,i=tc(t);if(r){for(var l=0,s=r.length;l<s;++l)if((o=r[l]).type===e.type&&o.name===e.name){this.removeEventListener(o.type,o.listener,o.options),this.addEventListener(o.type,o.listener=i,o.options=a),o.value=t;return}}this.addEventListener(e.type,i,a),o={type:e.type,name:e.name,value:t,listener:i,options:a},r?r.push(o):this.__on=[o]}}function oc(e,t,a){var r=nc(e+""),o,i=r.length,l;if(arguments.length<2){var s=this.node().__on;if(s){for(var c=0,d=s.length,u;c<d;++c)for(o=0,u=s[c];o<i;++o)if((l=r[o]).type===u.type&&l.name===u.name)return u.value}return}for(s=t?rc:ac,o=0;o<i;++o)this.each(s(r[o],t,a));return this}function ci(e,t,a){var r=ri(e),o=r.CustomEvent;typeof o=="function"?o=new o(t,a):(o=r.document.createEvent("Event"),a?(o.initEvent(t,a.bubbles,a.cancelable),o.detail=a.detail):o.initEvent(t,!1,!1)),e.dispatchEvent(o)}function ic(e,t){return function(){return ci(this,e,t)}}function sc(e,t){return function(){return ci(this,e,t.apply(this,arguments))}}function lc(e,t){return this.each((typeof t=="function"?sc:ic)(e,t))}function*cc(){for(var e=this._groups,t=0,a=e.length;t<a;++t)for(var r=e[t],o=0,i=r.length,l;o<i;++o)(l=r[o])&&(yield l)}var di=[null];function ze(e,t){this._groups=e,this._parents=t}function On(){return new ze([[document.documentElement]],di)}function dc(){return this}ze.prototype=On.prototype={constructor:ze,select:Ns,selectAll:Us,selectChild:Hs,selectChildren:js,filter:Ks,data:tl,enter:Gs,exit:al,join:rl,merge:ol,selection:dc,order:il,sort:sl,call:cl,nodes:dl,node:ul,size:fl,empty:ml,each:pl,attr:wl,style:kl,property:El,classed:Il,text:Bl,html:Ol,raise:zl,lower:Wl,append:Yl,insert:jl,remove:Gl,clone:Jl,datum:ec,on:oc,dispatch:lc,[Symbol.iterator]:cc};function lt(e){return typeof e=="string"?new ze([[document.querySelector(e)]],[document.documentElement]):new ze([[e]],di)}function uc(e){let t;for(;t=e.sourceEvent;)e=t;return e}function xt(e,t){if(e=uc(e),t===void 0&&(t=e.currentTarget),t){var a=t.ownerSVGElement||t;if(a.createSVGPoint){var r=a.createSVGPoint();return r.x=e.clientX,r.y=e.clientY,r=r.matrixTransform(t.getScreenCTM().inverse()),[r.x,r.y]}if(t.getBoundingClientRect){var o=t.getBoundingClientRect();return[e.clientX-o.left-t.clientLeft,e.clientY-o.top-t.clientTop]}}return[e.pageX,e.pageY]}const cr={capture:!0,passive:!1};function dr(e){e.preventDefault(),e.stopImmediatePropagation()}function fc(e){var t=e.document.documentElement,a=lt(e).on("dragstart.drag",dr,cr);"onselectstart"in t?a.on("selectstart.drag",dr,cr):(t.__noselect=t.style.MozUserSelect,t.style.MozUserSelect="none")}function mc(e,t){var a=e.document.documentElement,r=lt(e).on("dragstart.drag",null);t&&(r.on("click.drag",dr,cr),setTimeout(function(){r.on("click.drag",null)},0)),"onselectstart"in a?r.on("selectstart.drag",null):(a.style.MozUserSelect=a.__noselect,delete a.__noselect)}function Cr(e,t,a){e.prototype=t.prototype=a,a.constructor=e}function ui(e,t){var a=Object.create(e.prototype);for(var r in t)a[r]=t[r];return a}function qn(){}var An=.7,ya=1/An,rn="\\s*([+-]?\\d+)\\s*",Nn="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*",et="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*",pc=/^#([0-9a-f]{3,8})$/,hc=new RegExp(`^rgb\\(${rn},${rn},${rn}\\)$`),gc=new RegExp(`^rgb\\(${et},${et},${et}\\)$`),yc=new RegExp(`^rgba\\(${rn},${rn},${rn},${Nn}\\)$`),bc=new RegExp(`^rgba\\(${et},${et},${et},${Nn}\\)$`),vc=new RegExp(`^hsl\\(${Nn},${et},${et}\\)$`),xc=new RegExp(`^hsla\\(${Nn},${et},${et},${Nn}\\)$`),to={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};Cr(qn,Wt,{copy(e){return Object.assign(new this.constructor,this,e)},displayable(){return this.rgb().displayable()},hex:no,formatHex:no,formatHex8:wc,formatHsl:Sc,formatRgb:ao,toString:ao});function no(){return this.rgb().formatHex()}function wc(){return this.rgb().formatHex8()}function Sc(){return fi(this).formatHsl()}function ao(){return this.rgb().formatRgb()}function Wt(e){var t,a;return e=(e+"").trim().toLowerCase(),(t=pc.exec(e))?(a=t[1].length,t=parseInt(t[1],16),a===6?ro(t):a===3?new Ve(t>>8&15|t>>4&240,t>>4&15|t&240,(t&15)<<4|t&15,1):a===8?Kn(t>>24&255,t>>16&255,t>>8&255,(t&255)/255):a===4?Kn(t>>12&15|t>>8&240,t>>8&15|t>>4&240,t>>4&15|t&240,((t&15)<<4|t&15)/255):null):(t=hc.exec(e))?new Ve(t[1],t[2],t[3],1):(t=gc.exec(e))?new Ve(t[1]*255/100,t[2]*255/100,t[3]*255/100,1):(t=yc.exec(e))?Kn(t[1],t[2],t[3],t[4]):(t=bc.exec(e))?Kn(t[1]*255/100,t[2]*255/100,t[3]*255/100,t[4]):(t=vc.exec(e))?so(t[1],t[2]/100,t[3]/100,1):(t=xc.exec(e))?so(t[1],t[2]/100,t[3]/100,t[4]):to.hasOwnProperty(e)?ro(to[e]):e==="transparent"?new Ve(NaN,NaN,NaN,0):null}function ro(e){return new Ve(e>>16&255,e>>8&255,e&255,1)}function Kn(e,t,a,r){return r<=0&&(e=t=a=NaN),new Ve(e,t,a,r)}function Mc(e){return e instanceof qn||(e=Wt(e)),e?(e=e.rgb(),new Ve(e.r,e.g,e.b,e.opacity)):new Ve}function ur(e,t,a,r){return arguments.length===1?Mc(e):new Ve(e,t,a,r??1)}function Ve(e,t,a,r){this.r=+e,this.g=+t,this.b=+a,this.opacity=+r}Cr(Ve,ur,ui(qn,{brighter(e){return e=e==null?ya:Math.pow(ya,e),new Ve(this.r*e,this.g*e,this.b*e,this.opacity)},darker(e){return e=e==null?An:Math.pow(An,e),new Ve(this.r*e,this.g*e,this.b*e,this.opacity)},rgb(){return this},clamp(){return new Ve(zt(this.r),zt(this.g),zt(this.b),ba(this.opacity))},displayable(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:oo,formatHex:oo,formatHex8:$c,formatRgb:io,toString:io}));function oo(){return`#${Ut(this.r)}${Ut(this.g)}${Ut(this.b)}`}function $c(){return`#${Ut(this.r)}${Ut(this.g)}${Ut(this.b)}${Ut((isNaN(this.opacity)?1:this.opacity)*255)}`}function io(){const e=ba(this.opacity);return`${e===1?"rgb(":"rgba("}${zt(this.r)}, ${zt(this.g)}, ${zt(this.b)}${e===1?")":`, ${e})`}`}function ba(e){return isNaN(e)?1:Math.max(0,Math.min(1,e))}function zt(e){return Math.max(0,Math.min(255,Math.round(e)||0))}function Ut(e){return e=zt(e),(e<16?"0":"")+e.toString(16)}function so(e,t,a,r){return r<=0?e=t=a=NaN:a<=0||a>=1?e=t=NaN:t<=0&&(e=NaN),new je(e,t,a,r)}function fi(e){if(e instanceof je)return new je(e.h,e.s,e.l,e.opacity);if(e instanceof qn||(e=Wt(e)),!e)return new je;if(e instanceof je)return e;e=e.rgb();var t=e.r/255,a=e.g/255,r=e.b/255,o=Math.min(t,a,r),i=Math.max(t,a,r),l=NaN,s=i-o,c=(i+o)/2;return s?(t===i?l=(a-r)/s+(a<r)*6:a===i?l=(r-t)/s+2:l=(t-a)/s+4,s/=c<.5?i+o:2-i-o,l*=60):s=c>0&&c<1?0:l,new je(l,s,c,e.opacity)}function kc(e,t,a,r){return arguments.length===1?fi(e):new je(e,t,a,r??1)}function je(e,t,a,r){this.h=+e,this.s=+t,this.l=+a,this.opacity=+r}Cr(je,kc,ui(qn,{brighter(e){return e=e==null?ya:Math.pow(ya,e),new je(this.h,this.s,this.l*e,this.opacity)},darker(e){return e=e==null?An:Math.pow(An,e),new je(this.h,this.s,this.l*e,this.opacity)},rgb(){var e=this.h%360+(this.h<0)*360,t=isNaN(e)||isNaN(this.s)?0:this.s,a=this.l,r=a+(a<.5?a:1-a)*t,o=2*a-r;return new Ve(ja(e>=240?e-240:e+120,o,r),ja(e,o,r),ja(e<120?e+240:e-120,o,r),this.opacity)},clamp(){return new je(lo(this.h),Gn(this.s),Gn(this.l),ba(this.opacity))},displayable(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl(){const e=ba(this.opacity);return`${e===1?"hsl(":"hsla("}${lo(this.h)}, ${Gn(this.s)*100}%, ${Gn(this.l)*100}%${e===1?")":`, ${e})`}`}}));function lo(e){return e=(e||0)%360,e<0?e+360:e}function Gn(e){return Math.max(0,Math.min(1,e||0))}function ja(e,t,a){return(e<60?t+(a-t)*e/60:e<180?a:e<240?t+(a-t)*(240-e)/60:t)*255}const Ir=e=>()=>e;function Dc(e,t){return function(a){return e+a*t}}function Tc(e,t,a){return e=Math.pow(e,a),t=Math.pow(t,a)-e,a=1/a,function(r){return Math.pow(e+r*t,a)}}function Lc(e){return(e=+e)==1?mi:function(t,a){return a-t?Tc(t,a,e):Ir(isNaN(t)?a:t)}}function mi(e,t){var a=t-e;return a?Dc(e,a):Ir(isNaN(e)?t:e)}const va=(function e(t){var a=Lc(t);function r(o,i){var l=a((o=ur(o)).r,(i=ur(i)).r),s=a(o.g,i.g),c=a(o.b,i.b),d=mi(o.opacity,i.opacity);return function(u){return o.r=l(u),o.g=s(u),o.b=c(u),o.opacity=d(u),o+""}}return r.gamma=e,r})(1);function Ec(e,t){t||(t=[]);var a=e?Math.min(t.length,e.length):0,r=t.slice(),o;return function(i){for(o=0;o<a;++o)r[o]=e[o]*(1-i)+t[o]*i;return r}}function Rc(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)}function Pc(e,t){var a=t?t.length:0,r=e?Math.min(a,e.length):0,o=new Array(r),i=new Array(a),l;for(l=0;l<r;++l)o[l]=_r(e[l],t[l]);for(;l<a;++l)i[l]=t[l];return function(s){for(l=0;l<r;++l)i[l]=o[l](s);return i}}function Cc(e,t){var a=new Date;return e=+e,t=+t,function(r){return a.setTime(e*(1-r)+t*r),a}}function Xe(e,t){return e=+e,t=+t,function(a){return e*(1-a)+t*a}}function Ic(e,t){var a={},r={},o;(e===null||typeof e!="object")&&(e={}),(t===null||typeof t!="object")&&(t={});for(o in t)o in e?a[o]=_r(e[o],t[o]):r[o]=t[o];return function(i){for(o in a)r[o]=a[o](i);return r}}var fr=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,Ka=new RegExp(fr.source,"g");function _c(e){return function(){return e}}function Ac(e){return function(t){return e(t)+""}}function pi(e,t){var a=fr.lastIndex=Ka.lastIndex=0,r,o,i,l=-1,s=[],c=[];for(e=e+"",t=t+"";(r=fr.exec(e))&&(o=Ka.exec(t));)(i=o.index)>a&&(i=t.slice(a,i),s[l]?s[l]+=i:s[++l]=i),(r=r[0])===(o=o[0])?s[l]?s[l]+=o:s[++l]=o:(s[++l]=null,c.push({i:l,x:Xe(r,o)})),a=Ka.lastIndex;return a<t.length&&(i=t.slice(a),s[l]?s[l]+=i:s[++l]=i),s.length<2?c[0]?Ac(c[0].x):_c(t):(t=c.length,function(d){for(var u=0,f;u<t;++u)s[(f=c[u]).i]=f.x(d);return s.join("")})}function _r(e,t){var a=typeof t,r;return t==null||a==="boolean"?Ir(t):(a==="number"?Xe:a==="string"?(r=Wt(t))?(t=r,va):pi:t instanceof Wt?va:t instanceof Date?Cc:Rc(t)?Ec:Array.isArray(t)?Pc:typeof t.valueOf!="function"&&typeof t.toString!="function"||isNaN(t)?Ic:Xe)(e,t)}function Nc(e,t){return e=+e,t=+t,function(a){return Math.round(e*(1-a)+t*a)}}var co=180/Math.PI,mr={translateX:0,translateY:0,rotate:0,skewX:0,scaleX:1,scaleY:1};function hi(e,t,a,r,o,i){var l,s,c;return(l=Math.sqrt(e*e+t*t))&&(e/=l,t/=l),(c=e*a+t*r)&&(a-=e*c,r-=t*c),(s=Math.sqrt(a*a+r*r))&&(a/=s,r/=s,c/=s),e*r<t*a&&(e=-e,t=-t,c=-c,l=-l),{translateX:o,translateY:i,rotate:Math.atan2(t,e)*co,skewX:Math.atan(c)*co,scaleX:l,scaleY:s}}var Qn;function Bc(e){const t=new(typeof DOMMatrix=="function"?DOMMatrix:WebKitCSSMatrix)(e+"");return t.isIdentity?mr:hi(t.a,t.b,t.c,t.d,t.e,t.f)}function Vc(e){return e==null||(Qn||(Qn=document.createElementNS("http://www.w3.org/2000/svg","g")),Qn.setAttribute("transform",e),!(e=Qn.transform.baseVal.consolidate()))?mr:(e=e.matrix,hi(e.a,e.b,e.c,e.d,e.e,e.f))}function gi(e,t,a,r){function o(d){return d.length?d.pop()+" ":""}function i(d,u,f,m,p,v){if(d!==f||u!==m){var M=p.push("translate(",null,t,null,a);v.push({i:M-4,x:Xe(d,f)},{i:M-2,x:Xe(u,m)})}else(f||m)&&p.push("translate("+f+t+m+a)}function l(d,u,f,m){d!==u?(d-u>180?u+=360:u-d>180&&(d+=360),m.push({i:f.push(o(f)+"rotate(",null,r)-2,x:Xe(d,u)})):u&&f.push(o(f)+"rotate("+u+r)}function s(d,u,f,m){d!==u?m.push({i:f.push(o(f)+"skewX(",null,r)-2,x:Xe(d,u)}):u&&f.push(o(f)+"skewX("+u+r)}function c(d,u,f,m,p,v){if(d!==f||u!==m){var M=p.push(o(p)+"scale(",null,",",null,")");v.push({i:M-4,x:Xe(d,f)},{i:M-2,x:Xe(u,m)})}else(f!==1||m!==1)&&p.push(o(p)+"scale("+f+","+m+")")}return function(d,u){var f=[],m=[];return d=e(d),u=e(u),i(d.translateX,d.translateY,u.translateX,u.translateY,f,m),l(d.rotate,u.rotate,f,m),s(d.skewX,u.skewX,f,m),c(d.scaleX,d.scaleY,u.scaleX,u.scaleY,f,m),d=u=null,function(p){for(var v=-1,M=m.length,S;++v<M;)f[(S=m[v]).i]=S.x(p);return f.join("")}}}var Fc=gi(Bc,"px, ","px)","deg)"),Uc=gi(Vc,", ",")",")"),Oc=1e-12;function uo(e){return((e=Math.exp(e))+1/e)/2}function qc(e){return((e=Math.exp(e))-1/e)/2}function zc(e){return((e=Math.exp(2*e))-1)/(e+1)}const Hc=(function e(t,a,r){function o(i,l){var s=i[0],c=i[1],d=i[2],u=l[0],f=l[1],m=l[2],p=u-s,v=f-c,M=p*p+v*v,S,x;if(M<Oc)x=Math.log(m/d)/t,S=function(_){return[s+_*p,c+_*v,d*Math.exp(t*_*x)]};else{var b=Math.sqrt(M),T=(m*m-d*d+r*M)/(2*d*a*b),P=(m*m-d*d-r*M)/(2*m*a*b),R=Math.log(Math.sqrt(T*T+1)-T),k=Math.log(Math.sqrt(P*P+1)-P);x=(k-R)/t,S=function(_){var Y=_*x,K=uo(R),z=d/(a*b)*(K*zc(t*Y+R)-qc(R));return[s+z*p,c+z*v,d*K/uo(t*Y+R)]}}return S.duration=x*1e3*t/Math.SQRT2,S}return o.rho=function(i){var l=Math.max(.001,+i),s=l*l,c=s*s;return e(l,s,c)},o})(Math.SQRT2,2,4);var cn=0,$n=0,yn=0,yi=1e3,xa,kn,wa=0,Yt=0,Aa=0,Bn=typeof performance=="object"&&performance.now?performance:Date,bi=typeof window=="object"&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(e){setTimeout(e,17)};function Ar(){return Yt||(bi(Wc),Yt=Bn.now()+Aa)}function Wc(){Yt=0}function Sa(){this._call=this._time=this._next=null}Sa.prototype=vi.prototype={constructor:Sa,restart:function(e,t,a){if(typeof e!="function")throw new TypeError("callback is not a function");a=(a==null?Ar():+a)+(t==null?0:+t),!this._next&&kn!==this&&(kn?kn._next=this:xa=this,kn=this),this._call=e,this._time=a,pr()},stop:function(){this._call&&(this._call=null,this._time=1/0,pr())}};function vi(e,t,a){var r=new Sa;return r.restart(e,t,a),r}function Yc(){Ar(),++cn;for(var e=xa,t;e;)(t=Yt-e._time)>=0&&e._call.call(void 0,t),e=e._next;--cn}function fo(){Yt=(wa=Bn.now())+Aa,cn=$n=0;try{Yc()}finally{cn=0,jc(),Yt=0}}function Xc(){var e=Bn.now(),t=e-wa;t>yi&&(Aa-=t,wa=e)}function jc(){for(var e,t=xa,a,r=1/0;t;)t._call?(r>t._time&&(r=t._time),e=t,t=t._next):(a=t._next,t._next=null,t=e?e._next=a:xa=a);kn=e,pr(r)}function pr(e){if(!cn){$n&&($n=clearTimeout($n));var t=e-Yt;t>24?(e<1/0&&($n=setTimeout(fo,e-Bn.now()-Aa)),yn&&(yn=clearInterval(yn))):(yn||(wa=Bn.now(),yn=setInterval(Xc,yi)),cn=1,bi(fo))}}function mo(e,t,a){var r=new Sa;return t=t==null?0:+t,r.restart(o=>{r.stop(),e(o+t)},t,a),r}var Kc=Er("start","end","cancel","interrupt"),Gc=[],xi=0,po=1,hr=2,ia=3,ho=4,gr=5,sa=6;function Na(e,t,a,r,o,i){var l=e.__transition;if(!l)e.__transition={};else if(a in l)return;Qc(e,a,{name:t,index:r,group:o,on:Kc,tween:Gc,time:i.time,delay:i.delay,duration:i.duration,ease:i.ease,timer:null,state:xi})}function Nr(e,t){var a=Ge(e,t);if(a.state>xi)throw new Error("too late; already scheduled");return a}function nt(e,t){var a=Ge(e,t);if(a.state>ia)throw new Error("too late; already running");return a}function Ge(e,t){var a=e.__transition;if(!a||!(a=a[t]))throw new Error("transition not found");return a}function Qc(e,t,a){var r=e.__transition,o;r[t]=a,a.timer=vi(i,0,a.time);function i(d){a.state=po,a.timer.restart(l,a.delay,a.time),a.delay<=d&&l(d-a.delay)}function l(d){var u,f,m,p;if(a.state!==po)return c();for(u in r)if(p=r[u],p.name===a.name){if(p.state===ia)return mo(l);p.state===ho?(p.state=sa,p.timer.stop(),p.on.call("interrupt",e,e.__data__,p.index,p.group),delete r[u]):+u<t&&(p.state=sa,p.timer.stop(),p.on.call("cancel",e,e.__data__,p.index,p.group),delete r[u])}if(mo(function(){a.state===ia&&(a.state=ho,a.timer.restart(s,a.delay,a.time),s(d))}),a.state=hr,a.on.call("start",e,e.__data__,a.index,a.group),a.state===hr){for(a.state=ia,o=new Array(m=a.tween.length),u=0,f=-1;u<m;++u)(p=a.tween[u].value.call(e,e.__data__,a.index,a.group))&&(o[++f]=p);o.length=f+1}}function s(d){for(var u=d<a.duration?a.ease.call(null,d/a.duration):(a.timer.restart(c),a.state=gr,1),f=-1,m=o.length;++f<m;)o[f].call(e,u);a.state===gr&&(a.on.call("end",e,e.__data__,a.index,a.group),c())}function c(){a.state=sa,a.timer.stop(),delete r[t];for(var d in r)return;delete e.__transition}}function la(e,t){var a=e.__transition,r,o,i=!0,l;if(a){t=t==null?null:t+"";for(l in a){if((r=a[l]).name!==t){i=!1;continue}o=r.state>hr&&r.state<gr,r.state=sa,r.timer.stop(),r.on.call(o?"interrupt":"cancel",e,e.__data__,r.index,r.group),delete a[l]}i&&delete e.__transition}}function Zc(e){return this.each(function(){la(this,e)})}function Jc(e,t){var a,r;return function(){var o=nt(this,e),i=o.tween;if(i!==a){r=a=i;for(var l=0,s=r.length;l<s;++l)if(r[l].name===t){r=r.slice(),r.splice(l,1);break}}o.tween=r}}function ed(e,t,a){var r,o;if(typeof a!="function")throw new Error;return function(){var i=nt(this,e),l=i.tween;if(l!==r){o=(r=l).slice();for(var s={name:t,value:a},c=0,d=o.length;c<d;++c)if(o[c].name===t){o[c]=s;break}c===d&&o.push(s)}i.tween=o}}function td(e,t){var a=this._id;if(e+="",arguments.length<2){for(var r=Ge(this.node(),a).tween,o=0,i=r.length,l;o<i;++o)if((l=r[o]).name===e)return l.value;return null}return this.each((t==null?Jc:ed)(a,e,t))}function Br(e,t,a){var r=e._id;return e.each(function(){var o=nt(this,r);(o.value||(o.value={}))[t]=a.apply(this,arguments)}),function(o){return Ge(o,r).value[t]}}function wi(e,t){var a;return(typeof t=="number"?Xe:t instanceof Wt?va:(a=Wt(t))?(t=a,va):pi)(e,t)}function nd(e){return function(){this.removeAttribute(e)}}function ad(e){return function(){this.removeAttributeNS(e.space,e.local)}}function rd(e,t,a){var r,o=a+"",i;return function(){var l=this.getAttribute(e);return l===o?null:l===r?i:i=t(r=l,a)}}function od(e,t,a){var r,o=a+"",i;return function(){var l=this.getAttributeNS(e.space,e.local);return l===o?null:l===r?i:i=t(r=l,a)}}function id(e,t,a){var r,o,i;return function(){var l,s=a(this),c;return s==null?void this.removeAttribute(e):(l=this.getAttribute(e),c=s+"",l===c?null:l===r&&c===o?i:(o=c,i=t(r=l,s)))}}function sd(e,t,a){var r,o,i;return function(){var l,s=a(this),c;return s==null?void this.removeAttributeNS(e.space,e.local):(l=this.getAttributeNS(e.space,e.local),c=s+"",l===c?null:l===r&&c===o?i:(o=c,i=t(r=l,s)))}}function ld(e,t){var a=_a(e),r=a==="transform"?Uc:wi;return this.attrTween(e,typeof t=="function"?(a.local?sd:id)(a,r,Br(this,"attr."+e,t)):t==null?(a.local?ad:nd)(a):(a.local?od:rd)(a,r,t))}function cd(e,t){return function(a){this.setAttribute(e,t.call(this,a))}}function dd(e,t){return function(a){this.setAttributeNS(e.space,e.local,t.call(this,a))}}function ud(e,t){var a,r;function o(){var i=t.apply(this,arguments);return i!==r&&(a=(r=i)&&dd(e,i)),a}return o._value=t,o}function fd(e,t){var a,r;function o(){var i=t.apply(this,arguments);return i!==r&&(a=(r=i)&&cd(e,i)),a}return o._value=t,o}function md(e,t){var a="attr."+e;if(arguments.length<2)return(a=this.tween(a))&&a._value;if(t==null)return this.tween(a,null);if(typeof t!="function")throw new Error;var r=_a(e);return this.tween(a,(r.local?ud:fd)(r,t))}function pd(e,t){return function(){Nr(this,e).delay=+t.apply(this,arguments)}}function hd(e,t){return t=+t,function(){Nr(this,e).delay=t}}function gd(e){var t=this._id;return arguments.length?this.each((typeof e=="function"?pd:hd)(t,e)):Ge(this.node(),t).delay}function yd(e,t){return function(){nt(this,e).duration=+t.apply(this,arguments)}}function bd(e,t){return t=+t,function(){nt(this,e).duration=t}}function vd(e){var t=this._id;return arguments.length?this.each((typeof e=="function"?yd:bd)(t,e)):Ge(this.node(),t).duration}function xd(e,t){if(typeof t!="function")throw new Error;return function(){nt(this,e).ease=t}}function wd(e){var t=this._id;return arguments.length?this.each(xd(t,e)):Ge(this.node(),t).ease}function Sd(e,t){return function(){var a=t.apply(this,arguments);if(typeof a!="function")throw new Error;nt(this,e).ease=a}}function Md(e){if(typeof e!="function")throw new Error;return this.each(Sd(this._id,e))}function $d(e){typeof e!="function"&&(e=ti(e));for(var t=this._groups,a=t.length,r=new Array(a),o=0;o<a;++o)for(var i=t[o],l=i.length,s=r[o]=[],c,d=0;d<l;++d)(c=i[d])&&e.call(c,c.__data__,d,i)&&s.push(c);return new pt(r,this._parents,this._name,this._id)}function kd(e){if(e._id!==this._id)throw new Error;for(var t=this._groups,a=e._groups,r=t.length,o=a.length,i=Math.min(r,o),l=new Array(r),s=0;s<i;++s)for(var c=t[s],d=a[s],u=c.length,f=l[s]=new Array(u),m,p=0;p<u;++p)(m=c[p]||d[p])&&(f[p]=m);for(;s<r;++s)l[s]=t[s];return new pt(l,this._parents,this._name,this._id)}function Dd(e){return(e+"").trim().split(/^|\s+/).every(function(t){var a=t.indexOf(".");return a>=0&&(t=t.slice(0,a)),!t||t==="start"})}function Td(e,t,a){var r,o,i=Dd(t)?Nr:nt;return function(){var l=i(this,e),s=l.on;s!==r&&(o=(r=s).copy()).on(t,a),l.on=o}}function Ld(e,t){var a=this._id;return arguments.length<2?Ge(this.node(),a).on.on(e):this.each(Td(a,e,t))}function Ed(e){return function(){var t=this.parentNode;for(var a in this.__transition)if(+a!==e)return;t&&t.removeChild(this)}}function Rd(){return this.on("end.remove",Ed(this._id))}function Pd(e){var t=this._name,a=this._id;typeof e!="function"&&(e=Rr(e));for(var r=this._groups,o=r.length,i=new Array(o),l=0;l<o;++l)for(var s=r[l],c=s.length,d=i[l]=new Array(c),u,f,m=0;m<c;++m)(u=s[m])&&(f=e.call(u,u.__data__,m,s))&&("__data__"in u&&(f.__data__=u.__data__),d[m]=f,Na(d[m],t,a,m,d,Ge(u,a)));return new pt(i,this._parents,t,a)}function Cd(e){var t=this._name,a=this._id;typeof e!="function"&&(e=ei(e));for(var r=this._groups,o=r.length,i=[],l=[],s=0;s<o;++s)for(var c=r[s],d=c.length,u,f=0;f<d;++f)if(u=c[f]){for(var m=e.call(u,u.__data__,f,c),p,v=Ge(u,a),M=0,S=m.length;M<S;++M)(p=m[M])&&Na(p,t,a,M,m,v);i.push(m),l.push(u)}return new pt(i,l,t,a)}var Id=On.prototype.constructor;function _d(){return new Id(this._groups,this._parents)}function Ad(e,t){var a,r,o;return function(){var i=ln(this,e),l=(this.style.removeProperty(e),ln(this,e));return i===l?null:i===a&&l===r?o:o=t(a=i,r=l)}}function Si(e){return function(){this.style.removeProperty(e)}}function Nd(e,t,a){var r,o=a+"",i;return function(){var l=ln(this,e);return l===o?null:l===r?i:i=t(r=l,a)}}function Bd(e,t,a){var r,o,i;return function(){var l=ln(this,e),s=a(this),c=s+"";return s==null&&(c=s=(this.style.removeProperty(e),ln(this,e))),l===c?null:l===r&&c===o?i:(o=c,i=t(r=l,s))}}function Vd(e,t){var a,r,o,i="style."+t,l="end."+i,s;return function(){var c=nt(this,e),d=c.on,u=c.value[i]==null?s||(s=Si(t)):void 0;(d!==a||o!==u)&&(r=(a=d).copy()).on(l,o=u),c.on=r}}function Fd(e,t,a){var r=(e+="")=="transform"?Fc:wi;return t==null?this.styleTween(e,Ad(e,r)).on("end.style."+e,Si(e)):typeof t=="function"?this.styleTween(e,Bd(e,r,Br(this,"style."+e,t))).each(Vd(this._id,e)):this.styleTween(e,Nd(e,r,t),a).on("end.style."+e,null)}function Ud(e,t,a){return function(r){this.style.setProperty(e,t.call(this,r),a)}}function Od(e,t,a){var r,o;function i(){var l=t.apply(this,arguments);return l!==o&&(r=(o=l)&&Ud(e,l,a)),r}return i._value=t,i}function qd(e,t,a){var r="style."+(e+="");if(arguments.length<2)return(r=this.tween(r))&&r._value;if(t==null)return this.tween(r,null);if(typeof t!="function")throw new Error;return this.tween(r,Od(e,t,a??""))}function zd(e){return function(){this.textContent=e}}function Hd(e){return function(){var t=e(this);this.textContent=t??""}}function Wd(e){return this.tween("text",typeof e=="function"?Hd(Br(this,"text",e)):zd(e==null?"":e+""))}function Yd(e){return function(t){this.textContent=e.call(this,t)}}function Xd(e){var t,a;function r(){var o=e.apply(this,arguments);return o!==a&&(t=(a=o)&&Yd(o)),t}return r._value=e,r}function jd(e){var t="text";if(arguments.length<1)return(t=this.tween(t))&&t._value;if(e==null)return this.tween(t,null);if(typeof e!="function")throw new Error;return this.tween(t,Xd(e))}function Kd(){for(var e=this._name,t=this._id,a=Mi(),r=this._groups,o=r.length,i=0;i<o;++i)for(var l=r[i],s=l.length,c,d=0;d<s;++d)if(c=l[d]){var u=Ge(c,t);Na(c,e,a,d,l,{time:u.time+u.delay+u.duration,delay:0,duration:u.duration,ease:u.ease})}return new pt(r,this._parents,e,a)}function Gd(){var e,t,a=this,r=a._id,o=a.size();return new Promise(function(i,l){var s={value:l},c={value:function(){--o===0&&i()}};a.each(function(){var d=nt(this,r),u=d.on;u!==e&&(t=(e=u).copy(),t._.cancel.push(s),t._.interrupt.push(s),t._.end.push(c)),d.on=t}),o===0&&i()})}var Qd=0;function pt(e,t,a,r){this._groups=e,this._parents=t,this._name=a,this._id=r}function Mi(){return++Qd}var at=On.prototype;pt.prototype={constructor:pt,select:Pd,selectAll:Cd,selectChild:at.selectChild,selectChildren:at.selectChildren,filter:$d,merge:kd,selection:_d,transition:Kd,call:at.call,nodes:at.nodes,node:at.node,size:at.size,empty:at.empty,each:at.each,on:Ld,attr:ld,attrTween:md,style:Fd,styleTween:qd,text:Wd,textTween:jd,remove:Rd,tween:td,delay:gd,duration:vd,ease:wd,easeVarying:Md,end:Gd,[Symbol.iterator]:at[Symbol.iterator]};function Zd(e){return--e*e*e+1}function Jd(e){return((e*=2)<=1?e*e*e:(e-=2)*e*e+2)/2}var eu={time:null,delay:0,duration:250,ease:Jd};function tu(e,t){for(var a;!(a=e.__transition)||!(a=a[t]);)if(!(e=e.parentNode))throw new Error(`transition ${t} not found`);return a}function nu(e){var t,a;e instanceof pt?(t=e._id,e=e._name):(t=Mi(),(a=eu).time=Ar(),e=e==null?null:e+"");for(var r=this._groups,o=r.length,i=0;i<o;++i)for(var l=r[i],s=l.length,c,d=0;d<s;++d)(c=l[d])&&Na(c,e,t,d,l,a||tu(c,t));return new pt(r,this._parents,e,t)}On.prototype.interrupt=Zc;On.prototype.transition=nu;function au(e){return Math.abs(e=Math.round(e))>=1e21?e.toLocaleString("en").replace(/,/g,""):e.toString(10)}function Ma(e,t){if((a=(e=t?e.toExponential(t-1):e.toExponential()).indexOf("e"))<0)return null;var a,r=e.slice(0,a);return[r.length>1?r[0]+r.slice(2):r,+e.slice(a+1)]}function dn(e){return e=Ma(Math.abs(e)),e?e[1]:NaN}function ru(e,t){return function(a,r){for(var o=a.length,i=[],l=0,s=e[0],c=0;o>0&&s>0&&(c+s+1>r&&(s=Math.max(1,r-c)),i.push(a.substring(o-=s,o+s)),!((c+=s+1)>r));)s=e[l=(l+1)%e.length];return i.reverse().join(t)}}function ou(e){return function(t){return t.replace(/[0-9]/g,function(a){return e[+a]})}}var iu=/^(?:(.)?([<>=^]))?([+\-( ])?([$#])?(0)?(\d+)?(,)?(\.\d+)?(~)?([a-z%])?$/i;function $a(e){if(!(t=iu.exec(e)))throw new Error("invalid format: "+e);var t;return new Vr({fill:t[1],align:t[2],sign:t[3],symbol:t[4],zero:t[5],width:t[6],comma:t[7],precision:t[8]&&t[8].slice(1),trim:t[9],type:t[10]})}$a.prototype=Vr.prototype;function Vr(e){this.fill=e.fill===void 0?" ":e.fill+"",this.align=e.align===void 0?">":e.align+"",this.sign=e.sign===void 0?"-":e.sign+"",this.symbol=e.symbol===void 0?"":e.symbol+"",this.zero=!!e.zero,this.width=e.width===void 0?void 0:+e.width,this.comma=!!e.comma,this.precision=e.precision===void 0?void 0:+e.precision,this.trim=!!e.trim,this.type=e.type===void 0?"":e.type+""}Vr.prototype.toString=function(){return this.fill+this.align+this.sign+this.symbol+(this.zero?"0":"")+(this.width===void 0?"":Math.max(1,this.width|0))+(this.comma?",":"")+(this.precision===void 0?"":"."+Math.max(0,this.precision|0))+(this.trim?"~":"")+this.type};function su(e){e:for(var t=e.length,a=1,r=-1,o;a<t;++a)switch(e[a]){case".":r=o=a;break;case"0":r===0&&(r=a),o=a;break;default:if(!+e[a])break e;r>0&&(r=0);break}return r>0?e.slice(0,r)+e.slice(o+1):e}var $i;function lu(e,t){var a=Ma(e,t);if(!a)return e+"";var r=a[0],o=a[1],i=o-($i=Math.max(-8,Math.min(8,Math.floor(o/3)))*3)+1,l=r.length;return i===l?r:i>l?r+new Array(i-l+1).join("0"):i>0?r.slice(0,i)+"."+r.slice(i):"0."+new Array(1-i).join("0")+Ma(e,Math.max(0,t+i-1))[0]}function go(e,t){var a=Ma(e,t);if(!a)return e+"";var r=a[0],o=a[1];return o<0?"0."+new Array(-o).join("0")+r:r.length>o+1?r.slice(0,o+1)+"."+r.slice(o+1):r+new Array(o-r.length+2).join("0")}const yo={"%":(e,t)=>(e*100).toFixed(t),b:e=>Math.round(e).toString(2),c:e=>e+"",d:au,e:(e,t)=>e.toExponential(t),f:(e,t)=>e.toFixed(t),g:(e,t)=>e.toPrecision(t),o:e=>Math.round(e).toString(8),p:(e,t)=>go(e*100,t),r:go,s:lu,X:e=>Math.round(e).toString(16).toUpperCase(),x:e=>Math.round(e).toString(16)};function bo(e){return e}var vo=Array.prototype.map,xo=["y","z","a","f","p","n","µ","m","","k","M","G","T","P","E","Z","Y"];function cu(e){var t=e.grouping===void 0||e.thousands===void 0?bo:ru(vo.call(e.grouping,Number),e.thousands+""),a=e.currency===void 0?"":e.currency[0]+"",r=e.currency===void 0?"":e.currency[1]+"",o=e.decimal===void 0?".":e.decimal+"",i=e.numerals===void 0?bo:ou(vo.call(e.numerals,String)),l=e.percent===void 0?"%":e.percent+"",s=e.minus===void 0?"−":e.minus+"",c=e.nan===void 0?"NaN":e.nan+"";function d(f){f=$a(f);var m=f.fill,p=f.align,v=f.sign,M=f.symbol,S=f.zero,x=f.width,b=f.comma,T=f.precision,P=f.trim,R=f.type;R==="n"?(b=!0,R="g"):yo[R]||(T===void 0&&(T=12),P=!0,R="g"),(S||m==="0"&&p==="=")&&(S=!0,m="0",p="=");var k=M==="$"?a:M==="#"&&/[boxX]/.test(R)?"0"+R.toLowerCase():"",_=M==="$"?r:/[%p]/.test(R)?l:"",Y=yo[R],K=/[defgprs%]/.test(R);T=T===void 0?6:/[gprs]/.test(R)?Math.max(1,Math.min(21,T)):Math.max(0,Math.min(20,T));function z(U){var te=k,J=_,w,q,I;if(R==="c")J=Y(U)+J,U="";else{U=+U;var X=U<0||1/U<0;if(U=isNaN(U)?c:Y(Math.abs(U),T),P&&(U=su(U)),X&&+U==0&&v!=="+"&&(X=!1),te=(X?v==="("?v:s:v==="-"||v==="("?"":v)+te,J=(R==="s"?xo[8+$i/3]:"")+J+(X&&v==="("?")":""),K){for(w=-1,q=U.length;++w<q;)if(I=U.charCodeAt(w),48>I||I>57){J=(I===46?o+U.slice(w+1):U.slice(w))+J,U=U.slice(0,w);break}}}b&&!S&&(U=t(U,1/0));var A=te.length+U.length+J.length,H=A<x?new Array(x-A+1).join(m):"";switch(b&&S&&(U=t(H+U,H.length?x-J.length:1/0),H=""),p){case"<":U=te+U+J+H;break;case"=":U=te+H+U+J;break;case"^":U=H.slice(0,A=H.length>>1)+te+U+J+H.slice(A);break;default:U=H+te+U+J;break}return i(U)}return z.toString=function(){return f+""},z}function u(f,m){var p=d((f=$a(f),f.type="f",f)),v=Math.max(-8,Math.min(8,Math.floor(dn(m)/3)))*3,M=Math.pow(10,-v),S=xo[8+v/3];return function(x){return p(M*x)+S}}return{format:d,formatPrefix:u}}var Zn,ki,Di;du({thousands:",",grouping:[3],currency:["$",""]});function du(e){return Zn=cu(e),ki=Zn.format,Di=Zn.formatPrefix,Zn}function uu(e){return Math.max(0,-dn(Math.abs(e)))}function fu(e,t){return Math.max(0,Math.max(-8,Math.min(8,Math.floor(dn(t)/3)))*3-dn(Math.abs(e)))}function mu(e,t){return e=Math.abs(e),t=Math.abs(t)-e,Math.max(0,dn(t)-dn(e))+1}function Ti(e,t){switch(arguments.length){case 0:break;case 1:this.range(e);break;default:this.range(t).domain(e);break}return this}function pu(e){return function(){return e}}function hu(e){return+e}var wo=[0,1];function tn(e){return e}function yr(e,t){return(t-=e=+e)?function(a){return(a-e)/t}:pu(isNaN(t)?NaN:.5)}function gu(e,t){var a;return e>t&&(a=e,e=t,t=a),function(r){return Math.max(e,Math.min(t,r))}}function yu(e,t,a){var r=e[0],o=e[1],i=t[0],l=t[1];return o<r?(r=yr(o,r),i=a(l,i)):(r=yr(r,o),i=a(i,l)),function(s){return i(r(s))}}function bu(e,t,a){var r=Math.min(e.length,t.length)-1,o=new Array(r),i=new Array(r),l=-1;for(e[r]<e[0]&&(e=e.slice().reverse(),t=t.slice().reverse());++l<r;)o[l]=yr(e[l],e[l+1]),i[l]=a(t[l],t[l+1]);return function(s){var c=Ss(e,s,1,r)-1;return i[c](o[c](s))}}function Li(e,t){return t.domain(e.domain()).range(e.range()).interpolate(e.interpolate()).clamp(e.clamp()).unknown(e.unknown())}function vu(){var e=wo,t=wo,a=_r,r,o,i,l=tn,s,c,d;function u(){var m=Math.min(e.length,t.length);return l!==tn&&(l=gu(e[0],e[m-1])),s=m>2?bu:yu,c=d=null,f}function f(m){return m==null||isNaN(m=+m)?i:(c||(c=s(e.map(r),t,a)))(r(l(m)))}return f.invert=function(m){return l(o((d||(d=s(t,e.map(r),Xe)))(m)))},f.domain=function(m){return arguments.length?(e=Array.from(m,hu),u()):e.slice()},f.range=function(m){return arguments.length?(t=Array.from(m),u()):t.slice()},f.rangeRound=function(m){return t=Array.from(m),a=Nc,u()},f.clamp=function(m){return arguments.length?(l=m?!0:tn,u()):l!==tn},f.interpolate=function(m){return arguments.length?(a=m,u()):a},f.unknown=function(m){return arguments.length?(i=m,f):i},function(m,p){return r=m,o=p,u()}}function Ei(){return vu()(tn,tn)}function xu(e,t,a,r){var o=sr(e,t,a),i;switch(r=$a(r??",f"),r.type){case"s":{var l=Math.max(Math.abs(e),Math.abs(t));return r.precision==null&&!isNaN(i=fu(o,l))&&(r.precision=i),Di(r,l)}case"":case"e":case"g":case"p":case"r":{r.precision==null&&!isNaN(i=mu(o,Math.max(Math.abs(e),Math.abs(t))))&&(r.precision=i-(r.type==="e"));break}case"f":case"%":{r.precision==null&&!isNaN(i=uu(o))&&(r.precision=i-(r.type==="%")*2);break}}return ki(r)}function wu(e){var t=e.domain;return e.ticks=function(a){var r=t();return Ds(r[0],r[r.length-1],a??10)},e.tickFormat=function(a,r){var o=t();return xu(o[0],o[o.length-1],a??10,r)},e.nice=function(a){a==null&&(a=10);var r=t(),o=0,i=r.length-1,l=r[o],s=r[i],c,d,u=10;for(s<l&&(d=l,l=s,s=d,d=o,o=i,i=d);u-- >0;){if(d=ir(l,s,a),d===c)return r[o]=l,r[i]=s,t(r);if(d>0)l=Math.floor(l/d)*d,s=Math.ceil(s/d)*d;else if(d<0)l=Math.ceil(l*d)/d,s=Math.floor(s*d)/d;else break;c=d}return e},e}function Ba(){var e=Ei();return e.copy=function(){return Li(e,Ba())},Ti.apply(e,arguments),wu(e)}function Su(e,t){e=e.slice();var a=0,r=e.length-1,o=e[a],i=e[r],l;return i<o&&(l=a,a=r,r=l,l=o,o=i,i=l),e[a]=t.floor(o),e[r]=t.ceil(i),e}const Ga=new Date,Qa=new Date;function Me(e,t,a,r){function o(i){return e(i=arguments.length===0?new Date:new Date(+i)),i}return o.floor=i=>(e(i=new Date(+i)),i),o.ceil=i=>(e(i=new Date(i-1)),t(i,1),e(i),i),o.round=i=>{const l=o(i),s=o.ceil(i);return i-l<s-i?l:s},o.offset=(i,l)=>(t(i=new Date(+i),l==null?1:Math.floor(l)),i),o.range=(i,l,s)=>{const c=[];if(i=o.ceil(i),s=s==null?1:Math.floor(s),!(i<l)||!(s>0))return c;let d;do c.push(d=new Date(+i)),t(i,s),e(i);while(d<i&&i<l);return c},o.filter=i=>Me(l=>{if(l>=l)for(;e(l),!i(l);)l.setTime(l-1)},(l,s)=>{if(l>=l)if(s<0)for(;++s<=0;)for(;t(l,-1),!i(l););else for(;--s>=0;)for(;t(l,1),!i(l););}),a&&(o.count=(i,l)=>(Ga.setTime(+i),Qa.setTime(+l),e(Ga),e(Qa),Math.floor(a(Ga,Qa))),o.every=i=>(i=Math.floor(i),!isFinite(i)||!(i>0)?null:i>1?o.filter(r?l=>r(l)%i===0:l=>o.count(0,l)%i===0):o)),o}const ka=Me(()=>{},(e,t)=>{e.setTime(+e+t)},(e,t)=>t-e);ka.every=e=>(e=Math.floor(e),!isFinite(e)||!(e>0)?null:e>1?Me(t=>{t.setTime(Math.floor(t/e)*e)},(t,a)=>{t.setTime(+t+a*e)},(t,a)=>(a-t)/e):ka);ka.range;const ct=1e3,We=ct*60,dt=We*60,ht=dt*24,Fr=ht*7,So=ht*30,Za=ht*365,nn=Me(e=>{e.setTime(e-e.getMilliseconds())},(e,t)=>{e.setTime(+e+t*ct)},(e,t)=>(t-e)/ct,e=>e.getUTCSeconds());nn.range;const Ur=Me(e=>{e.setTime(e-e.getMilliseconds()-e.getSeconds()*ct)},(e,t)=>{e.setTime(+e+t*We)},(e,t)=>(t-e)/We,e=>e.getMinutes());Ur.range;const Mu=Me(e=>{e.setUTCSeconds(0,0)},(e,t)=>{e.setTime(+e+t*We)},(e,t)=>(t-e)/We,e=>e.getUTCMinutes());Mu.range;const Or=Me(e=>{e.setTime(e-e.getMilliseconds()-e.getSeconds()*ct-e.getMinutes()*We)},(e,t)=>{e.setTime(+e+t*dt)},(e,t)=>(t-e)/dt,e=>e.getHours());Or.range;const $u=Me(e=>{e.setUTCMinutes(0,0,0)},(e,t)=>{e.setTime(+e+t*dt)},(e,t)=>(t-e)/dt,e=>e.getUTCHours());$u.range;const zn=Me(e=>e.setHours(0,0,0,0),(e,t)=>e.setDate(e.getDate()+t),(e,t)=>(t-e-(t.getTimezoneOffset()-e.getTimezoneOffset())*We)/ht,e=>e.getDate()-1);zn.range;const qr=Me(e=>{e.setUTCHours(0,0,0,0)},(e,t)=>{e.setUTCDate(e.getUTCDate()+t)},(e,t)=>(t-e)/ht,e=>e.getUTCDate()-1);qr.range;const ku=Me(e=>{e.setUTCHours(0,0,0,0)},(e,t)=>{e.setUTCDate(e.getUTCDate()+t)},(e,t)=>(t-e)/ht,e=>Math.floor(e/ht));ku.range;function Kt(e){return Me(t=>{t.setDate(t.getDate()-(t.getDay()+7-e)%7),t.setHours(0,0,0,0)},(t,a)=>{t.setDate(t.getDate()+a*7)},(t,a)=>(a-t-(a.getTimezoneOffset()-t.getTimezoneOffset())*We)/Fr)}const Va=Kt(0),Da=Kt(1),Du=Kt(2),Tu=Kt(3),un=Kt(4),Lu=Kt(5),Eu=Kt(6);Va.range;Da.range;Du.range;Tu.range;un.range;Lu.range;Eu.range;function Gt(e){return Me(t=>{t.setUTCDate(t.getUTCDate()-(t.getUTCDay()+7-e)%7),t.setUTCHours(0,0,0,0)},(t,a)=>{t.setUTCDate(t.getUTCDate()+a*7)},(t,a)=>(a-t)/Fr)}const Ri=Gt(0),Ta=Gt(1),Ru=Gt(2),Pu=Gt(3),fn=Gt(4),Cu=Gt(5),Iu=Gt(6);Ri.range;Ta.range;Ru.range;Pu.range;fn.range;Cu.range;Iu.range;const zr=Me(e=>{e.setDate(1),e.setHours(0,0,0,0)},(e,t)=>{e.setMonth(e.getMonth()+t)},(e,t)=>t.getMonth()-e.getMonth()+(t.getFullYear()-e.getFullYear())*12,e=>e.getMonth());zr.range;const _u=Me(e=>{e.setUTCDate(1),e.setUTCHours(0,0,0,0)},(e,t)=>{e.setUTCMonth(e.getUTCMonth()+t)},(e,t)=>t.getUTCMonth()-e.getUTCMonth()+(t.getUTCFullYear()-e.getUTCFullYear())*12,e=>e.getUTCMonth());_u.range;const gt=Me(e=>{e.setMonth(0,1),e.setHours(0,0,0,0)},(e,t)=>{e.setFullYear(e.getFullYear()+t)},(e,t)=>t.getFullYear()-e.getFullYear(),e=>e.getFullYear());gt.every=e=>!isFinite(e=Math.floor(e))||!(e>0)?null:Me(t=>{t.setFullYear(Math.floor(t.getFullYear()/e)*e),t.setMonth(0,1),t.setHours(0,0,0,0)},(t,a)=>{t.setFullYear(t.getFullYear()+a*e)});gt.range;const Xt=Me(e=>{e.setUTCMonth(0,1),e.setUTCHours(0,0,0,0)},(e,t)=>{e.setUTCFullYear(e.getUTCFullYear()+t)},(e,t)=>t.getUTCFullYear()-e.getUTCFullYear(),e=>e.getUTCFullYear());Xt.every=e=>!isFinite(e=Math.floor(e))||!(e>0)?null:Me(t=>{t.setUTCFullYear(Math.floor(t.getUTCFullYear()/e)*e),t.setUTCMonth(0,1),t.setUTCHours(0,0,0,0)},(t,a)=>{t.setUTCFullYear(t.getUTCFullYear()+a*e)});Xt.range;function Au(e,t,a,r,o,i){const l=[[nn,1,ct],[nn,5,5*ct],[nn,15,15*ct],[nn,30,30*ct],[i,1,We],[i,5,5*We],[i,15,15*We],[i,30,30*We],[o,1,dt],[o,3,3*dt],[o,6,6*dt],[o,12,12*dt],[r,1,ht],[r,2,2*ht],[a,1,Fr],[t,1,So],[t,3,3*So],[e,1,Za]];function s(d,u,f){const m=u<d;m&&([d,u]=[u,d]);const p=f&&typeof f.range=="function"?f:c(d,u,f),v=p?p.range(d,+u+1):[];return m?v.reverse():v}function c(d,u,f){const m=Math.abs(u-d)/f,p=Lr(([,,S])=>S).right(l,m);if(p===l.length)return e.every(sr(d/Za,u/Za,f));if(p===0)return ka.every(Math.max(sr(d,u,f),1));const[v,M]=l[m/l[p-1][2]<l[p][2]/m?p-1:p];return v.every(M)}return[s,c]}const[Nu,Bu]=Au(gt,zr,Va,zn,Or,Ur);function Ja(e){if(0<=e.y&&e.y<100){var t=new Date(-1,e.m,e.d,e.H,e.M,e.S,e.L);return t.setFullYear(e.y),t}return new Date(e.y,e.m,e.d,e.H,e.M,e.S,e.L)}function er(e){if(0<=e.y&&e.y<100){var t=new Date(Date.UTC(-1,e.m,e.d,e.H,e.M,e.S,e.L));return t.setUTCFullYear(e.y),t}return new Date(Date.UTC(e.y,e.m,e.d,e.H,e.M,e.S,e.L))}function bn(e,t,a){return{y:e,m:t,d:a,H:0,M:0,S:0,L:0}}function Vu(e){var t=e.dateTime,a=e.date,r=e.time,o=e.periods,i=e.days,l=e.shortDays,s=e.months,c=e.shortMonths,d=vn(o),u=xn(o),f=vn(i),m=xn(i),p=vn(l),v=xn(l),M=vn(s),S=xn(s),x=vn(c),b=xn(c),T={a:X,A,b:H,B:G,c:null,d:Lo,e:Lo,f:lf,g:bf,G:xf,H:rf,I:of,j:sf,L:Pi,m:cf,M:df,p:h,q:y,Q:Po,s:Co,S:uf,u:ff,U:mf,V:pf,w:hf,W:gf,x:null,X:null,y:yf,Y:vf,Z:wf,"%":Ro},P={a:$,A:N,b:F,B,c:null,d:Eo,e:Eo,f:kf,g:Af,G:Bf,H:Sf,I:Mf,j:$f,L:Ii,m:Df,M:Tf,p:C,q:V,Q:Po,s:Co,S:Lf,u:Ef,U:Rf,V:Pf,w:Cf,W:If,x:null,X:null,y:_f,Y:Nf,Z:Vf,"%":Ro},R={a:z,A:U,b:te,B:J,c:w,d:Do,e:Do,f:ef,g:ko,G:$o,H:To,I:To,j:Gu,L:Ju,m:Ku,M:Qu,p:K,q:ju,Q:nf,s:af,S:Zu,u:zu,U:Hu,V:Wu,w:qu,W:Yu,x:q,X:I,y:ko,Y:$o,Z:Xu,"%":tf};T.x=k(a,T),T.X=k(r,T),T.c=k(t,T),P.x=k(a,P),P.X=k(r,P),P.c=k(t,P);function k(E,O){return function(j){var L=[],Q=-1,Z=0,se=E.length,ee,re,ge;for(j instanceof Date||(j=new Date(+j));++Q<se;)E.charCodeAt(Q)===37&&(L.push(E.slice(Z,Q)),(re=Mo[ee=E.charAt(++Q)])!=null?ee=E.charAt(++Q):re=ee==="e"?" ":"0",(ge=O[ee])&&(ee=ge(j,re)),L.push(ee),Z=Q+1);return L.push(E.slice(Z,Q)),L.join("")}}function _(E,O){return function(j){var L=bn(1900,void 0,1),Q=Y(L,E,j+="",0),Z,se;if(Q!=j.length)return null;if("Q"in L)return new Date(L.Q);if("s"in L)return new Date(L.s*1e3+("L"in L?L.L:0));if(O&&!("Z"in L)&&(L.Z=0),"p"in L&&(L.H=L.H%12+L.p*12),L.m===void 0&&(L.m="q"in L?L.q:0),"V"in L){if(L.V<1||L.V>53)return null;"w"in L||(L.w=1),"Z"in L?(Z=er(bn(L.y,0,1)),se=Z.getUTCDay(),Z=se>4||se===0?Ta.ceil(Z):Ta(Z),Z=qr.offset(Z,(L.V-1)*7),L.y=Z.getUTCFullYear(),L.m=Z.getUTCMonth(),L.d=Z.getUTCDate()+(L.w+6)%7):(Z=Ja(bn(L.y,0,1)),se=Z.getDay(),Z=se>4||se===0?Da.ceil(Z):Da(Z),Z=zn.offset(Z,(L.V-1)*7),L.y=Z.getFullYear(),L.m=Z.getMonth(),L.d=Z.getDate()+(L.w+6)%7)}else("W"in L||"U"in L)&&("w"in L||(L.w="u"in L?L.u%7:"W"in L?1:0),se="Z"in L?er(bn(L.y,0,1)).getUTCDay():Ja(bn(L.y,0,1)).getDay(),L.m=0,L.d="W"in L?(L.w+6)%7+L.W*7-(se+5)%7:L.w+L.U*7-(se+6)%7);return"Z"in L?(L.H+=L.Z/100|0,L.M+=L.Z%100,er(L)):Ja(L)}}function Y(E,O,j,L){for(var Q=0,Z=O.length,se=j.length,ee,re;Q<Z;){if(L>=se)return-1;if(ee=O.charCodeAt(Q++),ee===37){if(ee=O.charAt(Q++),re=R[ee in Mo?O.charAt(Q++):ee],!re||(L=re(E,j,L))<0)return-1}else if(ee!=j.charCodeAt(L++))return-1}return L}function K(E,O,j){var L=d.exec(O.slice(j));return L?(E.p=u.get(L[0].toLowerCase()),j+L[0].length):-1}function z(E,O,j){var L=p.exec(O.slice(j));return L?(E.w=v.get(L[0].toLowerCase()),j+L[0].length):-1}function U(E,O,j){var L=f.exec(O.slice(j));return L?(E.w=m.get(L[0].toLowerCase()),j+L[0].length):-1}function te(E,O,j){var L=x.exec(O.slice(j));return L?(E.m=b.get(L[0].toLowerCase()),j+L[0].length):-1}function J(E,O,j){var L=M.exec(O.slice(j));return L?(E.m=S.get(L[0].toLowerCase()),j+L[0].length):-1}function w(E,O,j){return Y(E,t,O,j)}function q(E,O,j){return Y(E,a,O,j)}function I(E,O,j){return Y(E,r,O,j)}function X(E){return l[E.getDay()]}function A(E){return i[E.getDay()]}function H(E){return c[E.getMonth()]}function G(E){return s[E.getMonth()]}function h(E){return o[+(E.getHours()>=12)]}function y(E){return 1+~~(E.getMonth()/3)}function $(E){return l[E.getUTCDay()]}function N(E){return i[E.getUTCDay()]}function F(E){return c[E.getUTCMonth()]}function B(E){return s[E.getUTCMonth()]}function C(E){return o[+(E.getUTCHours()>=12)]}function V(E){return 1+~~(E.getUTCMonth()/3)}return{format:function(E){var O=k(E+="",T);return O.toString=function(){return E},O},parse:function(E){var O=_(E+="",!1);return O.toString=function(){return E},O},utcFormat:function(E){var O=k(E+="",P);return O.toString=function(){return E},O},utcParse:function(E){var O=_(E+="",!0);return O.toString=function(){return E},O}}}var Mo={"-":"",_:" ",0:"0"},Te=/^\s*\d+/,Fu=/^%/,Uu=/[\\^$*+?|[\]().{}]/g;function le(e,t,a){var r=e<0?"-":"",o=(r?-e:e)+"",i=o.length;return r+(i<a?new Array(a-i+1).join(t)+o:o)}function Ou(e){return e.replace(Uu,"\\$&")}function vn(e){return new RegExp("^(?:"+e.map(Ou).join("|")+")","i")}function xn(e){return new Map(e.map((t,a)=>[t.toLowerCase(),a]))}function qu(e,t,a){var r=Te.exec(t.slice(a,a+1));return r?(e.w=+r[0],a+r[0].length):-1}function zu(e,t,a){var r=Te.exec(t.slice(a,a+1));return r?(e.u=+r[0],a+r[0].length):-1}function Hu(e,t,a){var r=Te.exec(t.slice(a,a+2));return r?(e.U=+r[0],a+r[0].length):-1}function Wu(e,t,a){var r=Te.exec(t.slice(a,a+2));return r?(e.V=+r[0],a+r[0].length):-1}function Yu(e,t,a){var r=Te.exec(t.slice(a,a+2));return r?(e.W=+r[0],a+r[0].length):-1}function $o(e,t,a){var r=Te.exec(t.slice(a,a+4));return r?(e.y=+r[0],a+r[0].length):-1}function ko(e,t,a){var r=Te.exec(t.slice(a,a+2));return r?(e.y=+r[0]+(+r[0]>68?1900:2e3),a+r[0].length):-1}function Xu(e,t,a){var r=/^(Z)|([+-]\d\d)(?::?(\d\d))?/.exec(t.slice(a,a+6));return r?(e.Z=r[1]?0:-(r[2]+(r[3]||"00")),a+r[0].length):-1}function ju(e,t,a){var r=Te.exec(t.slice(a,a+1));return r?(e.q=r[0]*3-3,a+r[0].length):-1}function Ku(e,t,a){var r=Te.exec(t.slice(a,a+2));return r?(e.m=r[0]-1,a+r[0].length):-1}function Do(e,t,a){var r=Te.exec(t.slice(a,a+2));return r?(e.d=+r[0],a+r[0].length):-1}function Gu(e,t,a){var r=Te.exec(t.slice(a,a+3));return r?(e.m=0,e.d=+r[0],a+r[0].length):-1}function To(e,t,a){var r=Te.exec(t.slice(a,a+2));return r?(e.H=+r[0],a+r[0].length):-1}function Qu(e,t,a){var r=Te.exec(t.slice(a,a+2));return r?(e.M=+r[0],a+r[0].length):-1}function Zu(e,t,a){var r=Te.exec(t.slice(a,a+2));return r?(e.S=+r[0],a+r[0].length):-1}function Ju(e,t,a){var r=Te.exec(t.slice(a,a+3));return r?(e.L=+r[0],a+r[0].length):-1}function ef(e,t,a){var r=Te.exec(t.slice(a,a+6));return r?(e.L=Math.floor(r[0]/1e3),a+r[0].length):-1}function tf(e,t,a){var r=Fu.exec(t.slice(a,a+1));return r?a+r[0].length:-1}function nf(e,t,a){var r=Te.exec(t.slice(a));return r?(e.Q=+r[0],a+r[0].length):-1}function af(e,t,a){var r=Te.exec(t.slice(a));return r?(e.s=+r[0],a+r[0].length):-1}function Lo(e,t){return le(e.getDate(),t,2)}function rf(e,t){return le(e.getHours(),t,2)}function of(e,t){return le(e.getHours()%12||12,t,2)}function sf(e,t){return le(1+zn.count(gt(e),e),t,3)}function Pi(e,t){return le(e.getMilliseconds(),t,3)}function lf(e,t){return Pi(e,t)+"000"}function cf(e,t){return le(e.getMonth()+1,t,2)}function df(e,t){return le(e.getMinutes(),t,2)}function uf(e,t){return le(e.getSeconds(),t,2)}function ff(e){var t=e.getDay();return t===0?7:t}function mf(e,t){return le(Va.count(gt(e)-1,e),t,2)}function Ci(e){var t=e.getDay();return t>=4||t===0?un(e):un.ceil(e)}function pf(e,t){return e=Ci(e),le(un.count(gt(e),e)+(gt(e).getDay()===4),t,2)}function hf(e){return e.getDay()}function gf(e,t){return le(Da.count(gt(e)-1,e),t,2)}function yf(e,t){return le(e.getFullYear()%100,t,2)}function bf(e,t){return e=Ci(e),le(e.getFullYear()%100,t,2)}function vf(e,t){return le(e.getFullYear()%1e4,t,4)}function xf(e,t){var a=e.getDay();return e=a>=4||a===0?un(e):un.ceil(e),le(e.getFullYear()%1e4,t,4)}function wf(e){var t=e.getTimezoneOffset();return(t>0?"-":(t*=-1,"+"))+le(t/60|0,"0",2)+le(t%60,"0",2)}function Eo(e,t){return le(e.getUTCDate(),t,2)}function Sf(e,t){return le(e.getUTCHours(),t,2)}function Mf(e,t){return le(e.getUTCHours()%12||12,t,2)}function $f(e,t){return le(1+qr.count(Xt(e),e),t,3)}function Ii(e,t){return le(e.getUTCMilliseconds(),t,3)}function kf(e,t){return Ii(e,t)+"000"}function Df(e,t){return le(e.getUTCMonth()+1,t,2)}function Tf(e,t){return le(e.getUTCMinutes(),t,2)}function Lf(e,t){return le(e.getUTCSeconds(),t,2)}function Ef(e){var t=e.getUTCDay();return t===0?7:t}function Rf(e,t){return le(Ri.count(Xt(e)-1,e),t,2)}function _i(e){var t=e.getUTCDay();return t>=4||t===0?fn(e):fn.ceil(e)}function Pf(e,t){return e=_i(e),le(fn.count(Xt(e),e)+(Xt(e).getUTCDay()===4),t,2)}function Cf(e){return e.getUTCDay()}function If(e,t){return le(Ta.count(Xt(e)-1,e),t,2)}function _f(e,t){return le(e.getUTCFullYear()%100,t,2)}function Af(e,t){return e=_i(e),le(e.getUTCFullYear()%100,t,2)}function Nf(e,t){return le(e.getUTCFullYear()%1e4,t,4)}function Bf(e,t){var a=e.getUTCDay();return e=a>=4||a===0?fn(e):fn.ceil(e),le(e.getUTCFullYear()%1e4,t,4)}function Vf(){return"+0000"}function Ro(){return"%"}function Po(e){return+e}function Co(e){return Math.floor(+e/1e3)}var Qt,Hr;Ff({dateTime:"%x, %X",date:"%-m/%-d/%Y",time:"%-I:%M:%S %p",periods:["AM","PM"],days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],shortDays:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],shortMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]});function Ff(e){return Qt=Vu(e),Hr=Qt.format,Qt.parse,Qt.utcFormat,Qt.utcParse,Qt}function Uf(e){return new Date(e)}function Of(e){return e instanceof Date?+e:+new Date(+e)}function Ai(e,t,a,r,o,i,l,s,c,d){var u=Ei(),f=u.invert,m=u.domain,p=d(".%L"),v=d(":%S"),M=d("%I:%M"),S=d("%I %p"),x=d("%a %d"),b=d("%b %d"),T=d("%B"),P=d("%Y");function R(k){return(c(k)<k?p:s(k)<k?v:l(k)<k?M:i(k)<k?S:r(k)<k?o(k)<k?x:b:a(k)<k?T:P)(k)}return u.invert=function(k){return new Date(f(k))},u.domain=function(k){return arguments.length?m(Array.from(k,Of)):m().map(Uf)},u.ticks=function(k){var _=m();return e(_[0],_[_.length-1],k??10)},u.tickFormat=function(k,_){return _==null?R:d(_)},u.nice=function(k){var _=m();return(!k||typeof k.range!="function")&&(k=t(_[0],_[_.length-1],k??10)),k?m(Su(_,k)):u},u.copy=function(){return Li(u,Ai(e,t,a,r,o,i,l,s,c,d))},u}function qf(){return Ti.apply(Ai(Nu,Bu,gt,zr,Va,zn,Or,Ur,nn,Hr).domain([new Date(2e3,0,1),new Date(2e3,0,2)]),arguments)}const Jn=e=>()=>e;function zf(e,{sourceEvent:t,target:a,transform:r,dispatch:o}){Object.defineProperties(this,{type:{value:e,enumerable:!0,configurable:!0},sourceEvent:{value:t,enumerable:!0,configurable:!0},target:{value:a,enumerable:!0,configurable:!0},transform:{value:r,enumerable:!0,configurable:!0},_:{value:o}})}function ut(e,t,a){this.k=e,this.x=t,this.y=a}ut.prototype={constructor:ut,scale:function(e){return e===1?this:new ut(this.k*e,this.x,this.y)},translate:function(e,t){return e===0&t===0?this:new ut(this.k,this.x+this.k*e,this.y+this.k*t)},apply:function(e){return[e[0]*this.k+this.x,e[1]*this.k+this.y]},applyX:function(e){return e*this.k+this.x},applyY:function(e){return e*this.k+this.y},invert:function(e){return[(e[0]-this.x)/this.k,(e[1]-this.y)/this.k]},invertX:function(e){return(e-this.x)/this.k},invertY:function(e){return(e-this.y)/this.k},rescaleX:function(e){return e.copy().domain(e.range().map(this.invertX,this).map(e.invert,e))},rescaleY:function(e){return e.copy().domain(e.range().map(this.invertY,this).map(e.invert,e))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}};var Fa=new ut(1,0,0);ut.prototype;function tr(e){e.stopImmediatePropagation()}function wn(e){e.preventDefault(),e.stopImmediatePropagation()}function Hf(e){return(!e.ctrlKey||e.type==="wheel")&&!e.button}function Wf(){var e=this;return e instanceof SVGElement?(e=e.ownerSVGElement||e,e.hasAttribute("viewBox")?(e=e.viewBox.baseVal,[[e.x,e.y],[e.x+e.width,e.y+e.height]]):[[0,0],[e.width.baseVal.value,e.height.baseVal.value]]):[[0,0],[e.clientWidth,e.clientHeight]]}function Io(){return this.__zoom||Fa}function Yf(e){return-e.deltaY*(e.deltaMode===1?.05:e.deltaMode?1:.002)*(e.ctrlKey?10:1)}function Xf(){return navigator.maxTouchPoints||"ontouchstart"in this}function jf(e,t,a){var r=e.invertX(t[0][0])-a[0][0],o=e.invertX(t[1][0])-a[1][0],i=e.invertY(t[0][1])-a[0][1],l=e.invertY(t[1][1])-a[1][1];return e.translate(o>r?(r+o)/2:Math.min(0,r)||Math.max(0,o),l>i?(i+l)/2:Math.min(0,i)||Math.max(0,l))}function Kf(){var e=Hf,t=Wf,a=jf,r=Yf,o=Xf,i=[0,1/0],l=[[-1/0,-1/0],[1/0,1/0]],s=250,c=Hc,d=Er("start","zoom","end"),u,f,m,p=500,v=150,M=0,S=10;function x(w){w.property("__zoom",Io).on("wheel.zoom",Y,{passive:!1}).on("mousedown.zoom",K).on("dblclick.zoom",z).filter(o).on("touchstart.zoom",U).on("touchmove.zoom",te).on("touchend.zoom touchcancel.zoom",J).style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}x.transform=function(w,q,I,X){var A=w.selection?w.selection():w;A.property("__zoom",Io),w!==A?R(w,q,I,X):A.interrupt().each(function(){k(this,arguments).event(X).start().zoom(null,typeof q=="function"?q.apply(this,arguments):q).end()})},x.scaleBy=function(w,q,I,X){x.scaleTo(w,function(){var A=this.__zoom.k,H=typeof q=="function"?q.apply(this,arguments):q;return A*H},I,X)},x.scaleTo=function(w,q,I,X){x.transform(w,function(){var A=t.apply(this,arguments),H=this.__zoom,G=I==null?P(A):typeof I=="function"?I.apply(this,arguments):I,h=H.invert(G),y=typeof q=="function"?q.apply(this,arguments):q;return a(T(b(H,y),G,h),A,l)},I,X)},x.translateBy=function(w,q,I,X){x.transform(w,function(){return a(this.__zoom.translate(typeof q=="function"?q.apply(this,arguments):q,typeof I=="function"?I.apply(this,arguments):I),t.apply(this,arguments),l)},null,X)},x.translateTo=function(w,q,I,X,A){x.transform(w,function(){var H=t.apply(this,arguments),G=this.__zoom,h=X==null?P(H):typeof X=="function"?X.apply(this,arguments):X;return a(Fa.translate(h[0],h[1]).scale(G.k).translate(typeof q=="function"?-q.apply(this,arguments):-q,typeof I=="function"?-I.apply(this,arguments):-I),H,l)},X,A)};function b(w,q){return q=Math.max(i[0],Math.min(i[1],q)),q===w.k?w:new ut(q,w.x,w.y)}function T(w,q,I){var X=q[0]-I[0]*w.k,A=q[1]-I[1]*w.k;return X===w.x&&A===w.y?w:new ut(w.k,X,A)}function P(w){return[(+w[0][0]+ +w[1][0])/2,(+w[0][1]+ +w[1][1])/2]}function R(w,q,I,X){w.on("start.zoom",function(){k(this,arguments).event(X).start()}).on("interrupt.zoom end.zoom",function(){k(this,arguments).event(X).end()}).tween("zoom",function(){var A=this,H=arguments,G=k(A,H).event(X),h=t.apply(A,H),y=I==null?P(h):typeof I=="function"?I.apply(A,H):I,$=Math.max(h[1][0]-h[0][0],h[1][1]-h[0][1]),N=A.__zoom,F=typeof q=="function"?q.apply(A,H):q,B=c(N.invert(y).concat($/N.k),F.invert(y).concat($/F.k));return function(C){if(C===1)C=F;else{var V=B(C),E=$/V[2];C=new ut(E,y[0]-V[0]*E,y[1]-V[1]*E)}G.zoom(null,C)}})}function k(w,q,I){return!I&&w.__zooming||new _(w,q)}function _(w,q){this.that=w,this.args=q,this.active=0,this.sourceEvent=null,this.extent=t.apply(w,q),this.taps=0}_.prototype={event:function(w){return w&&(this.sourceEvent=w),this},start:function(){return++this.active===1&&(this.that.__zooming=this,this.emit("start")),this},zoom:function(w,q){return this.mouse&&w!=="mouse"&&(this.mouse[1]=q.invert(this.mouse[0])),this.touch0&&w!=="touch"&&(this.touch0[1]=q.invert(this.touch0[0])),this.touch1&&w!=="touch"&&(this.touch1[1]=q.invert(this.touch1[0])),this.that.__zoom=q,this.emit("zoom"),this},end:function(){return--this.active===0&&(delete this.that.__zooming,this.emit("end")),this},emit:function(w){var q=lt(this.that).datum();d.call(w,this.that,new zf(w,{sourceEvent:this.sourceEvent,target:x,transform:this.that.__zoom,dispatch:d}),q)}};function Y(w,...q){if(!e.apply(this,arguments))return;var I=k(this,q).event(w),X=this.__zoom,A=Math.max(i[0],Math.min(i[1],X.k*Math.pow(2,r.apply(this,arguments)))),H=xt(w);if(I.wheel)(I.mouse[0][0]!==H[0]||I.mouse[0][1]!==H[1])&&(I.mouse[1]=X.invert(I.mouse[0]=H)),clearTimeout(I.wheel);else{if(X.k===A)return;I.mouse=[H,X.invert(H)],la(this),I.start()}wn(w),I.wheel=setTimeout(G,v),I.zoom("mouse",a(T(b(X,A),I.mouse[0],I.mouse[1]),I.extent,l));function G(){I.wheel=null,I.end()}}function K(w,...q){if(m||!e.apply(this,arguments))return;var I=w.currentTarget,X=k(this,q,!0).event(w),A=lt(w.view).on("mousemove.zoom",y,!0).on("mouseup.zoom",$,!0),H=xt(w,I),G=w.clientX,h=w.clientY;fc(w.view),tr(w),X.mouse=[H,this.__zoom.invert(H)],la(this),X.start();function y(N){if(wn(N),!X.moved){var F=N.clientX-G,B=N.clientY-h;X.moved=F*F+B*B>M}X.event(N).zoom("mouse",a(T(X.that.__zoom,X.mouse[0]=xt(N,I),X.mouse[1]),X.extent,l))}function $(N){A.on("mousemove.zoom mouseup.zoom",null),mc(N.view,X.moved),wn(N),X.event(N).end()}}function z(w,...q){if(e.apply(this,arguments)){var I=this.__zoom,X=xt(w.changedTouches?w.changedTouches[0]:w,this),A=I.invert(X),H=I.k*(w.shiftKey?.5:2),G=a(T(b(I,H),X,A),t.apply(this,q),l);wn(w),s>0?lt(this).transition().duration(s).call(R,G,X,w):lt(this).call(x.transform,G,X,w)}}function U(w,...q){if(e.apply(this,arguments)){var I=w.touches,X=I.length,A=k(this,q,w.changedTouches.length===X).event(w),H,G,h,y;for(tr(w),G=0;G<X;++G)h=I[G],y=xt(h,this),y=[y,this.__zoom.invert(y),h.identifier],A.touch0?!A.touch1&&A.touch0[2]!==y[2]&&(A.touch1=y,A.taps=0):(A.touch0=y,H=!0,A.taps=1+!!u);u&&(u=clearTimeout(u)),H&&(A.taps<2&&(f=y[0],u=setTimeout(function(){u=null},p)),la(this),A.start())}}function te(w,...q){if(this.__zooming){var I=k(this,q).event(w),X=w.changedTouches,A=X.length,H,G,h,y;for(wn(w),H=0;H<A;++H)G=X[H],h=xt(G,this),I.touch0&&I.touch0[2]===G.identifier?I.touch0[0]=h:I.touch1&&I.touch1[2]===G.identifier&&(I.touch1[0]=h);if(G=I.that.__zoom,I.touch1){var $=I.touch0[0],N=I.touch0[1],F=I.touch1[0],B=I.touch1[1],C=(C=F[0]-$[0])*C+(C=F[1]-$[1])*C,V=(V=B[0]-N[0])*V+(V=B[1]-N[1])*V;G=b(G,Math.sqrt(C/V)),h=[($[0]+F[0])/2,($[1]+F[1])/2],y=[(N[0]+B[0])/2,(N[1]+B[1])/2]}else if(I.touch0)h=I.touch0[0],y=I.touch0[1];else return;I.zoom("touch",a(T(G,h,y),I.extent,l))}}function J(w,...q){if(this.__zooming){var I=k(this,q).event(w),X=w.changedTouches,A=X.length,H,G;for(tr(w),m&&clearTimeout(m),m=setTimeout(function(){m=null},p),H=0;H<A;++H)G=X[H],I.touch0&&I.touch0[2]===G.identifier?delete I.touch0:I.touch1&&I.touch1[2]===G.identifier&&delete I.touch1;if(I.touch1&&!I.touch0&&(I.touch0=I.touch1,delete I.touch1),I.touch0)I.touch0[1]=this.__zoom.invert(I.touch0[0]);else if(I.end(),I.taps===2&&(G=xt(G,this),Math.hypot(f[0]-G[0],f[1]-G[1])<S)){var h=lt(this).on("dblclick.zoom");h&&h.apply(this,arguments)}}}return x.wheelDelta=function(w){return arguments.length?(r=typeof w=="function"?w:Jn(+w),x):r},x.filter=function(w){return arguments.length?(e=typeof w=="function"?w:Jn(!!w),x):e},x.touchable=function(w){return arguments.length?(o=typeof w=="function"?w:Jn(!!w),x):o},x.extent=function(w){return arguments.length?(t=typeof w=="function"?w:Jn([[+w[0][0],+w[0][1]],[+w[1][0],+w[1][1]]]),x):t},x.scaleExtent=function(w){return arguments.length?(i[0]=+w[0],i[1]=+w[1],x):[i[0],i[1]]},x.translateExtent=function(w){return arguments.length?(l[0][0]=+w[0][0],l[1][0]=+w[1][0],l[0][1]=+w[0][1],l[1][1]=+w[1][1],x):[[l[0][0],l[0][1]],[l[1][0],l[1][1]]]},x.constrain=function(w){return arguments.length?(a=w,x):a},x.duration=function(w){return arguments.length?(s=+w,x):s},x.interpolate=function(w){return arguments.length?(c=w,x):c},x.on=function(){var w=d.on.apply(d,arguments);return w===d?x:w},x.clickDistance=function(w){return arguments.length?(M=(w=+w)*w,x):Math.sqrt(M)},x.tapDistance=function(w){return arguments.length?(S=+w,x):S},x}async function Gf(e){const t="http://localhost:8000";try{const a=await fetch(`${t}/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!a.ok){const o=await a.text();throw new Error(`Chat API error (${a.status}): ${o}`)}return await a.json()}catch(a){return console.error("Chat API error:",a),{message:`Fehler bei der Kommunikation mit dem Chat-Service: ${a instanceof Error?a.message:"Unbekannter Fehler"}`,success:!1,error:a instanceof Error?a.message:"Unknown error"}}}function Qf(e){const t={mode:e.mode,canvasView:e.canvasView,selectedVariable:e.variable,selectedModel:e.model,selectedScenario:e.scenario,selectedDate:e.date,selectedUnit:e.selectedUnit};return e.dataMin!==null&&e.dataMax!==null&&e.dataMean!==null&&(t.dataStats={min:e.dataMin,max:e.dataMax,mean:e.dataMean}),e.chartPoint&&(t.selectedLocation={lat:e.chartPoint.lat,lon:e.chartPoint.lon}),e.mode==="Compare"&&e.compareMode&&(t.compareMode=e.compareMode,e.compareMode==="Scenarios"?(t.scenario1=e.compareScenarioA,t.scenario2=e.compareScenarioB):e.compareMode==="Models"?(t.model1=e.compareModelA,t.model2=e.compareModelB):e.compareMode==="Dates"&&(t.date1=e.compareDateStart,t.date2=e.compareDateEnd)),e.canvasView==="chart"&&e.chartMode&&(t.chartMode=e.chartMode,t.chartState={mode:e.chartMode,scenarios:e.chartScenarios,models:e.chartModels,date:e.chartDate,rangeStart:e.chartRangeStart,rangeEnd:e.chartRangeEnd,unit:e.chartUnit,variable:e.chartVariable,samples:e.chartSamples.length,location:e.chartLocation,locationName:e.chartLocationName||void 0}),e.mode==="Ensemble"&&(t.ensembleScenarios=e.ensembleScenarios,t.ensembleModels=e.ensembleModels,t.ensembleStatistic=e.ensembleStatistic,t.ensembleDate=e.ensembleDate,t.ensembleVariable=e.ensembleVariable,t.ensembleUnit=e.ensembleUnit,t.ensembleStatistics=e.ensembleStatistics),e.masks&&e.masks.length>0&&(t.masks=e.masks.map(a=>({id:a.id,variable:a.variable,unit:a.unit,statistic:a.statistic,lowerBound:a.lowerBound,upperBound:a.upperBound}))),t}let br=null;function Zf(e){br=e}function Jf(e){if(!e||!br)return;const t={};e.mode&&(t.mode=e.mode),e.mode==="Explore"&&(e.selectedDate&&(t.date=e.selectedDate),e.selectedModel?t.model=e.selectedModel:e.model&&(t.model=e.model),e.selectedScenario&&(t.scenario=Ke(e.selectedScenario)),e.variable&&(t.variable=e.variable)),e.palette&&(t.palette=e.palette),e.mode==="Compare"&&(e.selectedDate&&(t.date=e.selectedDate),e.compareMode&&(t.compareMode=e.compareMode),e.scenario1&&(t.compareScenarioA=Ke(e.scenario1)),e.scenario2&&(t.compareScenarioB=Ke(e.scenario2)),e.model1&&(t.compareModelA=e.model1),e.model2&&(t.compareModelB=e.model2),e.date1&&(t.compareDateStart=e.date1),e.date2&&(t.compareDateEnd=e.date2)),e.chartMode&&(t.chartMode=e.chartMode),e.chartDate&&(t.chartDate=e.chartDate),e.location&&(t.chartLocation=e.location),e.start_date&&(t.chartRangeStart=e.start_date),e.end_date&&(t.chartRangeEnd=e.end_date),e.models&&(t.chartModels=e.models),e.scenarios&&(t.chartScenarios=e.scenarios),e.colorPalette&&(t.palette=Om(e.colorPalette)),e.selectedUnit&&(t.selectedUnit=e.selectedUnit),e.masks&&(t.masks=e.masks.map(a=>({id:a.id,variable:a.variable,unit:a.unit,lowerBound:a.lowerBound??null,upperBound:a.upperBound??null,lowerEdited:a.lowerBound!=null,upperEdited:a.upperBound!=null,statistic:a.statistic}))),e.mode==="Ensemble"&&(e.selectedScenarios&&(t.ensembleScenarios=e.selectedScenarios.map(Ke)),e.selectedModels&&(t.ensembleModels=e.selectedModels),e.selectedDate&&(t.ensembleDate=e.selectedDate),e.selectedUnit&&(t.ensembleUnit=e.selectedUnit),e.variable&&(t.ensembleVariable=e.variable)),e.canvasView&&(t.canvasView=e.canvasView.toLowerCase()),Object.keys(t).length>0&&(console.log("Applying state updates from backend:",t),br(t))}function em(e){let t=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");t=t.replace(/```(.+?)```/gs,'<code style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-family: monospace; display: inline-block; margin: 4px 0; line-height: 1.4;">$1</code>'),t=t.replace(/`(.+?)`/g,'<code style="background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 3px; font-family: monospace; font-size: 0.9em; vertical-align: middle; line-height: 1.4;">$1</code>'),t=t.replace(/\*\*(.+?)\*\*/g,'<strong style="font-weight: 700;">$1</strong>'),t=t.replace(/__(.+?)__/g,'<strong style="font-weight: 700;">$1</strong>');const a=t.split(`
`),r=[];for(let o=0;o<a.length;o++){const i=a[o].trim();if(i.startsWith("- ")){const l=i.substring(2);r.push(`<div style="display: flex; gap: 8px; margin: 6px 0;"><span style="flex-shrink: 0;">•</span><span style="flex: 1; line-height: 1.6; word-break: break-word; overflow-wrap: break-word;">${l}</span></div>`)}else if(/^\d+\.\s/.test(i)){const l=i.match(/^(\d+)\.\s(.+)$/);if(l){const s=l[1],c=l[2];r.push(`<div style="display: flex; gap: 8px; margin: 6px 0;"><span style="flex-shrink: 0; font-weight: 600; line-height: 1.6;">${s}.</span><span style="flex: 1; line-height: 1.6; word-break: break-word; overflow-wrap: break-word;">${c}</span></div>`)}else r.push(i)}else i.length>0?r.push(`<div style="margin: 8px 0; line-height: 1.6;">${i}</div>`):r.push('<div style="height: 12px;"></div>')}return r.join("")}function Ni(e){const t=e.sender==="user"?"chat-bubble chat-bubble-user":"chat-bubble chat-bubble-agent",a=e.sender==="user"?e.text:em(e.text);return`<div class="${t}">${a}</div>`}function nr(e,t){const a=e.querySelector(".chat-messages");if(!a)return;const r=Ni(t);a.insertAdjacentHTML("beforeend",r),a.scrollTop=a.scrollHeight}function ar(e,t,a){a&&(a.chatIsLoading=t);const r=e.querySelector(".chat-loading");if(r&&(r.style.display=t?"flex":"none"),t){const o=e.querySelector(".chat-messages");o&&(o.scrollTop=o.scrollHeight)}}function tm(e,t,a){return`
    <div class="chat-stack">
      <div class="chat-lead">Discuss the data with an agent, or ask questions.</div>

      <div class="chat-messages">
            ${e.map(r=>Ni(r)).join("")}
        </div>
       <div class="chat-bubble chat-bubble-agent chat-loading" style="display: ${a?"flex":"none"}">
            <span class="chat-loading-dot"></span><span class="chat-loading-dot"></span><span class="chat-loading-dot"></span>
        </div>

      <div class="chat-box">
        <input
          type="text"
          value="${t}"
          data-action="chat-input"
          class="chat-input"
          placeholder="Ask a question"
        />
        <button 
          type="button" 
          data-action="chat-send" 
          aria-label="Send chat message" 
          class="chat-send"
        >
          ➤
        </button>
      </div>
    </div>
  `}function nm(e,t){const a=e.querySelector(".chat-messages");a&&!a.dataset.initialScroll&&(a.dataset.initialScroll="true",requestAnimationFrame(()=>{a.scrollTop=a.scrollHeight}));const r=e.querySelector('[data-action="chat-input"]'),o=e.querySelector('[data-action="chat-send"]');r?.addEventListener("input",i=>{t.chatInput=i.target.value}),r?.addEventListener("keydown",i=>{if(i.key==="ArrowUp"&&t.chatMessages.length>0){const l=[...t.chatMessages].reverse().find(s=>s.sender==="user");l&&(t.chatInput=l.text,r&&(r.value=l.text),setTimeout(()=>{r?.setSelectionRange(r.value.length,r.value.length)},0))}i.key==="Enter"&&_o(e,t)}),o?.addEventListener("click",()=>{_o(e,t)})}async function _o(e,t){const a=t.chatInput.trim();if(!a)return;const r={id:Date.now(),sender:"user",text:a};t.chatMessages=[...t.chatMessages,r],t.chatInput="";const o=e.querySelector('[data-action="chat-input"]');o&&(o.value=""),nr(e,r),ar(e,!0,t);const i=t.chatMessages.slice(Math.max(0,t.chatMessages.length-6),-1).map(s=>({role:s.sender==="user"?"user":"assistant",content:s.text})),l=Qf(t);try{const s=await Gf({message:a,context:l,history:i}),c={id:Date.now()+1,sender:"agent",text:s.message,new_state:s.new_state};console.log("New state from agent:",c.new_state),t.chatMessages=[...t.chatMessages,c],c.new_state&&Jf(c.new_state),ar(e,!1,t),nr(e,c)}catch(s){const c={id:Date.now()+1,sender:"agent",text:`Entschuldigung, es gab einen Fehler: ${s instanceof Error?s.message:"Unbekannter Fehler"}`};t.chatMessages=[...t.chatMessages,c],ar(e,!1),nr(e,c)}}const Ee=360;let _t=null,ot=null;function am(e){const{root:t,isOpen:a,onCanvasToggleUpdate:r,onTimeSliderUpdate:o}=e;_t||(_t=t.querySelector('[data-role="sidebar"]')),ot||(ot=t.querySelector('[data-action="toggle-sidebar"]'));const i=t.querySelector('[data-role="canvas-toggle"]'),l=t.querySelector('[data-role="compare-info-trigger"]'),s=t.querySelector('[data-role="compare-info-overlay"]');if(!_t||!i||!ot)return;const c=a?"translateX(0)":`translateX(${Ee+24}px)`;_t.style.transform=c,_t.style.pointerEvents=a?"auto":"none",_t.setAttribute("aria-hidden",String(!a));const d=a?`${Ee+10}px`:"14px";ot.style.right=d,ot.setAttribute("aria-label",a?"Collapse sidebar":"Expand sidebar"),ot.className=a?"sidebar-toggle open":"sidebar-toggle";const u=ot.querySelector("span");u&&(u.textContent=a?"›":"‹");const f=a?Ee+24:24;i.style.right=`${f}px`,l&&(l.style.right=`${f}px`),s&&(s.style.left=a?`${Ee}px`:"0",s.style.right="0"),r&&r(f),o&&o(a)}function rm(e){const{root:t,getSidebarOpen:a,setSidebarOpen:r,onCanvasToggleUpdate:o,onTimeSliderUpdate:i}=e;_t=t.querySelector('[data-role="sidebar"]'),ot=t.querySelector('[data-action="toggle-sidebar"]'),ot?.addEventListener("click",()=>{const l=!a();r(l),am({root:t,isOpen:l,onCanvasToggleUpdate:o,onTimeSliderUpdate:i})})}function om(e){const t=e?Ee+10:14;return`
      <button
        type="button"
        aria-label="${e?"Collapse sidebar":"Expand sidebar"}"
        data-action="toggle-sidebar"
        class="${e?"sidebar-toggle open":"sidebar-toggle"}"
        style="right: ${t}px"
      >
        <span class="sidebar-toggle-icon">${e?"›":"‹"}</span>
      </button>
    `}const be={map:"map",scenario:"scenario",models:"models",date:"date",variable:"variable",unit:"unit",palette:"palette",timeframe:"timeframe",mapReview:"map-review",compareSwitch:"compare-switch",compareParameters:"compare-parameters",chatSwitch:"chat-switch",chatOverview:"chat-overview",analysisSwitch:"analysis-switch",analysisOverview:"analysis-overview"},Pe={map:"#map-canvas",scenario:'[data-role="scenario-selector"]',model:'[data-role="model-selector"]',date:'[data-role="date-picker"]',variable:'[data-role="variable-selector"]',unit:'[data-role="unit-selector"]',palette:'[data-role="palette-selector"]',timeSlider:'[data-role="time-slider"]',compareSwitch:'[data-action="set-mode"][data-value="Compare"]',compareParameters:'[data-role="compare-parameters"]',chatSwitch:'[data-action="set-tab"][data-value="Chat"]',chatSection:'[data-role="chat-section"]',analysisSwitch:'[data-action="set-canvas"][data-value="chart"]',analysisOverview:'[data-role="chart-container"]'},Hn=[{id:be.map,title:"Welcome to Climate Visualization",description:"This interactive map shows climate data across the globe. You can pan by dragging, zoom with your mouse wheel, and hover over any location to see detailed information.",targetSelector:Pe.map,position:"center",requiresAction:{type:"none"}},{id:be.scenario,title:"Climate Scenarios",description:"Choose a climate scenario: Historical (1950-2014) shows past data, while SSP245, SSP370, and SSP585 represent different future warming pathways. Select one to continue.",targetSelector:Pe.scenario,position:"left",requiresAction:{type:"select",dataKey:"scenario"}},{id:be.models,title:"Climate Models",description:"Select from 11 global climate models developed by research institutions worldwide. Each model provides unique projections. Choose a model to continue.",targetSelector:Pe.model,position:"left",requiresAction:{type:"select",dataKey:"model"}},{id:be.date,title:"Date Selection",description:"Pick a date to view climate data. The available range depends on your chosen scenario. Select a date to continue.",targetSelector:Pe.date,position:"left",requiresAction:{type:"input",dataKey:"date"}},{id:be.variable,title:"Climate Variable",description:"Select which climate variable to visualize, such as temperature or precipitation. Choose one to continue.",targetSelector:Pe.variable,position:"left",requiresAction:{type:"select",dataKey:"variable"}},{id:be.unit,title:"Unit Preferences",description:"Choose your preferred temperature unit: Celsius (°C), Fahrenheit (°F), or Kelvin (K). Select a unit to continue.",targetSelector:Pe.unit,position:"left",requiresAction:{type:"select",dataKey:"unit"}},{id:be.palette,title:"Color Palette",description:"Select a color scheme for the map. Different palettes can help visualize temperature variations. Choose a palette to continue.",targetSelector:Pe.palette,position:"left",requiresAction:{type:"select",dataKey:"palette"}},{id:be.timeframe,title:"Time Navigation",description:"Use this slider to quickly navigate through different dates and see how climate patterns change over time.",targetSelector:Pe.timeSlider,position:"top",requiresAction:{type:"none"}},{id:be.mapReview,title:"Review the Map",description:"Great! Your parameters are set. Take a quick look at the map with your chosen settings, then continue.",targetSelector:Pe.map,position:"right",requiresAction:{type:"none"}},{id:be.compareSwitch,title:"Compare Mode",description:"Now switch to Compare mode to explore differences side by side. Click Compare to continue.",targetSelector:Pe.compareSwitch,position:"left",requiresAction:{type:"click"}},{id:be.compareParameters,title:"Compare Parameters",description:"These settings control what you compare and how the differences are calculated. Review the options, then continue.",targetSelector:Pe.compareParameters,position:"left",requiresAction:{type:"none"}},{id:be.chatSwitch,title:"Chat",description:"Open the Chat tab to ask questions about the data and get insights. Click Chat to continue.",targetSelector:Pe.chatSwitch,position:"left",requiresAction:{type:"click"}},{id:be.chatOverview,title:"Chat Overview",description:"Use the chat to explore insights, ask about trends, or get help interpreting results. You can also change the parameters with the chat, e.g. 'Compare optimistic and pessimistic prediction of precipitation for 2050. Change the color for a good representation'.<br><br>When you're ready, continue.",targetSelector:Pe.chatSection,position:"left",requiresAction:{type:"none"}},{id:be.analysisSwitch,title:"Analysis Tools",description:"Switch to the Analysis view to see detailed charts and statistics. Click the Analysis button to continue.",targetSelector:Pe.analysisSwitch,position:"left",requiresAction:{type:"click"}},{id:be.analysisOverview,title:"Analysis Overview",description:"Here you can explore charts, compare scenarios, and analyze trends over time. This is where you dive deeper into the data. The tutorial is complete!",targetSelector:Pe.analysisOverview,position:"center",requiresAction:{type:"none"}}];let Lt={active:!1,currentStep:0,completed:!1};const Wr=new Set;function it(){return Lt}function im(){Lt={active:!0,currentStep:0,completed:!1},Wr.clear()}function Bi(){Lt={active:!1,currentStep:0,completed:!1},Wr.clear(),document.querySelectorAll(".tutorial-target-active").forEach(e=>{e.classList.remove("tutorial-target-active")})}function sm(){Lt.currentStep<Hn.length-1?Lt.currentStep++:Bi()}function Vt(){const e=Hn[Lt.currentStep];e&&Wr.add(e.id),sm()}function lm(){return{current:Lt.currentStep+1,total:Hn.length}}function Ao(e,t,a=!0){if(t===be.map)return null;const r=document.querySelector(e);if(r){if(t===be.mapReview){const s=document.querySelector('[data-role="sidebar"]')?.getBoundingClientRect(),c=s?s.left:window.innerWidth;return new DOMRect(0,0,Math.max(c,0),window.innerHeight)}if(t===be.chatOverview){const s=document.querySelector('[data-role="sidebar"]')?.getBoundingClientRect();if(s)return new DOMRect(s.left,0,s.width,window.innerHeight)}const o=r.getBoundingClientRect(),i=r.querySelector(".custom-select-dropdown");if(a&&i&&r.classList.contains("open")){const l=i.getBoundingClientRect(),s=Math.min(o.top,l.top),c=Math.max(o.bottom,l.bottom),d=Math.min(o.left,l.left),u=Math.max(o.right,l.right);return new DOMRect(d,s,u-d,c-s)}return o}return null}function cm(e,t,a){if(!e)return{top:"50%",left:"50%"};const r=20,o={};switch(t){case"top":o.bottom=`${window.innerHeight-e.top+r}px`,o.left=`${e.left+e.width/2}px`;break;case"bottom":o.top=`${e.bottom+r}px`,o.left=`${e.left+e.width/2}px`;break;case"left":if(o.top=`${e.top+e.height/2}px`,a===be.chatSwitch||a===be.chatOverview){const l=document.querySelector('[data-role="sidebar"]')?.getBoundingClientRect(),s=l?l.left:e.left;o.right=`${window.innerWidth-s+r}px`}else o.right=`${window.innerWidth-e.left+r}px`;break;case"right":o.top=`${e.top+e.height/2}px`,o.left=`${e.right+r}px`;break;default:o.top="50%",o.left="50%";break}return o}function dm(e){if(!e.active)return"";const t=Hn[e.currentStep];if(!t)return"";const a=document.querySelector(t.targetSelector);if(a){document.querySelectorAll(".tutorial-target-active").forEach(m=>{m!==a&&m.classList.remove("tutorial-target-active")}),a.classList.add("tutorial-target-active");const u=a.closest(".custom-select-container");if(u){u.classList.add("tutorial-target-active");const m=u.querySelector(".custom-select-info-panel");m&&m.classList.add("tutorial-target-active")}const f=document.querySelector(".custom-select-info-panel-shared");f&&f.classList.add("tutorial-target-active")}const r=lm(),o=Ao(t.targetSelector,t.id,!0),i=Ao(t.targetSelector,t.id,!1),l=cm(i,t.position,t.id);let s="";t.position==="center"?s="transform: translate(-50%, -50%);":t.position==="top"||t.position==="bottom"?s="transform: translateX(-50%);":(t.position==="left"||t.position==="right")&&(s="transform: translateY(-50%);");const c=Object.entries(l).map(([u,f])=>`${u}: ${f};`).join(" ");let d="";if(o){const f=o.top-5,m=o.left-5,p=o.bottom+5,v=o.right+5;d=`clip-path: polygon(
            0% 0%, 
            0% 100%, 
            ${m}px 100%, 
            ${m}px ${f}px, 
            ${v}px ${f}px, 
            ${v}px ${p}px, 
            ${m}px ${p}px, 
            ${m}px 100%, 
            100% 100%, 
            100% 0%
        );`}return`
        <div class="tutorial-backdrop" style="${d}"></div>
        ${o?`<div class="tutorial-spotlight" style="
                    top: ${o.top}px;
                    left: ${o.left}px;
                    width: ${o.width}px;
                    height: ${o.height}px;
                "></div>`:""}
        <div class="tutorial-box" data-role="tutorial-box" style="${c} ${s}">
            <div class="tutorial-header">
                <div class="tutorial-progress">Step ${r.current} of ${r.total}</div>
                <button class="tutorial-close" data-action="close-tutorial" aria-label="Close tutorial">×</button>
            </div>
            <h3 class="tutorial-title">${t.title}</h3>
            <p class="tutorial-description">${t.description}</p>
            <div class="tutorial-actions">
                        <button class="tutorial-btn tutorial-btn-primary" data-action="tutorial-continue">Continue →</button>
                    </div>
        </div>
    `}function um(){return Lt.completed?"":`
        <button class="tutorial-start-btn" data-action="start-tutorial" aria-label="Start tutorial">
            ?
        </button>
    `}function vr(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:{r:0,g:0,b:0}}const fm=e=>e-273.15,mm=e=>(e-273.15)*(9/5)+32,pm=e=>e*1e3,hm=e=>e*3.6,gm=e=>e*2.237,ym=e=>e/1e3,Zt=e=>e;function Oe(e){switch(e){case"tas":case"tasmin":case"tasmax":return[{label:"Kelvin (K)",unit:"K",convert:Zt},{label:"Celsius (°C)",unit:"°C",convert:fm},{label:"Fahrenheit (°F)",unit:"°F",convert:mm}];case"pr":return[{label:"g m⁻² s⁻¹",unit:"g m⁻² s⁻¹",convert:pm},{label:"kg m⁻² s⁻¹",unit:"kg m⁻² s⁻¹",convert:Zt}];case"rsds":case"rlds":return[{label:"W/m²",unit:"W/m²",convert:Zt},{label:"kW/m²",unit:"kW/m²",convert:ym}];case"sfcWind":return[{label:"m/s",unit:"m/s",convert:Zt},{label:"km/h",unit:"km/h",convert:hm},{label:"mph",unit:"mph",convert:gm}];case"hurs":return[{label:"Percent (%)",unit:"%",convert:Zt}];default:return[{label:"Default",unit:"",convert:Zt}]}}function Ne(e){return Oe(e)[0]}function Ht(e,t,a,r){const i=Oe(t).find(l=>l.label===a);return i?r?.isDifference&&["tas","tasmin","tasmax"].includes(t)?a.includes("Celsius")?e:a.includes("Fahrenheit")?e*(9/5):e:i.convert(e):e}function Vi(e,t){return Oe(e).find(o=>o.label===t)?.unit||""}function Wn(e,t,a,r,o){const l=Oe(a).find(s=>s.label===r);return l?o?.isDifference&&["tas","tasmin","tasmax"].includes(a)?r.startsWith("Celsius")?{min:e,max:t}:r.startsWith("Fahrenheit")?{min:e*1.8,max:t*1.8}:{min:e,max:t}:{min:l.convert(e),max:l.convert(t)}:{min:e,max:t}}let ft=null,Vn=[];function Yr(e,t,a,r){const o=r.map(vr);for(let i=0;i<a;i++){const s=(1-i/(a-1))*(o.length-1),c=Math.floor(s),d=Math.min(c+1,o.length-1),u=s-c,f=o[c],m=o[d],p=Math.round(f.r+(m.r-f.r)*u),v=Math.round(f.g+(m.g-f.g)*u),M=Math.round(f.b+(m.b-f.b)*u);e.fillStyle=`rgb(${p}, ${v}, ${M})`,e.fillRect(0,i,t,1)}}function bm(e,t,a,r,o,i,l=0,s){const c=r?.variable_metadata[e],d=s?.titleOverride||c?.name||e;let u=t,f=a,m=c?.unit||"";if(o&&!s?.skipConversion){const S=Wn(t,a,e,o,{isDifference:i});u=S.min,f=S.max,m=Vi(e,o)}s?.unitOverride!==void 0&&(m=s.unitOverride);const p=(f-u)/4,v=[f,f-p,f-2*p,f-3*p,u];return`
      <div class="map-legend" ${l?`style="transform: translateY(calc(-50% - ${l}px));"`:""}>
        <div class="legend-header">
          <div class="legend-title">${d}</div>
          ${s?.paletteControlHtml?`<div class="legend-palette-control">${s.paletteControlHtml}</div>`:""}
        </div>
        <div class="legend-container">
        <canvas id="legend-gradient-canvas" width="20" height="200" style="width: 20px; height: 200px; border-radius: 4px;"></canvas>
          <div class="legend-labels">
            ${v.map(S=>`<span>${S.toFixed(2)} ${m}</span>`).join("")}
          </div>
        </div>
        ${s?.bottomControlsHtml?`<div class="legend-bottom-controls">${s.bottomControlsHtml}</div>`:""}
      </div>
    `}function Dn(e,t){const a=document.getElementById(e);if(!a){console.warn("Legend canvas not found");return}ft=a,Vn=t;const r=a.getContext("2d");if(!r)return;const o=a.width,i=a.height;Yr(r,o,i,t)}function vm(e,t,a){if(!ft||Vn.length===0)return;const r=ft.getContext("2d");if(!r)return;const o=ft.width,i=ft.height;Yr(r,o,i,Vn);const l=a-t,s=!Number.isFinite(l)||l<=0||!Number.isFinite(e)?.5:Math.min(1,Math.max(0,(e-t)/l)),c=Math.round(i*(1-s));r.strokeStyle="rgba(255, 255, 255, 0.95)",r.lineWidth=2,r.shadowColor="rgba(0, 0, 0, 0.8)",r.shadowBlur=4,r.beginPath(),r.moveTo(0,c),r.lineTo(o,c),r.stroke(),r.shadowBlur=0}function xm(){if(!ft||Vn.length===0)return;const e=ft.getContext("2d");if(!e)return;const t=ft.width,a=ft.height;Yr(e,t,a,Vn)}const Yn="http://localhost:8000";class Fe extends Error{statusCode;details;constructor(t,a,r){super(t),this.name="DataClientError",this.statusCode=a,this.details=r}}function mt(e){return{Historical:"historical",SSP245:"ssp245",SSP585:"ssp585"}[e]||e.toLowerCase()}function wm(e){return e===1?"low":e===2?"medium":"high"}function Sm(e,t,a="float32"){const r=atob(e),o=new Uint8Array(r.length);for(let i=0;i<r.length;i++)o[i]=r.charCodeAt(i);if(a.includes("float32"))return new Float32Array(o.buffer);if(a.includes("float64"))return new Float64Array(o.buffer);throw new Error(`Unsupported dtype: ${a}`)}function Mm(e,t){const a=e.flat(),r=new Float32Array(a.length);for(let o=0;o<a.length;o++)r[o]=a[o];return r}async function Be(e,t){const r=`${Yn}/data`;try{const o=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...e,scenario:e.scenario?mt(e.scenario):void 0,data_format:e.data_format||"base64"})});if(!o.ok){const i=await o.json().catch(()=>({detail:o.statusText}));throw new Fe(i.detail||`HTTP ${o.status}: ${o.statusText}`,o.status,i)}return await o.json()}catch(o){throw o instanceof Fe?o:new Fe(`Failed to fetch data: ${o instanceof Error?o.message:String(o)}`,void 0,o)}}async function Ua(e){const a=`${Yn}/metadata`;try{const r=await fetch(a,{method:"GET",headers:{"Content-Type":"application/json"}});if(!r.ok)throw new Fe(`HTTP ${r.status}: ${r.statusText}`,r.status);return await r.json()}catch(r){throw r instanceof Fe?r:new Fe(`Failed to fetch metadata: ${r instanceof Error?r.message:String(r)}`)}}function _e(e){return e.data?e.data instanceof Float32Array||e.data instanceof Float64Array?e.data:e.data_encoding==="none"?null:e.data_encoding==="base64"&&typeof e.data=="string"?Sm(e.data,e.shape,e.dtype):e.data_encoding==="list"&&Array.isArray(e.data)?Mm(e.data,e.shape):null:null}function we(e){return{variable:e.variable,time:e.date,model:e.model,scenario:e.scenario,resolution:wm(e.resolution),data_format:e.dataFormat||"base64"}}async function Xr(e,t){const r=`${Yn}/pixel-data`;try{const o=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...e,scenario:e.scenario?mt(e.scenario):void 0,resolution:e.resolution||"medium",step_days:e.step_days||1})});if(!o.ok){const i=await o.json().catch(()=>({detail:o.statusText}));throw new Fe(i.detail||`HTTP ${o.status}: ${o.statusText}`,o.status,i)}return await o.json()}catch(o){throw o instanceof Fe?o:new Fe(`Failed to fetch pixel data: ${o instanceof Error?o.message:String(o)}`,void 0,o)}}async function xr(e,t){const r=`${Yn}/aggregate-on-demand`;try{const o=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...e,scenario:e.scenario?mt(e.scenario):void 0,resolution:e.resolution||"medium",step_days:e.step_days||1})});if(!o.ok){const i=await o.json().catch(()=>({detail:o.statusText}));throw new Fe(i.detail||`HTTP ${o.status}: ${o.statusText}`,o.status,i)}return await o.json()}catch(o){throw o instanceof Fe?o:new Fe(`Failed to fetch aggregate data: ${o instanceof Error?o.message:String(o)}`,void 0,o)}}async function $m(e){const a=`${Yn}/health`;try{return(await fetch(a,{method:"GET",signal:AbortSignal.timeout(5e3)})).ok}catch{return!1}}let Sn=null,Fi=0,Ui=1,ca="",da="",Oi=!1,qi=!1;function zi(){return Sn||(Sn=document.createElement("div"),Sn.className="map-tooltip",document.body.appendChild(Sn)),Sn}function km(e,t,a,r,o,i,l){const s=zi();let c=o,d=i;qi?d="%":da&&ca&&(c=Ht(o,ca,da,{isDifference:l??Oi}),d=Vi(ca,da)||i),s.textContent=`Lat: ${a.toFixed(2)}, Lon: ${r.toFixed(2)}, Value: ${c.toFixed(2)} ${d}`,s.style.display="block",s.style.left=`${e+10}px`,s.style.top=`${t+10}px`,vm(c,Fi,Ui)}function Rn(){const e=zi();e.style.display="none",xm()}function Dm(e,t,a,r,o,i){Fi=e,Ui=t,a!==void 0&&(ca=a),r!==void 0&&(da=r),o!==void 0&&(Oi=o),i!==void 0&&(qi=i)}let ie=Fa,Pn=null,xe=null,Hi=null,Wi=!1,La=null,Yi,Xi,Cn=!1,wr=null,Sr=null;function Tm(e){return e==="std"||e==="iqr"||e==="percentile"||e==="extremes"}function Lm(e){const t=e<0?-1:1,a=Math.abs(e),r=1/(1+.3275911*a),u=1-((((1.061405429*r+-1.453152027)*r+1.421413741)*r+-.284496736)*r+.254829592)*r*Math.exp(-a*a);return t*u}function No(e){return .5*(1+Lm(e/Math.SQRT2))}function Em(e,t,a,r,o,i,l,s){let c=0,d=0,u=0;for(const b of e){const T=b[t];if(!Number.isFinite(T))continue;const P=a==="hurs"?Math.min(T,100):T,R=r?Ht(P,a,r):P;if(!Number.isFinite(R))continue;c+=1;const k=R-d;d+=k/c;const _=R-d;u+=k*_}if(c===0)return NaN;const f=l&&o!==null?o:-1/0,m=s&&i!==null?i:1/0;if(f>m)return 0;const p=u/c,v=Math.sqrt(Math.max(0,p));if(!Number.isFinite(v)||v<1e-10)return d>=f&&d<=m?1:0;const M=(f-d)/v,S=(m-d)/v,x=No(S)-No(M);return Math.max(0,Math.min(1,x))}function ji(){return ie.k}function Rm(e){const t=e.getContext("2d");if(!t)return null;const a=e.getBoundingClientRect();return e.width=a.width*window.devicePixelRatio,e.height=a.height*window.devicePixelRatio,t.scale(window.devicePixelRatio,window.devicePixelRatio),{ctx:t,rect:a,viewWidth:a.width,viewHeight:a.height}}function Pm(e,t,a,r){const o=e*a+a/2,i=o>180?o-360:o,l=90-(t*r+r/2);return[i,l]}function Cm(e,t,a,r,o){if(e<0||e>=a||t<0||t>=r)return null;const l=(r-1-t)*a+e,s=o[l];return isFinite(s)?s:null}function rr(e){Cn?e.style.cursor="crosshair":e.style.cursor="auto"}function Bo(e,t,a){if(!xe)return null;const r=e.getBoundingClientRect(),o=t-r.left,i=a-r.top;let l=(o-ie.x)/ie.k;const s=(i-ie.y)/ie.k,c=xe.width,d=xe.height;if(s<0||s>d)return null;let u=l;u=u%c,u<0&&(u+=c),u<0&&(u=0),u>=c&&(u=c*(1-Number.EPSILON));const f=u/c*360-180,m=90-s/d*150,p=Math.max(-180,Math.min(180,f)),v=Math.max(-90,Math.min(90,m));return!Number.isFinite(p)||!Number.isFinite(v)?null:{lat:v,lon:p}}function Im(e,t){Cn=e,wr=e?t??null:null}function ua(e,t,a){if(!xe)return null;const r=xe.width,o=xe.height;let i=t;for(;i>180;)i-=360;for(;i<-180;)i+=360;const l=(i+180)/360*r,s=(90-a)/150*o,c=l*ie.k+ie.x,d=s*ie.k+ie.y,u=e.getBoundingClientRect(),f=r*ie.k,m=u.width/2;let p=c,v=Math.abs(c-m);for(let M=-f;M<=f;M+=f){const S=c+M,x=Math.abs(S-m);x<v&&(v=x,p=S)}return d<-o*ie.k||d>u.height+o*ie.k?null:{x:p,y:d}}function _m(e,t,a,r,o,i){Im(i?.drawMode??!1,{onClick:i?.onDrawClick,onMove:i?.onDrawMove}),Sr=i?.onTransform??null,rr(e);const l=lt(e);Pn=Kf().scaleExtent([.8,10]).filter(s=>Cn?!1:!s.ctrlKey&&!s.button).on("zoom",s=>{ie=s.transform,(xe||t)&&Vo(e),Sr?.()}).on("start",()=>{e.style.cursor="grabbing",Rn()}).on("end",()=>{rr(e)}),l.call(Pn),l.call(Pn.transform,ie),l.on("click.draw",s=>{const c=Bo(e,s.clientX,s.clientY);if(c){if(Cn){wr?.onClick?.(c);return}i?.onMapClick?.(c)}}),l.on("pointermove.tooltip",s=>{if(Cn){const c=Bo(e,s.clientX,s.clientY);c&&wr?.onMove?.(c),Rn();return}if(s.buttons===0&&Hi&&La&&xe){const[c,d]=xt(s,e);Nm(s.clientX,s.clientY,c,d,a,Yi,Xi,Wi)}}),l.on("pointerleave",()=>{Rn()}),rr(e)}function Vo(e){if(!xe)return;const t=e.getContext("2d");if(!t)return;const a=e.getBoundingClientRect();t.clearRect(0,0,a.width,a.height),t.save(),t.translate(ie.x,ie.y),t.scale(ie.k,ie.k),t.imageSmoothingEnabled=!1;const r=xe.width,o=-ie.x/ie.k,i=(a.width-ie.x)/ie.k,l=Math.floor(o/r)-1,s=Math.ceil(i/r)+1;for(let c=l;c<=s;c++)t.drawImage(xe,c*r,0);t.restore()}function Tn(e,t,a,r,o,i,l,s,c,d,u,f,m,p){if(t)try{Am(e,t,a,r,o,i,l,s,c,d,u,f,m,p)}catch(v){console.error("renderMapData failed (e.g. when changing display variable with masks):",v)}}function Am(e,t,a,r,o,i,l,s,c,d,u,f,m,p){const v=_e(e);if(!v){console.warn("No data to render");return}const M=Rm(t);if(!M)return;const{ctx:S,rect:x,viewWidth:b,viewHeight:T}=M,[P,R]=e.shape,k=R*P;S.clearRect(0,0,x.width,x.height),S.save();const _=!!e?.metadata?.comparison||typeof e.model=="string"&&e.model.includes(" minus ");Hi=e,Yi=l,Xi=s,Wi=_;const Y=new Array(T).fill(null).map(()=>new Float32Array(b).fill(NaN));let K=o,z=i;if(l&&s){const ee=Wn(o,i,l,s,{isDifference:_});K=ee.min,z=ee.max}Number.isFinite(K)||(K=0),Number.isFinite(z)||(z=1),z<=K&&(z=K+1);const te=(a.find(ee=>ee.name===r)||a[0]).colors,J=te.length>0?te.map(vr):[vr("#808080")];function w(ee,re){const ge=(ee+180)/360*b,He=(90-re)/150*T;return[ge,He]}const q=document.createElement("canvas");q.width=b,q.height=T;const I=q.getContext("2d");if(!I)return;const X=I.createImageData(b,T),A=X.data,H=Math.max(b/R,T/P),G=Math.ceil(H/2),h=360/R,y=150/P,$=new Map,N=u&&c?c.filter(ee=>ee.kind==="probability"):[],F=c?.filter(ee=>ee.kind!=="probability")??[],B=!!u&&N.length>0,C=B?0:K,V=B?1:z;if(Dm(B?0:K,B?100:z,l,s,_,B),!u&&c&&c.length>0&&f){const ee=new Set;for(const re of c)re.variable&&re.variable!==l&&ee.add(re.variable);ee.forEach(re=>{const ge=f.get(re);if(ge)try{const He=_e(ge);He&&He.length===k&&$.set(re,He)}catch(He){console.warn(`Failed to decode mask data for variable ${re}:`,He)}})}for(let ee=0;ee<P;ee++)for(let re=0;re<R;re++){const ge=Cm(re,ee,R,P,v);if(ge===null)continue;const[He,hn]=Pm(re,ee,h,y),[gn,Qr]=w(He,hn);let Zr=ge;l&&s&&(Zr=Ht(ge,l,s,{isDifference:_}));let Qe=!1;if(F.length>0)if(u&&d){Qe=!0;for(const de of F){const fe=!de.lowerEdited||de.lowerBound===null,me=!de.upperEdited||de.upperBound===null,Le=de.variable||l,Ae=de.unit||s,pe=de.statistic||"mean",bt=((Le?m?.get(Le):void 0)??(Le===l?d:void 0))?.get(pe);if(!bt)continue;const jn=(P-1-ee)*R+re,Rt=bt[jn];if(!isFinite(Rt)){Qe=!1;break}let Pt=Rt;if(Le&&Ae){const bs=Tm(pe);Pt=Ht(Rt,Le,Ae,{isDifference:bs})}if(!fe&&de.lowerBound!==null&&Pt<de.lowerBound){Qe=!1;break}if(!me&&de.upperBound!==null&&Pt>de.upperBound){Qe=!1;break}}}else{const de=new Map;for(const fe of F){const me=fe.variable;me&&(de.has(me)||de.set(me,[]),de.get(me).push(fe))}Qe=!0;for(const[fe,me]of de){let Le=!1,Ae;if(fe===l)Ae=ge;else if($.has(fe)){const pe=$.get(fe),yt=(P-1-ee)*R+re;if(Ae=pe[yt],!isFinite(Ae)){Qe=!1;break}}else{Qe=!1;break}for(const pe of me){const yt=!pe.lowerEdited,bt=!pe.upperEdited,jn=pe.unit;let Rt=Ae;jn&&(Rt=Ht(Ae,fe,jn));let Pt=!0;if(!yt&&pe.lowerBound!==null&&Rt<pe.lowerBound&&(Pt=!1),!bt&&pe.upperBound!==null&&Rt>pe.upperBound&&(Pt=!1),Pt){Le=!0;break}}if(!Le){Qe=!1;break}}}else Qe=!0;let Ye=1;if(B&&N.length>0&&u){const de=(P-1-ee)*R+re;Ye=1;for(const fe of N){const me=fe.variable||l;if(!me){Ye=NaN;break}const Le=p?.get(me);if(!Le||Le.length===0){Ye=NaN;break}const Ae=fe.unit||s,pe=Em(Le,de,me,Ae,fe.lowerBound,fe.upperBound,fe.lowerEdited,fe.upperEdited);if(!Number.isFinite(pe)){Ye=NaN;break}Ye*=pe}Number.isFinite(Ye)?Ye=Math.max(0,Math.min(1,Ye)):Ye=0}let Ha,Wa,Ya;if(!Qe&&F.length>0)Ha=20,Wa=24,Ya=32;else{const de=V-C,fe=B?Ye:Zr;let me;!Number.isFinite(de)||de<=0||!Number.isFinite(fe)?me=.5:(me=Math.min(1,Math.max(0,(fe-C)/de)),Number.isFinite(me)||(me=.5));const Le=Math.max(0,J.length-1),Ae=Math.min(Math.max(0,Math.floor(me*Le)),Le),pe=J[Ae],yt=J[Math.min(Ae+1,Le)]??pe,bt=Math.max(0,Math.min(1,me*Le-Ae));Ha=Math.round(pe.r+(yt.r-pe.r)*bt),Wa=Math.round(pe.g+(yt.g-pe.g)*bt),Ya=Math.round(pe.b+(yt.b-pe.b)*bt)}const ps=Math.max(0,Math.floor(gn-G)),hs=Math.min(b,Math.ceil(gn+G)),gs=Math.max(0,Math.floor(Qr-G)),ys=Math.min(T,Math.ceil(Qr+G));for(let de=gs;de<ys;de++)for(let fe=ps;fe<hs;fe++){const me=(de*b+fe)*4;A[me]=Ha,A[me+1]=Wa,A[me+2]=Ya,A[me+3]=255,Y[de][fe]=B?Ye*100:ge}}I.putImageData(X,0,0),xe=q,La=Y,S.clearRect(0,0,x.width,x.height),S.save(),S.translate(ie.x,ie.y),S.scale(ie.k,ie.k),S.imageSmoothingEnabled=!1;const j=xe.width,L=-ie.x/ie.k,Q=(x.width-ie.x)/ie.k,Z=Math.floor(L/j)-1,se=Math.ceil(Q/j)+1;for(let ee=Z;ee<=se;ee++)S.drawImage(xe,ee*j,0);S.restore()}function Ki(e,t,a,r=3.2,o=550){if(!xe||!Pn)return;const i=e.getBoundingClientRect(),l=xe.width,s=xe.height;let c=t;for(;c>180;)c-=360;for(;c<-180;)c+=360;const d=(c+180)/360*l,u=(90-a)/150*s,f=[d-l,d,d+l];let m=i.width/2-d*r,p=Math.abs(m-ie.x);for(const S of f){const x=i.width/2-S*r,b=Math.abs(x-ie.x);b<p&&(p=b,m=x)}const v=i.height/2-u*r,M=Fa.translate(m,v).scale(r);lt(e).transition().duration(o).ease(Zd).call(Pn.transform,M),ie=M,Sr?.()}function Nm(e,t,a,r,o,i,l,s){if(!La||!xe)return;let c=(a-ie.x)/ie.k;const d=(r-ie.y)/ie.k,u=xe.width,f=xe.height;c=(c%u+u)%u;const m=Math.floor(c),p=Math.floor(d);if(m>=0&&m<u&&p>=0&&p<f){const v=La?.[p]?.[m]??0;if(isFinite(v)){const M=c/u*360-180,S=90-d/f*150;km(e,t,S,M,v,o,s)}else Rn()}else Rn()}function wt(e){const t=new Date(e);return`${["January","February","March","April","May","June","July","August","September","October","November","December"][t.getMonth()]} ${t.getDate()}, ${t.getFullYear()}`}function Bm(e){const{date:t,timeRange:a,sidebarOpen:r,sidebarWidth:o,mode:i,compareMode:l,compareDateStart:s,compareDateEnd:c}=e;let d=0,u=0,f=0,m=0,p=0,v=0,M=0,S=100;if(a){const b=new Date(a.start),T=new Date(a.end),P=new Date(t);if(u=Math.floor((T.getTime()-b.getTime())/(1e3*60*60*24)),f=Math.floor((P.getTime()-b.getTime())/(1e3*60*60*24)),m=u>0?f/u*100:0,i==="Compare"&&l==="Dates"){const R=s?new Date(s):b,k=c?new Date(c):T;p=Math.max(0,Math.floor((R.getTime()-b.getTime())/(1e3*60*60*24))),v=Math.min(u,Math.floor((k.getTime()-b.getTime())/(1e3*60*60*24))),M=u>0?p/u*100:0,S=u>0?v/u*100:100}}const x=r?o+16:16;if(i==="Compare"&&l==="Dates"&&a){const b=wt(s||a.start),T=wt(c||a.end);return`
      <div class="time-slider-container" style="right: ${x}px">
        <div data-role="time-label" class="time-label">${b} – ${T}</div>
        <div class="time-slider-row dual-slider" data-role="dual-slider">
          <div
            class="dual-slider-track"
            aria-hidden="true"
          ></div>
          <div
            class="dual-slider-fill"
            data-role="dual-fill"
            style="--fill-start: ${M}%; --fill-end: ${S}%"
            aria-hidden="true"
          ></div>
          <input
            type="range"
            min="${d}"
            max="${u}"
            step="1"
            value="${p}"
            data-action="set-time-start"
            class="time-slider dual-thumb dual-thumb-start"
            aria-label="Start date"
          />
          <input
            type="range"
            min="${d}"
            max="${u}"
            step="1"
            value="${v}"
            data-action="set-time-end"
            class="time-slider dual-thumb dual-thumb-end"
            aria-label="End date"
          />
        </div>
      </div>
    `}return`
      <div class="time-slider-container" data-role="time-slider" style="right: ${x}px">
        <div data-role="time-label" class="time-label">${wt(t)}</div>
        <div class="time-slider-row">
          <input
            type="range"
            min="${d}"
            max="${u}"
            step="1"
            value="${f}"
            data-action="set-time"
            class="time-slider"
            style="--slider-fill: ${m}%"
          />
        </div>
      </div>
    `}let Jt=null,Mr=null;function Vm(e){const{root:t,getTimeRange:a,onDateChange:r,getMode:o,getCompareMode:i,getCompareDates:l,onDateRangeChange:s}=e;Mr=t.querySelector('[data-role="time-label"]')?.parentElement??null;const c=()=>o?.()==="Compare"&&i?.()==="Dates";t.querySelectorAll('[data-action="set-time"]').forEach(S=>S.addEventListener("input",()=>{if(c())return;const x=Number.parseInt(S.value,10),b=a();if(!Number.isNaN(x)&&b){const T=new Date(b.start);T.setDate(T.getDate()+x);const P=T.toISOString().split("T")[0],R=t.querySelector('[data-role="time-label"]');R&&(R.textContent=wt(P));const k=new Date(b.end),_=Math.floor((k.getTime()-new Date(b.start).getTime())/(1e3*60*60*24)),Y=_>0?x/_*100:0;S.style.setProperty("--slider-fill",`${Y}%`),Jt&&window.clearTimeout(Jt),Jt=window.setTimeout(()=>{r(P)},500)}}));const u=t.querySelectorAll('[data-action="set-time-start"]'),f=t.querySelectorAll('[data-action="set-time-end"]'),m=t.querySelector('[data-role="dual-fill"]'),p=(S,x,b,T,P)=>{const R=t.querySelector('[data-role="time-label"]'),k=new Date(b.start),_=new Date(b.start);k.setDate(k.getDate()+S),_.setDate(_.getDate()+x);const Y=k.toISOString().split("T")[0],K=_.toISOString().split("T")[0];R&&(R.textContent=`${wt(Y)} – ${wt(K)}`);const z=new Date(b.end).getTime()-new Date(b.start).getTime(),U=Math.max(1,Math.floor(z/(1e3*60*60*24))),te=S/U*100,J=x/U*100;[m,T,P].forEach(q=>{q&&(q.style.setProperty("--fill-start",`${te}%`),q.style.setProperty("--fill-end",`${J}%`))})},v=(S,x,b)=>{S.addEventListener("input",()=>{if(!c())return;const T=a();if(!T)return;const P=Math.floor((new Date(T.end).getTime()-new Date(T.start).getTime())/(1e3*60*60*24));let R=Number.parseInt(b?S.value:x.value,10),k=Number.parseInt(b?x.value:S.value,10);if(Number.isNaN(R)||Number.isNaN(k))return;R=Math.max(0,Math.min(R,P)),k=Math.max(0,Math.min(k,P)),b&&R>k?(k=R,x.value=String(k)):!b&&k<R&&(R=k,x.value=String(R)),p(R,k,T,b?S:x,b?x:S);const _=new Date(T.start);_.setDate(_.getDate()+R);const Y=new Date(T.start);Y.setDate(Y.getDate()+k);const K=_.toISOString().split("T")[0],z=Y.toISOString().split("T")[0];Jt&&window.clearTimeout(Jt),Jt=window.setTimeout(()=>{s?.(K,z)},300)})},M=S=>{const x=u[0],b=f[0];!x||!b||(S==="start"?(x.style.zIndex="4",b.style.zIndex="3"):(x.style.zIndex="3",b.style.zIndex="4"))};if(u.length&&f.length){u.forEach((b,T)=>{const P=f[T]||f[0];v(b,P,!0),b.addEventListener("pointerdown",()=>M("start"))}),f.forEach((b,T)=>{const P=u[T]||u[0];v(b,P,!1),b.addEventListener("pointerdown",()=>M("end"))}),u.forEach(b=>b.addEventListener("focus",()=>M("start"))),f.forEach(b=>b.addEventListener("focus",()=>M("end")));const S=(b,T)=>{b.addEventListener("pointerdown",P=>{if(!c())return;const R=a();if(!R)return;const k=b.getBoundingClientRect(),_=Math.min(1,Math.max(0,(P.clientX-k.left)/k.width)),Y=Math.max(1,Math.floor((new Date(R.end).getTime()-new Date(R.start).getTime())/(1e3*60*60*24))),K=Number.parseInt(b.value,10),U=(Number.isNaN(K)?0:Math.max(0,Math.min(K,Y)))/Y;Math.abs(_-U)*k.width>14&&(P.preventDefault(),P.stopPropagation(),M(b===T?"end":"start"))})};if(S(u[0],f[0]),S(f[0],u[0]),c()){const b=a(),T=l?.();if(b&&T){const P=Math.max(0,Math.floor((new Date(T.start).getTime()-new Date(b.start).getTime())/864e5)),R=Math.max(0,Math.floor((new Date(T.end).getTime()-new Date(b.start).getTime())/(1e3*60*60*24))),k=u[0],_=f[0];k.value=String(P),_.value=String(Math.max(R,P)),p(P,Math.max(R,P),b,k,_)}}t.querySelectorAll(".dual-slider").forEach(b=>{b.addEventListener("pointermove",T=>{if(!c())return;const P=a();if(!P)return;const R=u[0],k=f[0];if(!R||!k)return;const _=b.getBoundingClientRect(),Y=Math.min(1,Math.max(0,(T.clientX-_.left)/_.width)),K=Math.max(1,Math.floor((new Date(P.end).getTime()-new Date(P.start).getTime())/(1e3*60*60*24)));let z=Number.parseInt(R.value,10),U=Number.parseInt(k.value,10);Number.isNaN(z)&&(z=0),Number.isNaN(U)&&(U=K);const te=z/K,J=U/K,w=Math.abs(Y-te)<=Math.abs(Y-J);M(w?"start":"end")})})}}function Fm(e,t){if(Mr){const a=e?t+16:16;Mr.style.right=`${a}px`}}const Um=!1;function Gi(e,t){document.querySelectorAll("[data-role='chart-container']").forEach(r=>{r.style.transition="padding 220ms ease, padding-right 220ms ease, transform 220ms ease",r.style.paddingRight=`${e}px`,typeof t=="number"&&(r.style.transform=`scale(${t})`,r.style.transformOrigin="center center")})}function Ke(e){const t=e.toLowerCase();return t==="historical"?"Historical":t==="ssp245"?"SSP245":t==="ssp370"?"SSP370":t==="ssp585"?"SSP585":e}function Om(e){const t=e.toLowerCase();return t==="viridis"?"Viridis":t==="magma"?"Magma":t==="cividis"?"Cividis":t==="thermal"?"Thermal":e}function ne(e){return new Date(e)}function mn(e){if(!e.length)return qe("Historical");let t="1900-01-01",a="2100-12-31";return e.forEach((r,o)=>{const i=qe(r);if(o===0){t=i.start,a=i.end;return}t=ne(i.start)>ne(t)?i.start:t,a=ne(i.end)<ne(a)?i.end:a}),{start:t,end:a}}function $e(e,t){const a=ne(e),r=ne(t.start),o=ne(t.end);return a<r?t.start:a>o?t.end:e}function Qi(e){const t=ne(e);if(Number.isNaN(t.getTime()))return{start:"2015-01-01",end:"2099-01-01"};const a=t.getMonth(),r=t.getDate(),o=s=>{const c=new Date(s,a+1,0).getDate();return Math.min(r,c)},i=new Date(2015,a,o(2015)),l=new Date(2099,a,o(2099));return{start:i.toISOString().slice(0,10),end:l.toISOString().slice(0,10)}}const Re=["Historical","SSP245","SSP370","SSP585"],Se=["ACCESS-CM2","CanESM5","CESM2","CMCC-CM2-SR5","EC-Earth3","GFDL-ESM4","INM-CM5-0","IPSL-CM6A-LR","MIROC6","MPI-ESM1-2-HR","MRI-ESM2-0"],ke=["tas","pr","rsds","hurs","rlds","sfcWind","tasmin","tasmax"],qm={SSP245:"A moderate scenario (2015-2100) that assumes we take active measures against climate change. This represents a realistic path where significant climate protection policies are implemented, leading to moderate warming by the end of the century.",SSP370:"A moderate-to-high scenario (2015-2100) representing a middle ground. This path assumes some climate action is taken, but not enough to prevent substantial warming. It falls between optimistic and pessimistic outcomes.",SSP585:"A pessimistic scenario (2015-2100) representing a worst-case path with minimal climate action. This shows what happens if we continue with current trends and take little to no measures against climate change, leading to severe warming.",Historical:"Historical climate simulation (1950-2014) based on past conditions. This represents simulated climate data for the historical period, used as a baseline to compare against future projections."},zm={tas:"Near-Surface Air Temperature",pr:"Precipitation",rsds:"Surface Downwelling Shortwave Radiation",hurs:"Near-Surface Relative Humidity",rlds:"Surface Downwelling Longwave Radiation",sfcWind:"Daily-Mean Near-Surface Wind Speed",tasmin:"Daily Minimum Near-Surface Air Temperature",tasmax:"Daily Maximum Near-Surface Air Temperature"},Hm={tas:"The air temperature near the Earth's surface, measured in Kelvin.",pr:"The amount of water that falls from the atmosphere to the surface, measured as mass per unit area per unit time.",rsds:"Incoming solar radiation reaching the Earth's surface, measured in Watts per square meter.",hurs:"The amount of moisture in the air relative to the maximum it can hold, expressed as a percentage.",rlds:"Incoming thermal radiation from the atmosphere, measured in Watts per square meter.",sfcWind:"The average wind speed near the surface over a day, measured in meters per second.",tasmin:"The lowest air temperature near the surface during a day, measured in Kelvin.",tasmax:"The highest air temperature near the surface during a day, measured in Kelvin."},Wm={"ACCESS-CM2":"Developed by Australia's research institutions. This model is part of the global CMIP6 ensemble, providing climate projections that contribute to our understanding of future climate patterns.",CanESM5:"The Canadian Earth System Model version 5, developed by Environment and Climate Change Canada. This model represents North American climate research and contributes valuable projections to the global climate science community.",CESM2:"The Community Earth System Model version 2, developed by the National Center for Atmospheric Research (NCAR) in the United States. One of the most widely used models in climate research, known for its comprehensive representation of Earth's climate system.","CMCC-CM2-SR5":"Developed by the Euro-Mediterranean Center on Climate Change (CMCC) in Italy. This model provides European perspectives on climate change and is particularly valuable for understanding Mediterranean and European climate patterns.","EC-Earth3":"A collaborative European climate model developed by multiple research institutions across Europe. This model combines expertise from various European countries to provide comprehensive climate projections.","GFDL-ESM4":"Developed by NOAA's Geophysical Fluid Dynamics Laboratory in the United States. This model is known for its advanced representation of ocean and atmosphere interactions, providing detailed climate projections.","INM-CM5-0":"Developed by the Institute of Numerical Mathematics in Russia. This model contributes a unique perspective from Russian climate research to the global ensemble of climate models.","IPSL-CM6A-LR":"Developed by the Institut Pierre-Simon Laplace in France. This model is part of a long-standing French climate modeling tradition and provides important contributions to understanding global climate dynamics.",MIROC6:"Developed by a Japanese research consortium. This model represents Asian climate research expertise and contributes valuable insights, particularly for understanding climate patterns in the Asia-Pacific region.","MPI-ESM1-2-HR":"Developed by the Max Planck Institute in Germany. This high-resolution model provides detailed climate projections and is known for its sophisticated representation of Earth's climate system.","MRI-ESM2-0":"Developed by Japan's Meteorological Research Institute. This model contributes Japanese climate research expertise to the global ensemble, providing valuable perspectives on climate change projections."},ue=[{name:"Viridis",colors:["#440154","#3b528b","#21908d","#5dc863","#fde725"]},{name:"Plasma",colors:["#0d0887","#7e03a8","#cc4678","#f89441","#f0f921"]},{name:"Inferno",colors:["#000004","#420a68","#932667","#dd513a","#fdea45"]},{name:"Magma",colors:["#000004","#3b0f70","#8c2981","#de4968","#fe9f6d"]},{name:"Cividis",colors:["#00204c","#31456a","#6b6d7f","#a59c8f","#fdea9b"]},{name:"Coolwarm",colors:["#3b4cc0","#6f92f3","#dddcdc","#f49a7b","#b40426"]},{name:"RdBu",colors:["#67001f","#d6604d","#f7f7f7","#4393c3","#053061"]},{name:"Turbo",colors:["#30123b","#4145ab","#2fb7b0","#8bd646","#f9a31b"]},{name:"Thermal",colors:["#04142f","#155570","#1fa187","#f8c932","#f16623"]}],D={page:{position:"relative",minHeight:"100vh",color:"white",overflow:"hidden",fontFamily:"Inter, system-ui, sans-serif"},bgLayer1:{position:"absolute",inset:0,background:"linear-gradient(135deg, #05070f, #0b1326)"},bgLayer2:{position:"absolute",inset:0,background:"radial-gradient(circle at 20% 20%, rgba(56,189,248,0.12), transparent 32%), radial-gradient(circle at 80% 10%, rgba(139,92,246,0.15), transparent 30%), radial-gradient(circle at 50% 70%, rgba(34,197,94,0.08), transparent 28%)"},bgOverlay:{position:"absolute",inset:0,background:"#050505",opacity:.35},branding:{position:"fixed",top:16,left:16,display:"flex",alignItems:"center",gap:12,padding:"8px 0",background:"transparent",border:"none",borderRadius:0,zIndex:"9999",boxShadow:"none",backdropFilter:"none",pointerEvents:"auto"},brandIcon:{width:38,height:38,position:"relative",display:"grid",placeItems:"center",filter:"drop-shadow(0 8px 18px rgba(0, 0, 0, 0.42))",transition:"transform 160ms ease, filter 160ms ease","--iris-x":"0px","--iris-y":"0px","--pupil-x":"0px","--pupil-y":"0px","--blink-open":"1"},brandSvg:{width:"100%",height:"100%",display:"block"},brandOutline:{stroke:"white",strokeWidth:5,strokeLinecap:"round",strokeLinejoin:"round",fill:"none",opacity:.92},brandLids:{transform:"translate(60px, 40px) scaleY(var(--blink-open, 1)) translate(-60px, -40px)",transformOrigin:"60px 40px",transition:"none"},brandClipRect:{transform:"translate(60px, 40px) scaleY(var(--blink-open, 1)) translate(-60px, -40px)",transformOrigin:"60px 40px",transition:"none"},brandIrisGroup:{transform:"translate(var(--iris-x, 0px), var(--iris-y, 0px))",transition:"none",transformBox:"fill-box",transformOrigin:"center center"},brandIris:{stroke:"white",strokeWidth:5,fill:"rgba(255, 255, 255, 0.08)"},brandPupilGroup:{transform:"translate(var(--pupil-x, 0px), var(--pupil-y, 0px))",transition:"none",transformOrigin:"center center"},brandEyeContent:{clipPath:"url(#brand-eye-clip)"},brandPupil:{fill:"white"},brandHighlight:{fill:"white",opacity:.92},brandName:{fontSize:18,fontWeight:700,letterSpacing:.6,color:"white",textTransform:"none",textShadow:"0 8px 20px rgba(0, 0, 0, 0.45)"},field:{minWidth:0,display:"flex",flexDirection:"column",gap:4},fieldLabel:{fontSize:11,letterSpacing:.5,color:"var(--text-secondary)",textTransform:"uppercase"},mapArea:{position:"absolute",inset:0,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:10,textAlign:"center",pointerEvents:"none",zIndex:1},mapSearchWrap:{position:"absolute",top:18,left:"50%",transform:"translateX(-50%)",width:"min(360px, 70vw)",pointerEvents:"auto",zIndex:12,transition:"transform 220ms ease, width 220ms ease"},mapSearchResults:{maxHeight:220,overflowY:"auto"},mapMarker:{position:"absolute",left:0,top:0,width:28,height:36,pointerEvents:"none",zIndex:11,transform:"translate(-9999px, -9999px)",opacity:0,transition:"opacity 160ms ease",filter:"drop-shadow(0 10px 18px rgba(0,0,0,0.45))"},mapInfoPanel:{position:"absolute",left:0,top:0,width:360,maxWidth:"min(360px, 80vw)",opacity:0,userSelect:"none",transform:"translate(-9999px, -9999px)",transition:"opacity 160ms ease",zIndex:12},mapInfoHeader:{display:"flex",alignItems:"flex-start",justifyContent:"space-between",gap:8,cursor:"grab",touchAction:"none"},mapInfoTitleGroup:{display:"flex",flexDirection:"column",gap:2,flex:1,minWidth:0},mapInfoActions:{display:"flex",gap:6,alignItems:"center"},mapInfoActionBtn:{width:30,height:30,borderRadius:8,border:"none",background:"transparent",color:"var(--text-secondary)",display:"inline-flex",alignItems:"center",justifyContent:"center",cursor:"pointer",pointerEvents:"auto",transition:"all 120ms ease"},mapInfoExpandBtn:{position:"absolute",right:12,bottom:12},mapInfoSubtitle:{fontSize:11.5,color:"var(--text-secondary)",marginTop:2},mapInfoBody:{marginTop:10,display:"flex",flexDirection:"column",gap:10,paddingBottom:36},mapInfoLoadingRow:{display:"flex",alignItems:"center",gap:8,fontSize:11,color:"var(--text-secondary)"},mapInfoLoadingSpinner:{width:14,height:14,borderRadius:"50%",border:"2px solid rgba(255,255,255,0.18)",borderTop:"2px solid #34d399",animation:"sv-spin 1s linear infinite",flexShrink:0},mapRangeOverlay:{position:"fixed",left:0,bottom:0,right:0,height:"min(280px, 36vh)",display:"flex",alignItems:"flex-end",pointerEvents:"none",zIndex:9,transition:"right 220ms ease, opacity 180ms ease"},mapRangePanel:{width:"100%",height:"100%",padding:"12px 18px 12px",display:"flex",flexDirection:"column",gap:10,pointerEvents:"auto",background:"linear-gradient(180deg, rgba(6, 10, 18, 0) 0%, rgba(6, 10, 18, 0.55) 45%, rgba(6, 10, 18, 0.94) 100%)",backdropFilter:"blur(8px)"},mapRangeHeader:{display:"flex",alignItems:"flex-start",justifyContent:"space-between",gap:12},mapRangeTitleGroup:{display:"flex",flexDirection:"column",gap:3,minWidth:0},mapRangeTitle:{fontSize:14,fontWeight:700,letterSpacing:.2,color:"var(--text-primary)"},mapRangeBody:{display:"flex",flexDirection:"column",gap:10,maxHeight:220,overflow:"hidden"},mapRangeChartWrap:{width:"100%",display:"flex",justifyContent:"center",alignItems:"flex-start",height:220,overflow:"hidden"},mapRangeLoadingRow:{display:"flex",alignItems:"center",gap:8,fontSize:11,color:"var(--text-secondary)"},mapRangeLoadingSpinner:{width:14,height:14,borderRadius:"50%",border:"2px solid rgba(255,255,255,0.18)",borderTop:"2px solid #34d399",animation:"sv-spin 1s linear infinite",flexShrink:0},drawOverlay:{position:"absolute",inset:0,background:"rgba(5, 10, 20, 0.28)",backdropFilter:"blur(1px)",pointerEvents:"none",zIndex:8},drawOverlayCanvas:{position:"absolute",inset:0,width:"100%",height:"100%",pointerEvents:"none",zIndex:9},drawPrompt:{position:"absolute",top:16,left:"50%",transform:"translateX(-50%)",padding:"10px 14px",borderRadius:12,background:"rgba(15, 23, 42, 0.92)",border:"1px solid var(--border-medium)",boxShadow:"var(--shadow-elevated)",fontWeight:800,fontSize:13,color:"var(--text-primary)",pointerEvents:"none",zIndex:10,textAlign:"center"},drawPromptSub:{marginTop:4,fontSize:12,fontWeight:600,color:"var(--text-secondary)"},loadingIndicator:{position:"absolute",left:18,bottom:80,display:"flex",alignItems:"center",gap:12,padding:0,pointerEvents:"auto",zIndex:20,minWidth:160},loadingSpinner:{width:18,height:18,borderRadius:"50%",border:"2px solid rgba(255,255,255,0.18)",borderTop:"2px solid #34d399",animation:"sv-spin 1s linear infinite",flexShrink:0},loadingTextGroup:{display:"flex",flexDirection:"column",gap:4,alignItems:"flex-start",minWidth:0},loadingText:{fontSize:12.5,fontWeight:700,color:"var(--text-primary)",letterSpacing:.3},loadingSubtext:{fontSize:11.5,color:"var(--text-secondary)",letterSpacing:.2},loadingBar:{position:"relative",width:120,height:6,borderRadius:999,background:"rgba(255, 255, 255, 0.08)",overflow:"hidden"},loadingBarFill:{position:"absolute",inset:0,borderRadius:999,background:"linear-gradient(90deg, rgba(52, 211, 153, 0.9), rgba(125, 211, 252, 0.9))",transition:"width 140ms ease",width:"0%"},compareInfoWrap:{position:"fixed",right:24,bottom:88,display:"flex",alignItems:"center",pointerEvents:"auto",zIndex:1e4},compareInfoButton:{padding:0,background:"transparent",border:"none",color:"var(--text-primary)",fontWeight:700,fontSize:13,letterSpacing:.2,cursor:"pointer",textDecoration:"underline"},infoModalOverlay:{position:"fixed",inset:0,background:"transparent",backdropFilter:"none",zIndex:200,display:"flex",alignItems:"center",justifyContent:"center",padding:16},infoModal:{width:"min(480px, 92vw)",background:"rgba(12, 16, 24, 0.98)",border:"1px solid var(--border-default)",borderRadius:14,boxShadow:"var(--shadow-elevated)",color:"var(--text-primary)",padding:20,position:"relative",maxWidth:"520px"},infoModalHeader:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:12,marginBottom:12},infoModalTitle:{fontSize:16,fontWeight:900,letterSpacing:.2,background:"var(--gradient-accent)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",backgroundClip:"text",color:"transparent"},infoModalClose:{width:32,height:32,borderRadius:8,border:"none",background:"transparent",color:"var(--text-secondary)",cursor:"pointer",display:"inline-flex",alignItems:"center",justifyContent:"center",fontWeight:700},infoModalBody:{fontSize:14,lineHeight:1.6,color:"var(--text-primary)",display:"block",textAlign:"left",whiteSpace:"normal",wordBreak:"break-word"},infoModalFooter:{marginTop:18,display:"flex",justifyContent:"center"},infoModalConfirm:{padding:"10px 16px",borderRadius:10,border:"1px solid var(--accent-border)",background:"var(--gradient-primary)",color:"white",fontWeight:700,cursor:"pointer",boxShadow:"var(--shadow-combined)"},canvasToggle:{position:"fixed",top:14,display:"flex",alignItems:"center",gap:8,pointerEvents:"auto",zIndex:100,transition:"right 0.25s ease"},canvasSwitch:{position:"relative",display:"grid",gridTemplateColumns:"1fr 1fr",gap:0,padding:3,borderRadius:11,background:"var(--dark-bg)",border:"var(--border-base)",boxShadow:"var(--shadow-elevated)",zIndex:101},canvasIndicator:{position:"absolute",top:3,bottom:3,left:3,width:"calc(50% - 3px)",borderRadius:9,background:"var(--gradient-indicator)",boxShadow:"var(--shadow-canvas), var(--shadow-inset)",transition:"transform 180ms ease",zIndex:0,pointerEvents:"none"},canvasBtn:{width:40,height:40,borderRadius:9,border:"1px solid transparent",background:"var(--bg-transparent)",color:"var(--text-secondary)",cursor:"pointer",display:"inline-flex",alignItems:"center",justifyContent:"center",transition:"color 120ms ease",position:"relative",zIndex:1},canvasBtnActive:{color:"white"},mapTitle:{fontSize:18,fontWeight:600},mapSubtitle:{fontSize:14,color:"var(--text-secondary)"},modeSwitch:{position:"relative",display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:4,padding:2,borderRadius:10,border:"1px solid var(--border-subtle)",background:"var(--bg-subtle)",boxShadow:"none"},modeIndicator:{position:"absolute",top:2,bottom:2,left:2,width:"calc(33.333% - 2px)",borderRadius:8,background:"var(--gradient-mode-indicator)",boxShadow:"var(--shadow-combined)",transition:"transform 200ms ease",zIndex:0},modeBtn:{flex:1,padding:"8px 0",borderRadius:8,border:"none",color:"var(--text-secondary)",cursor:"pointer",transition:"all 0.15s ease",background:"var(--bg-transparent)",textAlign:"center",fontSize:12.5,fontWeight:700,letterSpacing:.2,outline:"none",boxShadow:"none",position:"relative",zIndex:1},modeBtnActive:{background:"var(--gradient-primary)",border:"none",color:"white",boxShadow:"var(--shadow-combined)"},tabSwitch:{position:"absolute",left:32,right:12,bottom:-8,display:"flex",gap:10,padding:"0 8px",alignItems:"flex-end",pointerEvents:"auto",zIndex:0},tabBtn:{borderRadius:"14px 14px 0 0",padding:"12px 18px",background:"var(--bg-strong)",color:"var(--text-secondary)",fontWeight:700,fontSize:13,letterSpacing:.35,cursor:"pointer",transition:"all 0.18s ease",boxShadow:"inset 0 1px 0 rgba(255,255,255,0.06), 0 8px 18px rgba(0,0,0,0.32)",borderTop:"var(--border-base)",borderRight:"var(--border-base)",borderLeft:"var(--border-base)",borderBottom:"none",transform:"translateY(4px)"},tabBtnActive:{background:"var(--gradient-tab-active)",color:"white",boxShadow:"inset 0 1px 0 rgba(255,255,255,0.12), 0 12px 26px rgba(0,0,0,0.42)",borderTop:"var(--border-active)",borderRight:"var(--border-active)",borderLeft:"var(--border-active)",borderBottom:"none",transform:"translateY(-4px)",zIndex:1},modeViewport:{overflow:"hidden",width:"100%",position:"relative",flex:1,minHeight:0,height:0},modeTrack:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",width:"300%",height:"100%",transition:"transform 220ms ease"},modePane:{width:"100%",height:"100%",paddingRight:4,overflowY:"auto",overflowX:"hidden",scrollbarGutter:"stable",minHeight:0,maxHeight:"100%"},sectionTitle:{fontSize:13,fontWeight:700,color:"var(--text-primary)",letterSpacing:.3,textTransform:"uppercase"},paramGrid:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10},range:{width:"100%",background:"var(--bg-transparent)",appearance:"none",WebkitAppearance:"none",height:10,outline:"none",padding:0,margin:0},resolutionRow:{display:"flex",alignItems:"center",gap:12},resolutionValue:{fontSize:12.5,color:"var(--text-secondary)",minWidth:60,textAlign:"right"},chartPanel:{width:"min(1200px, 100%)",background:"transparent",border:"none",borderRadius:0,padding:0,boxShadow:"none",backdropFilter:"none"},chartHeader:{textAlign:"center",marginBottom:12},chartTitle:{fontSize:18,fontWeight:800,color:"var(--text-primary)"},chartPlotWrapper:{width:"100%",minHeight:360,background:"transparent",border:"none",borderRadius:0,padding:0,position:"relative"},chartEmpty:{textAlign:"center",color:"var(--text-secondary)",padding:"40px 16px",lineHeight:1.6},chartError:{color:"#fca5a5",background:"rgba(248,113,113,0.08)",border:"1px solid rgba(248,113,113,0.35)",borderRadius:12,padding:14,fontSize:13,lineHeight:1.5},chipRow:{display:"flex",flexWrap:"wrap",gap:8},chip:{padding:"8px 10px",borderRadius:12,border:"1px solid var(--border-medium)",background:"rgba(255,255,255,0.04)",color:"var(--text-primary)",cursor:"pointer",fontSize:12.5,fontWeight:700,letterSpacing:.2,transition:"all 140ms ease"},chipActive:{borderColor:"rgba(167,139,250,0.65)",background:"rgba(167,139,250,0.16)",boxShadow:"0 0 0 1px rgba(167,139,250,0.35)"},chartLegend:{display:"flex",gap:12,flexWrap:"wrap",alignItems:"center",marginTop:10,fontSize:12,color:"var(--text-secondary)"}},n={mode:"Explore",panelTab:"Manual",sidebarOpen:!0,canvasView:"map",scenario:"SSP245",model:Se[0],variable:ke[0],date:Ln("SSP245"),mapPalette:ue[0].name,mapInfoPalette:ue[0].name,mapRangePalette:ue[0].name,chartPalette:ue[0].name,resolution:2,selectedUnit:Ne(ke[0]).label,chartMode:"single",chartDate:"2026-01-16",chartRangeStart:"2015-01-01",chartRangeEnd:"2099-01-01",chartVariable:ke[0],chartUnit:Ne(ke[0]).label,chartScenarios:["SSP245","SSP370","SSP585"],chartModels:[...Se],chartDropdown:{scenariosOpen:!1,modelsOpen:!1},chartLoadingProgress:{total:0,done:0},chartSamples:[],chartBoxes:null,chartRangeSeries:null,chartLoading:!1,chartError:null,chartLocation:"World",chartLocationName:null,chartLocationSearchQuery:"",chartLocationSearchResults:[],chartLocationSearchLoading:!1,chartLocationSearchError:null,mapLocationSearchQuery:"",mapLocationSearchResults:[],mapLocationSearchLoading:!1,mapLocationSearchError:null,mapLocationSearchSelection:null,mapLocationSearchFocused:!1,mapLocationSearchCursor:{start:0,end:0},mapMarker:null,mapInfoSamples:[],mapInfoBoxes:null,mapInfoLoading:!1,mapInfoError:null,mapInfoLoadingProgress:{total:0,done:0},mapInfoOpen:!1,mapRangeSamples:[],mapRangeSeries:null,mapRangeLoading:!1,mapRangeError:null,mapRangeLoadingProgress:{total:0,done:0},mapRangeOpen:!1,mapRangeStart:"2015-01-01",mapRangeEnd:"2099-01-01",mapPolygon:null,chartPolygon:null,chartPoint:null,drawState:{active:!1,points:[],previewPoint:null},pointSelectActive:!1,chatInput:"",chatMessages:[],chatIsLoading:!1,compareMode:"Scenarios",availableModels:[],compareScenarioA:"SSP245",compareScenarioB:"SSP585",compareModelA:Se[0],compareModelB:Se[1]??Se[0],compareDateStart:Ln("SSP245"),compareDateEnd:Je(Zi(Ln("SSP245"),30),"SSP245"),masks:[],ensembleScenarios:["SSP245","SSP370","SSP585"],ensembleModels:[...Se],ensembleDropdown:{scenariosOpen:!1,modelsOpen:!1},ensembleStatistic:"mean",ensembleDate:Ln("SSP245"),ensembleVariable:ke[0],ensembleUnit:Ne(ke[0]).label,ensembleStatistics:null,ensembleStatisticRanges:new Map,ensembleStatisticsByVariable:new Map,ensembleStatisticRangesByVariable:new Map,ensembleRawSamplesByVariable:new Map,isLoading:!1,loadingProgress:0,dataError:null,currentData:null,apiAvailable:null,dataMin:null,dataMax:null,dataMean:null,timeRange:null,metaData:void 0,compareInfoOpen:!1,maskVariableData:new Map,maskVariableRanges:new Map,chartRequestId:0};let Ym=1,ve=null,on=null,ae=null,ea=null,Ct=null,vt=null,It=null,rt=null,Ot=null,ta=0,qt=null,na=0,At=0,St=null,Nt=0,Mt=null,aa=0,Bt=null,Ce={active:!1,pointerId:null,offsetX:0,offsetY:0};const Fo=500;function Xm(e){return e.replace(/[A-Z]/g,t=>`-${t.toLowerCase()}`)}function g(e){return Object.entries(e).filter(([,t])=>t!=null).map(([t,a])=>{const r=t.startsWith("--")?t:Xm(t),o=typeof a=="number"?`${a}px`:String(a);return`${r}:${o}`}).join(";")}function De(...e){return e.reduce((t,a)=>a?{...t,...a}:t,{})}function ye(e){return e.replace(/[&<>"']/g,t=>{switch(t){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#39;";default:return t}})}function $t(e){const t=new Date(e);return Number.isNaN(t.getTime())?e:t.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}function pn(e,t){return t?.variable_metadata?.[e]?.name||t?.variable_metadata?.[e]?.description||e}function tt(){return n.mode==="Ensemble"?{variable:n.ensembleVariable,unit:n.ensembleUnit}:{variable:n.variable,unit:n.selectedUnit}}function jt(){return tt()}function jr(e){return e==="std"||e==="iqr"||e==="percentile"||e==="extremes"}function kt(e,t=n.ensembleVariable,a=n.ensembleUnit){const o=(n.ensembleStatisticRangesByVariable.get(t)??(t===n.ensembleVariable?n.ensembleStatisticRanges:void 0))?.get(e);let i=null,l=null;if(o&&Number.isFinite(o.min)&&Number.isFinite(o.max)?(i=o.min,l=o.max):e===n.ensembleStatistic&&n.dataMin!==null&&n.dataMax!==null&&(i=n.dataMin,l=n.dataMax),i===null||l===null)return{min:null,max:null};const s=Wn(i,l,t,a,{isDifference:jr(e)});return{min:s.min,max:s.max}}function Dt(e=n.ensembleVariable,t=n.ensembleUnit){const a=n.ensembleRawSamplesByVariable.get(e);if(!a||a.length===0)return{min:null,max:null};let r=1/0,o=-1/0;for(const l of a)for(let s=0;s<l.length;s++){const c=l[s];if(!Number.isFinite(c))continue;const d=e==="hurs"?Math.min(c,100):c;r=Math.min(r,d),o=Math.max(o,d)}if(!Number.isFinite(r)||!Number.isFinite(o))return{min:null,max:null};const i=Wn(r,o,e,t);return{min:i.min,max:i.max}}function jm(e){const t=pn(e.variable,e.metaData),a=e.selectedUnit||e.metaData?.variable_metadata?.[e.variable]?.unit||"",r=a?`${a}`:"the dataset's native units";switch(e.compareMode){case"Dates":{const o=$t(e.compareDateStart),i=$t(e.compareDateEnd);return{title:"Comparing two dates",paragraphs:[`We are comparing ${t} on ${o} versus ${i} under the ${e.scenario} scenario using the ${e.model} model.`,`Values on the map represent ${i} minus ${o} in ${r}. A value of X means ${t} was X ${a||""} higher on ${i} than on ${o} (negative values mean it was lower).`]}}case"Models":{const o=$t(e.date);return{title:"Comparing two models",paragraphs:[`We are comparing ${t} between ${e.compareModelB} and ${e.compareModelA} on ${o} within the ${e.scenario} scenario.`,`Each value shows ${e.compareModelB} minus ${e.compareModelA} in ${r}. Positive numbers mean ${t} is higher in ${e.compareModelB}; negative means it is higher in ${e.compareModelA}.`]}}default:{const o=$t(e.date),i=e.compareScenarioA,l=e.compareScenarioB;return{title:"Comparing two scenarios",paragraphs:[`We are comparing ${t} for ${l} versus ${i} on ${o} using the ${e.model} model.`,`Values show ${l} minus ${i} in ${r}. A value of X means ${t} is X ${a||""} higher under ${l} than under ${i}; negative values mean it is lower.`]}}}}function Km(e){if(e.mode!=="Compare"||e.canvasView!=="map")return"";const t=jm(e),a=t.paragraphs.map((c,d)=>{const f=d===t.paragraphs.length-1?"0":"0 0 12px 0",m=c.replace(/(\bX\b|ΔX)/g,'<span style="color: var(--accent-purple);">$1</span>');return`<p style="display:block; margin:${f}; line-height:1.6; white-space: normal; word-break: break-word;">${m}</p>`}).join(""),r=e.sidebarOpen?Ee+24:24,o=e.mode==="Compare"&&e.compareMode==="Dates"?120:88,i=De(D.infoModalOverlay,{left:"0",right:"0",width:"100%",justifyContent:"center",paddingLeft:0}),l=De(D.infoModal,{alignSelf:"center",marginLeft:"auto",marginRight:"auto"}),s=e.compareInfoOpen?`
      <div data-role="compare-info-overlay" class="compare-info-overlay" style="${g(i)}">
        <div style="${g(l)}" role="dialog" aria-modal="true" aria-label="${t.title}">
          <div style="${g(D.infoModalHeader)}">
            <div style="${g(D.infoModalTitle)}">${t.title}</div>
            <button type="button" data-action="close-compare-info" style="${g(D.infoModalClose)}" aria-label="Close info dialog">✕</button>
          </div>
          <div style="${g(D.infoModalBody)}">
            ${a}
          </div>
          <div style="${g(D.infoModalFooter)}">
            <button type="button" data-action="close-compare-info" style="${g(D.infoModalConfirm)}">Got it</button>
          </div>
        </div>
      </div>
    `:"";return`
      <div data-role="compare-info-trigger" style="${g(De(D.compareInfoWrap,{right:r,bottom:o}))}">
        <button type="button" data-action="open-compare-info" style="${g(D.compareInfoButton)}">
          What am I seeing?
        </button>
      </div>
      ${s}
    `}async function Gm(){try{const e=await $m();n.apiAvailable=e}catch{n.apiAvailable=!1}}function Ln(e){if(e.toLowerCase()==="historical")return"2000-01-01";const t=new Date,a=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return a<2015?"2015-01-01":a>2100?"2100-12-31":`${a}-${r}-${o}`}function Zi(e,t){const a=new Date(e);return a.setFullYear(a.getFullYear()+t),a.toISOString().slice(0,10)}function qe(e){return e.toLowerCase()==="historical"?{start:"1950-01-01",end:"2014-12-31"}:{start:"2015-01-01",end:"2099-12-31"}}function Je(e,t){const a=qe(t),r=new Date(e),o=new Date(a.start),i=new Date(a.end);return r<o?a.start:r>i?a.end:e}function Uo(e){let t=1/0,a=-1/0;for(let r=0;r<e.length;r++){const o=e[r];isFinite(o)&&(t=Math.min(t,o),a=Math.max(a,o))}if(!isFinite(t)||!isFinite(a))throw new Error("No valid numeric values returned from dataset.");return{min:t,max:a}}function en(e){return e===null||!Number.isFinite(e)?"":e.toFixed(2)}function fa(e,t){let a=null,r=null;if(e===n.variable)a=n.dataMin,r=n.dataMax;else{const i=n.maskVariableRanges.get(e);i&&(a=i.min,r=i.max)}if(a===null||r===null)return null;const o=Wn(a,r,e,t);return{min:o.min,max:o.max}}function ma(e,t){let a=0,r=0;for(let o=0;o<e.length;o++){const i=e[o];if(!isFinite(i))continue;const l=t==="hurs"?Math.min(i,100):i;a+=l,r+=1}if(!r)throw new Error("No valid numeric values returned from dataset.");return a/r}function Ji(e,t){let a=!1;for(let r=0,o=t.length-1;r<t.length;o=r++){const i=t[r].lon,l=t[r].lat,s=t[o].lon,c=t[o].lat;l>e.lat!=c>e.lat&&e.lon<(s-i)*(e.lat-l)/(c-l+Number.EPSILON)+i&&(a=!a)}return a}function pa(e,t,a,r){const[o,i]=a,l=360/i,s=150/o;let c=0,d=0;for(let u=0;u<o;u++){const f=90-u*s-s/2;for(let m=0;m<i;m++){const p=m*l+l/2,v=p>180?p-360:p,M=(o-1-u)*i+m,S=e[M];if(!isFinite(S))continue;const x=t==="hurs"?Math.min(S,100):S;Ji({lat:f,lon:v},r)&&(c+=x,d+=1)}}if(!d)throw new Error("The selected region does not contain valid data points.");return c/d}function Qm(e,t,a=.75){const r=e.lat-t.lat,o=e.lon-t.lon;return Math.hypot(r,o)<=a}function In(e,t,a,r){const[o,i]=a,s=((r.lon+360)%360+360)%360/360*i-.5,c=(90-r.lat)/150*o-.5,d=(S,x,b)=>Math.min(b,Math.max(x,S)),u=d(Math.round(s),0,i-1),f=d(Math.round(c),0,o-1),m=(S,x)=>(o-1-x)*i+S,p=(S,x)=>{const b=(S%i+i)%i,T=d(x,0,o-1),P=m(b,T),R=e[P];return Number.isFinite(R)?R:null};let v=p(u,f);if(v===null){let x=null;for(let b=1;b<=3&&x===null;b++)for(let T=-b;T<=b;T++){for(let P=-b;P<=b;P++){if(Math.abs(P)!==b&&Math.abs(T)!==b)continue;const R=p(u+P,f+T);if(R!==null){x=R;break}}if(x!==null)break}v=x}if(v===null)throw new Error("No valid data at the selected point.");const M=t==="hurs"?Math.min(v,100):v;if(!Number.isFinite(M))throw new Error(`Invalid value at point: ${M}`);return M}function Et(){return{active:!1,points:[],previewPoint:null}}function es(e){on||(on=t=>{t.key==="Enter"&&n.drawState.active&&(t.preventDefault(),e())},window.addEventListener("keydown",on))}function Oa(){on&&(window.removeEventListener("keydown",on),on=null)}function _n(e){const t=n.drawState.active||n.pointSelectActive,a=n.mode==="Ensemble"?n.ensembleVariable:n.variable,r=n.mode==="Ensemble"?n.ensembleUnit:n.selectedUnit,o=n.metaData?.variable_metadata[a]?.unit||"";_m(e,n.currentData,o,a,r,{drawMode:t,onDrawClick:n.pointSelectActive?hp:pp,onDrawMove:n.drawState.active?mp:void 0,onMapClick:dp,onTransform:()=>{qa(),Oo(),Ea()}}),Oo(),Ea()}function qa(){if(!ae)return;const e=ae.querySelector("#draw-overlay-canvas"),t=ve||ae.querySelector("#map-canvas");if(!e||!t)return;const a=t.getBoundingClientRect(),r=window.devicePixelRatio||1;e.width=a.width*r,e.height=a.height*r,e.style.width=`${a.width}px`,e.style.height=`${a.height}px`;const o=e.getContext("2d");if(!o)return;o.save(),o.scale(r,r),o.clearRect(0,0,a.width,a.height);let i=[];if(n.drawState.active){const s=[...n.drawState.points];i=n.drawState.previewPoint?[...s,n.drawState.previewPoint]:s}else if(n.mapPolygon&&n.mapPolygon.length>=3)i=n.mapPolygon;else{o.restore();return}const l=[];if(i.forEach(s=>{const c=ua(t,s.lon,s.lat);c&&l.push(c)}),!l.length){o.restore();return}o.lineWidth=2,o.strokeStyle="#34d399",o.fillStyle="rgba(52,211,153,0.18)",o.beginPath(),o.moveTo(l[0].x,l[0].y);for(let s=1;s<l.length;s++)o.lineTo(l[s].x,l[s].y);l.length>2&&(o.closePath(),o.fill()),o.stroke(),n.drawState.active&&l.forEach(({x:s,y:c},d)=>{o.beginPath(),o.fillStyle=d===0?"#10b981":"#34d399",o.arc(s,c,4,0,Math.PI*2),o.fill(),o.strokeStyle="#0f172a",o.lineWidth=1,o.stroke()}),o.restore()}function Zm(){return n.drawState.active||n.mapPolygon!==null&&n.mapPolygon.length>=3?`
      <canvas
        id="draw-overlay-canvas"
        style="${g(D.drawOverlayCanvas)}"
      ></canvas>
    `:""}function Oo(){if(!ae)return;const e=ae.querySelector("#point-overlay-marker"),t=ve||ae.querySelector("#map-canvas");!e||!t||!n.pointSelectActive||(e.style.left="0px",e.style.top="0px",e.style.right="0px",e.style.bottom="0px",e.style.width="100%",e.style.height="100%")}function Ea(){if(!ae)return;const e=ae.querySelector("#map-location-marker"),t=ae.querySelector("#map-info-panel"),a=ve||ae.querySelector("#map-canvas");if(!a)return;const r=n.mapPolygon!==null&&n.mapPolygon.length>=3;if(e)if(!n.mapMarker)e.style.opacity="0",e.style.transform="translate(-9999px, -9999px)",e.title="Selected location";else{const o=ua(a,n.mapMarker.lon,n.mapMarker.lat);e.title=n.mapMarker.name?n.mapMarker.name:`Pixel ${n.mapMarker.pixel.x}, ${n.mapMarker.pixel.y}`,o?(e.style.opacity="1",e.style.transform=`translate(${o.x}px, ${o.y}px) translate(-50%, -100%)`):(e.style.opacity="0",e.style.transform="translate(-9999px, -9999px)")}if(t&&n.mapInfoOpen){const o=a.getBoundingClientRect(),i=t.offsetWidth||360,l=t.offsetHeight||240,s=12,c=n.sidebarOpen?Ee:0,u=t.offsetParent?.getBoundingClientRect(),f=u?o.left-u.left:0,m=u?o.top-u.top:0;let p,v;if(Bt)p=Bt.left,v=Bt.top;else if(n.mapMarker){const k=ua(a,n.mapMarker.lon,n.mapMarker.lat);if(!k){t.style.opacity="0",t.style.transform="translate(-9999px, -9999px)",t.style.pointerEvents="none",t.style.visibility="hidden";return}p=f+k.x-i-24,p<s&&(p=f+k.x+24),v=m+k.y-l/2}else if(r&&n.mapPolygon){let k=n.mapPolygon[0];for(const Y of n.mapPolygon)Y.lon<k.lon&&(k=Y);const _=ua(a,k.lon,k.lat);_?(p=f+_.x-i-24,p<s&&(p=f+_.x+24),v=m+_.y-l/2):(p=f+o.width-i-s-24,v=m+o.height/2-l/2)}else{t.style.opacity="0",t.style.transform="translate(-9999px, -9999px)",t.style.pointerEvents="none",t.style.visibility="hidden";return}const M=f+s,S=f+o.width-i-s-c,x=m+s,b=m+o.height-l-s;p=Math.max(M,Math.min(p,S)),v=Math.max(x,Math.min(v,b)),Bt&&(Bt={left:p,top:v});const T=t.style.left,P=t.style.top;(Bt!==null||Ce.active||!T||T==="0px"||!P||P==="0px")&&(t.style.left=`${p}px`,t.style.top=`${v}px`),t.style.opacity="1",t.style.transform="translate(0, 0)",t.style.pointerEvents="auto",t.style.visibility="visible"}else t&&!n.mapInfoOpen&&(t.style.opacity="0",t.style.transform="translate(-9999px, -9999px)",t.style.pointerEvents="none",t.style.visibility="hidden")}function ts(){if(!ae)return;const e=ae.querySelector('[data-role="map-location-search"]');if(!e)return;const t=n.sidebarOpen?-Ee/2:0;e.style.transform=`translateX(calc(-50% + ${t}px))`}function Jm(){return n.pointSelectActive?`
      <div style="${g(D.drawOverlay)}"></div>
      <div
        id="point-overlay-marker"
        style="${g({position:"absolute",inset:0,pointerEvents:"none",zIndex:9})}"
      ></div>
      <div style="${g(D.drawPrompt)}">
        <div>Click a point to sample</div>
        <div style="${g(D.drawPromptSub)}">
          The chart will load data for this single location
        </div>
      </div>
    `:""}function ep(){const e=n.mapMarker,t=e?.name?ye(e.name):e?`Pixel ${e.pixel.x}, ${e.pixel.y}`:"Selected location";return`
      <div
        id="map-location-marker"
        style="${g(D.mapMarker)}"
        aria-hidden="true"
        title="${t}"
      >
        <svg
          viewBox="0 0 28 36"
          width="28"
          height="36"
          aria-hidden="true"
          focusable="false"
        >
          <defs>
            <linearGradient id="map-marker-gradient" x1="0" x2="1">
              <stop offset="0%" stop-color="var(--accent-blue)" />
              <stop offset="100%" stop-color="var(--accent-purple)" />
            </linearGradient>
          </defs>
          <path
            d="M14 2C8.48 2 4 6.48 4 12c0 7.72 8.4 19.3 9.1 20.25.5.68 1.3.68 1.8 0C15.6 31.3 24 19.72 24 12 24 6.48 19.52 2 14 2Z"
            fill="url(#map-marker-gradient)"
          />
          <circle cx="14" cy="12" r="4.5" fill="rgba(9, 14, 28, 0.9)" />
          <circle cx="14" cy="12" r="3" fill="white" opacity="0.9" />
        </svg>
      </div>
    `}function ns(){const e=n.mapMarker!==null,t=n.mapPolygon!==null&&n.mapPolygon.length>=3;if(!e&&!t)return`<div style="${g(D.chartEmpty)}">Click a location or draw a region to load boxplots.</div>`;if(n.mapInfoLoading){const{unit:a}=tt(),r=n.mapInfoLoadingProgress.total>0?`${n.mapInfoLoadingProgress.done}/${n.mapInfoLoadingProgress.total} datasets loaded`:"Preparing datasets",o=n.mapInfoBoxes&&n.mapInfoBoxes.length?Yo(n.mapInfoBoxes,a,n.mapInfoPalette):`<div style="${g(D.chartEmpty)}">Loading boxplots...</div>`;return`
          <div style="${g(D.mapInfoLoadingRow)}">
            <div style="${g(D.mapInfoLoadingSpinner)}"></div>
            <div>${r}</div>
          </div>
          ${o}
        `}return n.mapInfoError?`<div style="${g(D.chartError)}">${ye(n.mapInfoError)}</div>`:!n.mapInfoBoxes||!n.mapInfoBoxes.length?`<div style="${g(D.chartEmpty)}">Click a location to load boxplots.</div>`:Yo(n.mapInfoBoxes,tt().unit,n.mapInfoPalette)}function tp(){if(!n.mapInfoOpen)return"";const e=n.mapMarker,a=n.mapPolygon!==null&&n.mapPolygon.length>=3?"Drawn Region":e?.name?e.name:e?`Pixel ${e.pixel.x}, ${e.pixel.y}`:"Selected location",{variable:r,unit:o}=tt(),i=pn(r,n.metaData),l=`${a} · ${i}`,s=`${$t(n.date)} · ${o}`;return`
      <div id="map-info-panel" class="custom-select-info-panel map-info-panel" style="${g(D.mapInfoPanel)}">
        <div class="map-info-header" style="${g(D.mapInfoHeader)}">
          <div style="${g(D.mapInfoTitleGroup)}">
            <div class="custom-select-info-panel-title">${ye(l)}</div>
            <div style="${g(D.mapInfoSubtitle)}">${ye(s)}</div>
          </div>
          <div style="${g(D.mapInfoActions)}">
            ${za("mapInfoPalette",n.mapInfoPalette)}
            <button
              type="button"
              data-action="close-map-info"
              aria-label="Close info"
              style="${g(D.mapInfoActionBtn)}"
              onmouseover="this.style.color='var(--text-primary)';this.style.background='rgba(15, 23, 42, 0.85)';"
              onmouseout="this.style.color='var(--text-secondary)';this.style.background='transparent';"
            >
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M6 6l12 12M18 6l-12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="map-info-body" style="${g(D.mapInfoBody)}">
          ${ns()}
        </div>
        <button
          type="button"
          data-action="open-map-info-chart"
          aria-label="Open chart view"
          style="${g({...D.mapInfoActionBtn,...D.mapInfoExpandBtn})}"
          onmouseover="this.style.color='var(--text-primary)';this.style.background='rgba(15, 23, 42, 0.85)';"
          onmouseout="this.style.color='var(--text-secondary)';this.style.background='transparent';"
        >
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M9 5H5v4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M15 5h4v4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M9 19H5v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M15 19h4v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    `}function as(){const{unit:e}=jt();if(n.mapRangeLoading){const t=n.mapRangeLoadingProgress.total>0?`${n.mapRangeLoadingProgress.done}/${n.mapRangeLoadingProgress.total} datasets loaded`:"Preparing datasets",a=n.mapRangeSeries&&n.mapRangeSeries.length?`<div style="${g(D.mapRangeChartWrap)}">${Ia(n.mapRangeSeries,{compact:!0,unitLabel:e,paletteName:n.mapRangePalette,lightToDarkNoDarkest:!0})}</div>`:`<div style="${g(D.chartEmpty)}">Loading range view...</div>`;return`
          <div style="${g(D.mapRangeLoadingRow)}">
            <div style="${g(D.mapRangeLoadingSpinner)}"></div>
            <div>${t}</div>
          </div>
          ${a}
        `}return n.mapRangeError?`<div style="${g(D.chartError)}">${ye(n.mapRangeError)}</div>`:!n.mapRangeSeries||!n.mapRangeSeries.length?`<div style="${g(D.chartEmpty)}">Click a location to load the range view.</div>`:`<div style="${g(D.mapRangeChartWrap)}">${Ia(n.mapRangeSeries,{compact:!0,unitLabel:e,paletteName:n.mapRangePalette,lightToDarkNoDarkest:!0})}</div>`}function np(){if(n.canvasView!=="map"||!n.mapRangeOpen||!n.mapMarker||n.mapPolygon!==null&&n.mapPolygon.length>=3)return"";const{variable:e}=jt(),a=`${pn(e,n.metaData)}`,r=n.sidebarOpen?Ee:0;return`
      <div id="map-range-overlay" style="${g({...D.mapRangeOverlay,right:r})}">
        <div style="${g(D.mapRangePanel)}">
          <div style="${g(D.mapRangeHeader)}">
            <div style="${g(D.mapRangeTitleGroup)}">
              <div class="map-range-title" style="${g(D.mapRangeTitle)}">${ye(a)}</div>
            </div>
            <div style="${g(D.mapInfoActions)}">
              ${za("mapRangePalette",n.mapRangePalette)}
              <button
                type="button"
                data-action="close-map-range"
                aria-label="Close range view"
                style="${g(D.mapInfoActionBtn)}"
                onmouseover="this.style.color='var(--text-primary)';this.style.background='rgba(15, 23, 42, 0.85)';"
                onmouseout="this.style.color='var(--text-secondary)';this.style.background='transparent';"
              >
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6 6l12 12M18 6l-12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </button>
            </div>
          </div>
          <div class="map-range-body" style="${g(D.mapRangeBody)}">
            ${as()}
          </div>
        </div>
      </div>
    `}function qo(){n.chartLocation="Draw",n.chartPolygon=null,n.chartLocationName=null,n.chartLocationSearchResults=[],n.chartLocationSearchQuery="",n.chartLocationSearchError=null,n.chartLocationSearchLoading=!1,n.chartError=null,n.pointSelectActive=!1,n.drawState={active:!0,points:[],previewPoint:null},n.canvasView="map",es(cs),W(),Ie()}function Ra(){n.drawState=Et(),Oa()}function ap(){n.canvasView==="map"&&(n.mapPolygon=null,n.mapMarker=null,n.mapInfoOpen=!1,Kr(),n.drawState={active:!0,points:[],previewPoint:null},n.pointSelectActive=!1,es(rs),W())}function rp(){n.drawState=Et(),Oa()}function rs(){if(n.drawState.active){if(n.drawState.points.length<3){n.mapInfoError="Draw at least three points to define a region.",n.mapInfoOpen=!0,W();return}n.mapPolygon=n.drawState.points,n.mapMarker=null,Kr(),n.drawState=Et(),Oa(),n.mapInfoError=null,n.mapInfoOpen=!0,W(),Ft()}}function zo(){n.chartLocation="Point",n.chartPolygon=null,n.chartPoint=null,n.chartLocationName=null,n.chartLocationSearchResults=[],n.chartLocationSearchQuery="",n.chartLocationSearchError=null,n.chartLocationSearchLoading=!1,n.chartError=null,n.drawState=Et(),n.chartUnit=Ne(n.chartVariable).label,n.pointSelectActive=!0,n.canvasView="map",W(),Ie()}function Pa(){n.pointSelectActive=!1}async function os(e){const t=e.trim();if(!t)return[];const a=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(t)}&limit=5&addressdetails=1`,r=await fetch(a,{headers:{Accept:"application/json","User-Agent":"climate-visualization-app/1.0"}});if(!r.ok)throw new Error("Location search failed. Please try again.");return(await r.json()).map(i=>({displayName:i.display_name,lat:Number(i.lat),lon:Number(i.lon)})).filter(i=>Number.isFinite(i.lat)&&Number.isFinite(i.lon))}async function op(e,t){const a=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e}&lon=${t}&addressdetails=1`,r=await fetch(a,{headers:{Accept:"application/json","User-Agent":"climate-visualization-app/1.0"}});return r.ok&&(await r.json()).display_name||null}function Ho(e){Ot!==null&&(window.clearTimeout(Ot),Ot=null),n.chartLocation="Search",n.chartPoint={lat:e.lat,lon:e.lon},n.chartLocationName=e.displayName,n.chartLocationSearchError=null,n.chartLocationSearchResults=[],n.chartLocationSearchLoading=!1,n.chartLocationSearchQuery="",n.chartError=null,n.chartPolygon=null,n.pointSelectActive=!1,n.drawState=Et(),n.canvasView="chart",Ra(),Pa(),W(),Ze()}async function ip(e){const t=e.trim(),a=++ta;if(n.chartLocation="Search",n.chartLocationSearchQuery=e,n.chartLocationSearchError=null,n.chartLocationSearchResults=[],n.chartLocationName=null,n.chartPoint=null,n.chartError=null,n.chartPolygon=null,n.pointSelectActive=!1,n.drawState=Et(),n.canvasView="chart",Ra(),Pa(),!t){n.chartLocationSearchLoading=!1,n.chartLocationSearchResults=[],n.chartLocationSearchError=null,W();return}n.chartLocationSearchLoading=!0,W();try{const r=await os(t);if(a!==ta)return;n.chartLocationSearchResults=r,r.length||(n.chartLocationSearchError="No places found for that query.")}catch(r){if(a!==ta)return;n.chartLocationSearchError=r instanceof Error?r.message:"Search failed."}finally{if(a!==ta)return;n.chartLocationSearchLoading=!1,W()}}function is(e,t,a){const[r,o]=Xn(e,t);n.mapMarker={lat:e,lon:t,name:a,pixel:{x:r,y:o}}}function sp(e){if(qt!==null&&(window.clearTimeout(qt),qt=null),n.mapLocationSearchError=null,n.mapLocationSearchResults=[],n.mapLocationSearchLoading=!1,n.mapLocationSearchQuery=e.displayName,n.mapLocationSearchSelection=e.displayName,n.mapLocationSearchFocused=!0,is(e.lat,e.lon,e.displayName),W(),ve){const t=Math.max(ji(),3.2);Ki(ve,e.lon,e.lat,t),Ea()}ss(),ls()}async function lp(e){const t=e.trim(),a=++na;if(n.mapLocationSearchQuery=e,n.mapLocationSearchError=null,n.mapLocationSearchResults=[],n.mapLocationSearchSelection=null,!t){n.mapLocationSearchLoading=!1,n.mapLocationSearchResults=[],n.mapLocationSearchError=null,W();return}n.mapLocationSearchLoading=!0,W();try{const r=await os(t);if(a!==na)return;n.mapLocationSearchResults=r,r.length||(n.mapLocationSearchError="No places found for that query.")}catch(r){if(a!==na)return;n.mapLocationSearchError=r instanceof Error?r.message:"Search failed."}finally{if(a!==na)return;n.mapLocationSearchLoading=!1,W()}}function cp(e){if(n.mapMarker&&(n.mapMarker.name=e),!ae)return;const t=ae.querySelector("#map-location-marker");if(t&&n.mapMarker&&(t.title=e),n.mapInfoOpen&&n.mapMarker){const a=ae.querySelector(".custom-select-info-panel-title");if(a){const{variable:r}=tt(),o=pn(r,n.metaData),l=`${e} · ${o}`;a.textContent=l}}if(n.mapRangeOpen&&n.mapMarker){const a=ae.querySelector(".map-range-title");if(a){const{variable:r}=jt(),o=pn(r,n.metaData),i=`${e} · ${o}`;a.textContent=i}}}async function dp(e){if(n.canvasView==="map"&&!(n.drawState.active||n.pointSelectActive)){if(n.mapPolygon=null,is(e.lat,e.lon,null),ve){const t=Math.max(ji(),3.2);Ki(ve,e.lon,e.lat,t),Ea()}ss(),ls();try{const t=await op(e.lat,e.lon);t&&cp(t)}catch(t){console.error("Failed to fetch reverse geocode:",t)}}}function ss(e=700){St!==null&&(window.clearTimeout(St),St=null);const t=n.mapInfoOpen;if(n.mapInfoOpen=!1,t&&ae){const a=ae.querySelector("#map-info-panel");a&&(a.style.opacity="0",a.style.transform="translate(-9999px, -9999px)",a.style.pointerEvents="none",a.style.visibility="hidden")}St=window.setTimeout(()=>{St=null;const a=n.mapMarker!==null,r=n.mapPolygon!==null&&n.mapPolygon.length>=3;!a&&!r||(n.mapInfoOpen=!0,W(),Ft())},e)}function up(){St!==null&&(window.clearTimeout(St),St=null),At+=1,n.mapInfoOpen=!1,n.mapInfoLoading=!1,W()}function or(e){n.mapInfoSamples=e;try{const{variable:a,unit:r}=tt();n.mapInfoBoxes=sn(e,a,r)}catch{return}if(!ae){W();return}const t=ae.querySelector("#map-info-panel");if(t){const a=t.querySelector(".map-info-body");if(a){a.innerHTML=ns();return}}W()}function ls(e=560){!n.mapMarker||n.mapPolygon||(Mt!==null&&(window.clearTimeout(Mt),Mt=null),Mt=window.setTimeout(()=>{if(Mt=null,!n.mapMarker||n.mapPolygon)return;const t=Qi(n.date);n.mapRangeStart=t.start,n.mapRangeEnd=t.end,n.mapRangeOpen=!0,W(),En()},e))}function Kr(){Mt!==null&&(window.clearTimeout(Mt),Mt=null),Nt+=1,n.mapRangeOpen=!1,n.mapRangeLoading=!1,n.mapRangeError=null,n.mapRangeSamples=[],n.mapRangeSeries=null,n.mapRangeLoadingProgress={total:0,done:0},W()}function fp(e){const{variable:t,unit:a}=jt();n.mapRangeSamples=e;try{n.mapRangeSeries=Tt(e,t,a)}catch{return}if(!ae){W();return}const r=ae.querySelector("#map-range-overlay");if(r){const o=r.querySelector(".map-range-body");if(o){o.innerHTML=as();return}}W()}async function En(){if(n.canvasView!=="map")return;const e=n.mapMarker!==null,t=n.mapPolygon!==null&&n.mapPolygon.length>=3;if(!e||t||!n.mapMarker){n.mapRangeLoading=!1,n.mapRangeError=null,n.mapRangeSamples=[],n.mapRangeSeries=null,n.mapRangeLoadingProgress={total:0,done:0},n.mapRangeOpen=!1,W();return}const a=++Nt,r=Qi(n.date),{variable:o,unit:i}=jt();n.mapRangeStart=r.start,n.mapRangeEnd=r.end,n.mapRangeLoading=!0,n.mapRangeError=null,n.mapRangeSamples=[],n.mapRangeSeries=null,n.mapRangeLoadingProgress={total:0,done:0},n.mapRangeOpen=!0,W();try{const l=n.metaData??await Ua();n.metaData||(n.metaData=l);const s=l?.scenarios?.length?Array.from(new Set(l.scenarios.map(Ke))):Re,c=l?.models?.length?l.models:Se,d=(n.chartScenarios.length?n.chartScenarios:s).filter(M=>s.includes(M)),u=(n.chartModels.length?n.chartModels:c).filter(M=>c.includes(M));if(!d.length||!u.length){n.mapRangeError="Select at least one scenario and one model.",n.mapRangeLoading=!1,n.mapRangeLoadingProgress={total:0,done:0},W();return}const f=d.length*u.length;n.mapRangeLoadingProgress={total:f,done:0},W();const m=[],p=us(r.start,r.end),v=r.start;for(const M of u)for(const S of d){if(a!==Nt)return;const x=await ms({variable:o,model:M,scenario:S,point:n.mapMarker,rangeStart:r.start,rangeEnd:r.end,useFixedAnnualSamples:p,fixedReferenceDate:v});if(a!==Nt)return;m.push(...x),n.mapRangeLoadingProgress={total:f,done:n.mapRangeLoadingProgress.done+1},fp(m)}if(a!==Nt)return;n.mapRangeSamples=m,n.mapRangeSeries=Tt(m,o,i),n.mapRangeLoadingProgress={total:f,done:f}}catch(l){if(a!==Nt)return;n.mapRangeError=l instanceof Error?l.message:"Failed to load range data.",n.mapRangeSamples=[],n.mapRangeSeries=null,n.mapRangeLoadingProgress={total:0,done:0}}finally{if(a!==Nt)return;n.mapRangeLoading=!1,W()}}async function Ft(){if(n.canvasView!=="map")return;const{variable:e}=tt(),t=n.mapMarker!==null,a=n.mapPolygon!==null&&n.mapPolygon.length>=3;if(!t&&!a){n.mapInfoLoading=!1,n.mapInfoError=null,n.mapInfoSamples=[],n.mapInfoBoxes=null,n.mapInfoLoadingProgress={total:0,done:0},n.mapInfoOpen=!1,W();return}const r=++At;n.mapInfoLoading=!0,n.mapInfoError=null,n.mapInfoSamples=[],n.mapInfoBoxes=null,n.mapInfoLoadingProgress={total:0,done:0},W();try{const o=n.metaData??await Ua();n.metaData||(n.metaData=o);const i=o?.scenarios?.length?Array.from(new Set(o.scenarios.map(Ke))):Re,l=i.filter(f=>Ca(n.date,qe(f))),s=l.length?l.includes("Historical")?["Historical"]:l:i,c=o?.models?.length?o.models:Se;if(!i.length||!c.length){n.mapInfoError="Select at least one scenario and one model.",n.mapInfoLoading=!1,n.mapInfoLoadingProgress={total:0,done:0},W();return}const d=s.length*c.length;n.mapInfoLoadingProgress={total:d,done:0},W();const u=[];for(const f of s){if(r!==At)return;const m=$e(n.date,qe(f));if(t&&n.mapMarker){const[p,v]=Xn(n.mapMarker.lat,n.mapMarker.lon),M=c.map(x=>Xr({variable:e,model:x,x0:p,x1:p,y0:v,y1:v,start_date:m,end_date:m,scenario:mt(f),resolution:"low",step_days:1}).catch(b=>{console.warn(`Pixel API failed for model ${x}, falling back:`,b);const T=we({variable:e,date:m,model:x,scenario:f,resolution:1});return Be(T).then(P=>{const R=_e(P);if(!R)throw new Error("No data returned for map info request.");const k=In(R,e,P.shape,{lat:n.mapMarker.lat,lon:n.mapMarker.lon});return{model:x,value:k,fallback:!0}})})),S=await Promise.allSettled(M);if(r!==At)return;for(const x of S)if(x.status==="fulfilled"){const b=x.value;if(typeof b=="object"&&"fallback"in b&&b.fallback)u.push({scenario:f,model:b.model,rawValue:b.value,dateUsed:m});else{const T=b,P=T.values[0];if(P!==null&&isFinite(P)){const R=e==="hurs"?Math.min(P,100):P;u.push({scenario:f,model:T.model,rawValue:R,dateUsed:m})}}}else console.warn("Failed to fetch pixel data for map info:",x.reason);n.mapInfoLoadingProgress={total:d,done:n.mapInfoLoadingProgress.done+c.length},or(u)}else if(a&&n.mapPolygon){const[p,v,M,S]=Dr(n.mapPolygon),x=Tr(n.mapPolygon,p,v,M,S);try{const b=await xr({variable:e,models:c,x0:p,x1:v,y0:M,y1:S,start_date:m,end_date:m,scenario:mt(f),resolution:"low",step_days:1,mask:x});for(const T of c){const P=b.models[T];if(P){const R=P.values[0];if(R!==null&&isFinite(R)){const k=e==="hurs"?Math.min(R,100):R;u.push({scenario:f,model:T,rawValue:k,dateUsed:m})}}}n.mapInfoLoadingProgress={total:d,done:n.mapInfoLoadingProgress.done+c.length},or(u)}catch(b){console.warn(`Aggregate API failed for scenario ${f}, falling back to full map load:`,b);for(const T of c){if(r!==At)return;const P=we({variable:e,date:m,model:T,scenario:f,resolution:1});try{const R=await Be(P),k=_e(R);if(k){const _=pa(k,e,R.shape,n.mapPolygon);u.push({scenario:f,model:T,rawValue:_,dateUsed:m})}}catch(R){console.warn(`Failed to load data for model ${T}:`,R)}n.mapInfoLoadingProgress={total:d,done:n.mapInfoLoadingProgress.done+1},or(u)}}}}if(r!==At)return;n.mapInfoLoading=!1,W()}catch(o){if(r!==At)return;n.mapInfoError=o instanceof Error?o.message:"Failed to load map chart data.",n.mapInfoLoading=!1,n.mapInfoLoadingProgress={total:0,done:0},W()}}function mp(e){n.drawState.active&&(n.drawState={...n.drawState,previewPoint:e},qa())}function pp(e){if(!n.drawState.active)return;const t=n.drawState.points;if(t.length>=3&&Qm(e,t[0])){n.canvasView==="chart"||n.chartLocation==="Draw"?cs():n.canvasView==="map"&&rs();return}n.drawState={...n.drawState,points:[...t,e],previewPoint:e},qa()}function hp(e){n.pointSelectActive&&(n.chartPoint=e,n.pointSelectActive=!1,n.chartError=null,n.canvasView="chart",W(),Ze())}function cs(){if(n.drawState.active){if(n.drawState.points.length<3){n.chartError="Draw at least three points to define a region.",W();return}n.chartPolygon=n.drawState.points,n.drawState=Et(),Oa(),n.chartError=null,n.canvasView="chart",W(),Ze()}}function ds(e){const t=e.filter(l=>Number.isFinite(l)).sort((l,s)=>l-s);if(!t.length)throw new Error("No valid values available to build chart statistics.");const a=Xa(t,.25)??t[0],r=Xa(t,.5)??t[Math.floor(t.length/2)],o=Xa(t,.75)??t[t.length-1],i=Es(t)??t[0];return{min:t[0],q1:a,median:r,q3:o,max:t[t.length-1],mean:i,count:t.length}}function sn(e,t,a){const r=new Map;return e.forEach(o=>{const i=r.get(o.scenario)??[];i.push(o),r.set(o.scenario,i)}),Array.from(r.entries()).map(([o,i])=>{const l=i.map(c=>{const d=Ht(c.rawValue,t,a);return{...c,value:d}}),s=ds(l.map(c=>c.value));return{scenario:o,dateUsed:i[0]?.dateUsed??"",samples:l,stats:s}})}function gp(e,t,a=50){const r=ne(e),o=ne(t);if(Number.isNaN(r.getTime())||Number.isNaN(o.getTime())||a<=0)return[];let i=r,l=o;i>l&&([i,l]=[l,i]);const s=1440*60*1e3,d=Math.floor((l.getTime()-i.getTime())/s)+1,u=[];if(d<=a){for(let p=0;p<d;p++){const v=new Date(i.getTime()+p*s);u.push(v.toISOString().slice(0,10))}return u}const f=(l.getTime()-i.getTime())/(a-1),m=new Set;for(let p=0;p<a;p++){const v=new Date(i.getTime()+f*p);m.add(v.toISOString().slice(0,10))}return m.add(l.toISOString().slice(0,10)),Array.from(m).sort((p,v)=>ne(p).getTime()-ne(v).getTime())}function $r(e,t,a=50){const r=ne(e),o=ne(t);if(Number.isNaN(r.getTime())||Number.isNaN(o.getTime())||a<=0)return[];let i=r,l=o;i>l&&([i,l]=[l,i]);const s=1440*60*1e3,c=Math.floor((l.getTime()-i.getTime())/s),d=l.getFullYear()-i.getFullYear();if(c<=120)return gp(i.toISOString().slice(0,10),l.toISOString().slice(0,10),a);const u=i.getDate(),f=i.getMonth(),m=i.getFullYear(),p=l.getFullYear(),v=p-m+1,M=Math.min(a,v),S=new Set;if(M===1)S.add(m);else{const T=(v-1)/(M-1);for(let P=0;P<M;P++){const R=Math.round(m+T*P);S.add(Math.min(p,Math.max(m,R)))}}const x=[];return Array.from(S).sort((T,P)=>T-P).forEach(T=>{const P=new Date(T,f+1,0).getDate(),R=Math.min(u,P),k=new Date(T,f,R);if(d>=20){if(k<i||k>l)return;x.push(k.toISOString().slice(0,10));return}let _=k;k<i&&(_=i),k>l&&(_=l),x.push(_.toISOString().slice(0,10))}),Array.from(new Set(x)).sort((T,P)=>ne(T).getTime()-ne(P).getTime())}function us(e,t){const a=ne(e),r=ne(t);if(Number.isNaN(a.getTime())||Number.isNaN(r.getTime()))return!1;const o=1440*60*1e3;return Math.abs(r.getTime()-a.getTime())/o/365.25>=20}function fs(e,t){const a=ne(t),r=ne(e);return Number.isNaN(a.getTime())||Number.isNaN(r.getTime())?!1:r.getMonth()===a.getMonth()&&r.getDate()===a.getDate()}function Ca(e,t){const a=ne(e),r=ne(t.start),o=ne(t.end);return Number.isNaN(a.getTime())||Number.isNaN(r.getTime())||Number.isNaN(o.getTime())?!1:a>=r&&a<=o}function kr(e,t,a,r=50){const o=ne(e),i=ne(t),l=ne(a);if(Number.isNaN(o.getTime())||Number.isNaN(i.getTime())||Number.isNaN(l.getTime())||r<=0)return[];const s=o.getMonth(),c=o.getDate(),d=i.getFullYear(),u=l.getFullYear(),f=u-d+1,m=Math.min(r,f),p=new Set;if(m===1)p.add(d);else{const S=(f-1)/(m-1);for(let x=0;x<m;x++){const b=Math.round(d+S*x);p.add(Math.min(u,Math.max(d,b)))}}const v=[];return Array.from(p).sort((S,x)=>S-x).forEach(S=>{const x=new Date(S,s+1,0).getDate(),b=Math.min(c,x),T=new Date(S,s,b);T<i||T>l||v.push(T.toISOString().slice(0,10))}),Array.from(new Set(v)).sort((S,x)=>ne(S).getTime()-ne(x).getTime())}async function ms(e){const{variable:t,model:a,scenario:r,point:o,rangeStart:i,rangeEnd:l,useFixedAnnualSamples:s,fixedReferenceDate:c}=e,d=qe(r),u=$e(i,d),f=$e(l,d);if(ne(u)>ne(f))return[];try{const[m,p]=Xn(o.lat,o.lon),v=await Xr({variable:t,model:a,x0:m,x1:m,y0:p,y1:p,start_date:u,end_date:f,scenario:mt(r),resolution:"low",step_days:1}),M=[];for(let S=0;S<v.timestamps.length;S++){const x=v.timestamps[S];if(s&&!fs(x,c))continue;const b=v.values[S];if(b!==null&&isFinite(b)){const T=t==="hurs"?Math.min(b,100):b;M.push({scenario:r,model:a,rawValue:T,dateUsed:x})}}return M}catch(m){console.warn("Range point pixel API failed, falling back:",m);const p=s?kr(c,u,f,50):$r(u,f,50),v=[];for(const M of p){const S=s?M:$e(M,d);if(s&&!Ca(S,d))continue;const x=we({variable:t,date:S,model:a,scenario:r,resolution:1});let b=null;try{b=await Be(x)}catch(R){console.warn("Range point request failed, skipping date:",R);continue}const T=_e(b);if(!T)continue;const P=In(T,t,b.shape,o);v.push({scenario:r,model:a,rawValue:P,dateUsed:S})}return v}}function Tt(e,t,a){const r=new Map;return e.forEach(o=>{const i=r.get(o.scenario)??[];i.push(o),r.set(o.scenario,i)}),Array.from(r.entries()).map(([o,i])=>{const l=new Map;i.forEach(c=>{const d=Ht(c.rawValue,t,a),u=l.get(c.dateUsed)??[];u.push({...c,value:d}),l.set(c.dateUsed,u)});const s=Array.from(l.entries()).map(([c,d])=>({date:c,samples:d,stats:ds(d.map(u=>u.value))})).sort((c,d)=>ne(c.date).getTime()-ne(d.date).getTime());return{scenario:o,points:s}})}function yp(e,t,a,r){const o=_e(e),i=_e(t);if(!o||!i)throw new Error("Comparison data is missing numeric values.");if(o.length!==i.length||e.shape[0]!==t.shape[0]||e.shape[1]!==t.shape[1])throw new Error("Comparison datasets have mismatched shapes.");const l=new Float32Array(o.length);let s=1/0,c=-1/0,d=0,u=0;for(let p=0;p<o.length;p++){const v=o[p],M=i[p];if(!isFinite(v)||!isFinite(M)){l[p]=NaN;continue}const S=M-v;l[p]=S,isFinite(S)&&(s=Math.min(s,S),c=Math.max(c,S),d+=S,u+=1)}if(!isFinite(s)||!isFinite(c))throw new Error("Comparison produced no valid numeric values.");const f=u>0?d/u:NaN;return{data:{...e,data:l,data_encoding:"none",dtype:"float32",model:`${r} minus ${a}`,time:`${t.time} minus ${e.time}`,scenario:`${t.scenario} minus ${e.scenario}`,metadata:{...e.metadata,comparison:{labelA:a,labelB:r}}},min:s,max:c,mean:f}}function he(e,t=!1){const a=Math.max(0,Math.min(100,Math.round(e)));a!==n.loadingProgress&&(n.loadingProgress=a,(n.isLoading||t)&&W())}async function bp(e,t){let a=we({variable:n.variable,date:n.date,model:n.model,scenario:n.scenario,resolution:n.resolution}),r=a,o="",i="";switch(n.compareMode){case"Scenarios":{const c=n.compareScenarioA,d=n.compareScenarioB,u=Je(n.date,e);u!==n.date&&(n.date=u),a=we({variable:n.variable,date:u,model:n.model,scenario:c,resolution:n.resolution}),r=we({variable:n.variable,date:u,model:n.model,scenario:d,resolution:n.resolution}),o=c,i=d;break}case"Models":{const c=Je(n.date,e);c!==n.date&&(n.date=c),a=we({variable:n.variable,date:c,model:n.compareModelA,scenario:n.scenario,resolution:n.resolution}),r=we({variable:n.variable,date:c,model:n.compareModelB,scenario:n.scenario,resolution:n.resolution}),o=n.compareModelA,i=n.compareModelB;break}case"Dates":{const c=Je(n.compareDateStart,n.scenario),d=Je(n.compareDateEnd,n.scenario);c!==n.compareDateStart&&(n.compareDateStart=c),d!==n.compareDateEnd&&(n.compareDateEnd=d),a=we({variable:n.variable,date:c,model:n.model,scenario:n.scenario,resolution:n.resolution}),r=we({variable:n.variable,date:d,model:n.model,scenario:n.scenario,resolution:n.resolution}),o=c,i=d;break}}const l=await Be(a);t?.(65);const s=await Be(r);return t?.(85),yp(l,s,o,i)}function Mn(e,t){if(e.length===0)return NaN;if(e.length===1)return e[0];const a=t/100*(e.length-1),r=Math.floor(a),o=Math.ceil(a),i=a-r;return r===o?e[r]:e[r]*(1-i)+e[o]*i}async function vp(e){const t=n.ensembleScenarios.length>0?n.ensembleScenarios:Re.filter(z=>z!=="Historical"),a=n.ensembleModels.length>0?n.ensembleModels:Se;if(t.length===0||a.length===0)throw new Error("Please select at least one scenario and one model.");const r=mn(t),o=$e(n.ensembleDate,r);o!==n.ensembleDate&&(n.ensembleDate=o);const i=new Map,l=new Map,s=new Map,c=new Map,d=(z,U)=>{c.has(z)||c.set(z,new Set),c.get(z).add(U)};if(d(n.ensembleVariable,n.ensembleStatistic),n.masks&&n.masks.length>0)for(const z of n.masks)d(z.variable||n.ensembleVariable,z.statistic||"mean");const u=Array.from(c.keys()),f=t.length*a.length,m=Math.max(1,f*u.length);let p=0;e?.(10);for(const z of u){const U=c.get(z),te=[],J=[];for(let A=0;A<t.length;A++){const H=t[A];for(let G=0;G<a.length;G++){const h=a[G],y=we({variable:z,date:o,model:h,scenario:H,resolution:n.resolution});try{const $=await Be(y),N=_e($);N&&(te.push(N),J.push($.shape))}catch($){console.warn(`Failed to fetch data for ${z} (${H}/${h}):`,$)}finally{p+=1;const $=10+Math.round(p/m*78);e?.(Math.min(88,$))}}}if(te.length===0){if(z===n.ensembleVariable)throw new Error("No valid data could be loaded for the selected scenarios and models.");continue}s.set(z,te);const w=J[0];for(let A=1;A<J.length;A++)if(J[A][0]!==w[0]||J[A][1]!==w[1])throw new Error("Ensemble datasets have mismatched shapes. Cannot compute statistics.");const q=te[0].length,I=new Map,X=new Map;for(const A of U)I.set(A,new Float32Array(q)),X.set(A,{min:1/0,max:-1/0});for(let A=0;A<q;A++){const H=[];for(const y of te){const $=y[A];isFinite($)&&H.push(z==="hurs"?Math.min($,100):$)}if(H.length===0){for(const y of U)I.get(y)[A]=NaN;continue}const G=U.has("median")||U.has("iqr")||U.has("percentile")?[...H].sort((y,$)=>y-$):null,h=U.has("mean")||U.has("std")?H.reduce((y,$)=>y+$,0)/H.length:0;for(const y of U){let $;if(y==="mean")$=h;else if(y==="median")$=Mn(G,50);else if(y==="std"){const N=H.reduce((F,B)=>F+Math.pow(B-h,2),0)/H.length;$=Math.sqrt(N)}else if(y==="iqr"){const N=Mn(G,75),F=Mn(G,25);$=N-F}else if(y==="percentile"){const N=Mn(G,90),F=Mn(G,10);$=N-F}else y==="extremes"?$=Math.max(...H)-Math.min(...H):$=h;if(I.get(y)[A]=$,isFinite($)){const N=X.get(y);N.min=Math.min(N.min,$),N.max=Math.max(N.max,$)}}}i.set(z,I),l.set(z,X)}e?.(90);const v=i.get(n.ensembleVariable),M=v?.get(n.ensembleStatistic);if(!v||!M)throw new Error("Unable to compute ensemble statistics for the selected variable.");let S=1/0,x=-1/0,b=0,T=0;for(let z=0;z<M.length;z++){const U=M[z];isFinite(U)&&(S=Math.min(S,U),x=Math.max(x,U),b+=U,T+=1)}if(n.ensembleStatistics=v,n.ensembleStatisticRanges=l.get(n.ensembleVariable)??new Map,n.ensembleStatisticsByVariable=i,n.ensembleStatisticRangesByVariable=l,n.ensembleRawSamplesByVariable=s,n.masks.length>0)for(const z of n.masks){const U=z.statistic||"mean",te=z.variable||n.ensembleVariable,J=z.unit||n.ensembleUnit,w=z.kind==="probability"?Dt(te,J):kt(U,te,J);z.lowerEdited||(z.lowerBound=w.min),z.upperEdited||(z.upperBound=w.max)}if(!isFinite(S)||!isFinite(x))throw new Error("Ensemble computation produced no valid numeric values.");const P=T>0?b/T:NaN,R=we({variable:n.ensembleVariable,date:o,model:a[0],scenario:t[0],resolution:n.resolution}),k=await Be(R),Y=jr(n.ensembleStatistic)?{...k.metadata||{},comparison:{labelA:"Ensemble",labelB:n.ensembleStatistic==="std"?"Std Dev":n.ensembleStatistic==="median"?"Median":n.ensembleStatistic==="iqr"?"IQR":n.ensembleStatistic==="percentile"?"Percentile Band":"Extremes"}}:k.metadata,K={...k,data:M,data_encoding:"none",metadata:Y};return e?.(100),{data:K,min:S,max:x,mean:P}}const Fn=600,Un=1440;function Xn(e,t){const r=((t+360)%360+360)%360/360*Un-.5,o=(90-e)/150*Fn-.5,i=(c,d,u)=>Math.min(u,Math.max(d,c)),l=i(Math.round(r),0,Un-1),s=i(Math.round(o),0,Fn-1);return[l,s]}function Dr(e){if(!e||e.length<3)throw new Error("Polygon must have at least 3 points");let t=1/0,a=-1/0,r=1/0,o=-1/0;for(const i of e){const[l,s]=Xn(i.lat,i.lon);t=Math.min(t,l),a=Math.max(a,l),r=Math.min(r,s),o=Math.max(o,s)}return t=Math.max(0,Math.min(t,Un-1)),a=Math.max(0,Math.min(a,Un-1)),r=Math.max(0,Math.min(r,Fn-1)),o=Math.max(0,Math.min(o,Fn-1)),[t,a,r,o]}function Tr(e,t,a,r,o){const i=[],l=360/Un,s=150/Fn;for(let c=r;c<=o;c++){const d=[],u=90-(c+.5)*s;for(let f=t;f<=a;f++){const m=(f+.5)*l,p=m>180?m-360:m,v=Ji({lat:u,lon:p},e);d.push(v?1:0)}i.push(d)}return i}function Ue(){const e=document.querySelector("[data-role='chart-container']");if(!e)return;const t=n.chartMode==="range",a=!0;let r="";if(n.chartLoading)r=`
          <div style="position:absolute; inset:0; pointer-events:none;">
            <div style="${g(De(D.loadingIndicator,{position:"absolute",left:18,bottom:-95,pointerEvents:"auto"}))}">
              <div style="${g(D.loadingSpinner)}"></div>
              <div style="${g(D.loadingTextGroup)}">
                <div style="${g(D.loadingText)}">Loading data</div>
                <div style="${g(D.loadingBar)}">
                  <div style="${g({...D.loadingBarFill,width:`${Math.max(0,Math.min(100,Math.round(n.loadingProgress||25)))}%`})}"></div>
                </div>
                <div style="${g(D.loadingSubtext)}">${n.chartLoadingProgress.total>0?`${n.chartLoadingProgress.done}/${n.chartLoadingProgress.total} datasets loaded`:"Preparing datasets"}</div>
              </div>
            </div>
            ${Mp()}
          </div>
          ${!t&&n.chartBoxes?Wo(n.chartBoxes,{lightToDarkNoDarkest:a}):t&&n.chartRangeSeries?Ia(n.chartRangeSeries,{lightToDarkNoDarkest:a}):""}
        `;else if(n.chartError)r=`<div style="${g(D.chartError)}">${n.chartError}</div>`;else if(!t&&(!n.chartBoxes||!n.chartBoxes.length)||t&&(!n.chartRangeSeries||!n.chartRangeSeries.length)){const s=t?"Select scenarios, models, and a date range to see how the distribution evolves over time.":"Select scenarios and models to fetch the global box plot.";r=`<div style="${g(D.chartEmpty)}">${s}</div>`}else r=t?Ia(n.chartRangeSeries??[],{lightToDarkNoDarkest:a}):Wo(n.chartBoxes??[],{lightToDarkNoDarkest:a});const o=n.chartLocationName||(n.chartLocation==="Point"&&n.chartPoint?`Point (${n.chartPoint.lat.toFixed(2)}, ${n.chartPoint.lon.toFixed(2)})`:n.chartLocation==="Draw"?"Custom region":n.chartLocation==="World"?"Global":""),i=n.chartMode==="range"?`${$t(n.chartRangeStart)} – ${$t(n.chartRangeEnd)}`:$t(n.chartDate);e.innerHTML=`
        <div style="${g(D.chartPanel)}">
          <div style="${g(D.chartHeader)}">
            <div style="${g(D.chartTitle)}">${pn(n.chartVariable,n.metaData)}</div>
            <div style="${g(D.mapSubtitle)}">${o?`${ye(o)} · ${i}`:i}</div>
          </div>
          <div style="${g(De(D.chartPlotWrapper,{display:"flex",alignItems:"center",justifyContent:"center"}))}">
            ${r}
          </div>
        </div>
      `;const l=e.querySelectorAll('.overlay-palette-wrapper[data-key="chartPalette"]');l.forEach(s=>{const c=s.querySelector(".overlay-palette-trigger"),d=s.querySelectorAll(".custom-select-option");!c||d.length===0||(c.addEventListener("click",u=>{u.preventDefault(),u.stopPropagation();const f=s.classList.contains("open");l.forEach(m=>m.classList.remove("open")),s.classList.toggle("open",!f)}),d.forEach(u=>{u.addEventListener("click",f=>{f.preventDefault(),f.stopPropagation();const m=u.dataset.value;m&&(n.chartPalette=m,l.forEach(p=>p.classList.remove("open")),Ue())})}))}),!t&&n.chartBoxes&&n.chartBoxes.length>0&&setTimeout(()=>{xp()},0)}function xp(){const e=document.querySelector("[data-role='chart-container'] .boxplot-hover-overlay");if(!e)return;const t=e.closest("svg");if(!t)return;const a=t.querySelectorAll(".boxplot-hover-area"),r=t.querySelectorAll(".model-indicator");a.length!==0&&(r.forEach(o=>{o.style.opacity="0"}),a.forEach(o=>{const i=o.closest(".boxplot-group");if(!i)return;const l=i.getAttribute("data-boxplot-idx");l!==null&&(o.addEventListener("mouseenter",()=>{e.style.opacity="1",e.style.pointerEvents="auto",r.forEach(s=>{const c=s;c.getAttribute("data-boxplot-idx")===l?c.style.opacity="1":c.style.opacity="0"})}),o.addEventListener("mouseleave",()=>{e.style.opacity="0",e.style.pointerEvents="none",r.forEach(s=>{s.style.opacity="0"})}))}))}async function Ze(){if(n.canvasView!=="chart")return;const e=t=>{if(n.chartSamples=t,n.chartMode==="single")try{n.chartBoxes=sn(t,n.chartVariable,n.chartUnit),n.chartRangeSeries=null}catch{return}else try{n.chartRangeSeries=Tt(t,n.chartVariable,n.chartUnit),n.chartBoxes=null}catch{return}Ue()};if(n.chartLocation==="Draw"&&(!n.chartPolygon||n.chartPolygon.length<3)){n.chartError="Draw a region on the map to load chart data.",n.chartBoxes=null,n.chartRangeSeries=null,n.chartSamples=[],n.chartLoading=!1,n.chartLoadingProgress={total:0,done:0},Ue();return}if(n.chartLocation==="Point"&&!n.chartPoint){n.chartError="Click a point on the map to load chart data.",n.chartBoxes=null,n.chartRangeSeries=null,n.chartSamples=[],n.chartLoading=!1,n.chartLoadingProgress={total:0,done:0},Ue();return}if(n.chartLocation==="Search"&&!n.chartPoint){n.chartError=n.chartLocationSearchLoading?"Searching for a place...":"Search for a place and pick a result.",n.chartBoxes=null,n.chartRangeSeries=null,n.chartSamples=[],n.chartLoading=!1,n.chartLoadingProgress={total:0,done:0},Ue();return}n.chartLoading=!0,n.chartError=null,he(5,!0),n.chartLoadingProgress={total:0,done:0},n.chartSamples=[],n.chartBoxes=null,n.chartRangeSeries=null,Ue();try{const t=n.metaData??await Ua();n.metaData||(n.metaData=t);const a=t?.scenarios?.length?Array.from(new Set(t.scenarios.map(Ke))):Re,r=t?.models?.length?t.models:Se,o=(n.chartScenarios.length?n.chartScenarios:a).filter(s=>a.includes(s)),i=(n.chartModels.length?n.chartModels:r).filter(s=>r.includes(s));if(!o.length||!i.length){n.chartError="Select at least one scenario and one model.",n.chartSamples=[],n.chartBoxes=null,n.chartRangeSeries=null,n.chartLoading=!1,n.chartLoadingProgress={total:0,done:0},Ue();return}const l=mn(o);if(n.chartMode==="single"){const s=$e(n.chartDate,l);s!==n.chartDate&&(n.chartDate=s);const c=o.length*i.length;n.chartLoadingProgress={total:c,done:0},n.chartRangeSeries=null,Ue();const d=[];if((n.chartLocation==="Point"||n.chartLocation==="Search")&&n.chartPoint?!0:n.chartLocation==="Draw"&&n.chartPolygon&&n.chartPolygon.length>=3){console.log("Using pixel-data API for efficient loading");for(const f of o){const m=$e(n.chartDate,qe(f));try{if((n.chartLocation==="Point"||n.chartLocation==="Search")&&n.chartPoint){const[p,v]=Xn(n.chartPoint.lat,n.chartPoint.lon);console.log(`Fetching pixel data for point (${p}, ${v}) for ${i.length} models`);const M=i.map(x=>Xr({variable:n.chartVariable,model:x,x0:p,x1:p,y0:v,y1:v,start_date:m,end_date:m,scenario:mt(f),resolution:"low",step_days:1}).catch(b=>{if(console.warn(`Pixel API failed for model ${x}, falling back:`,b),!n.chartPoint)throw b;const T=we({variable:n.chartVariable,date:m,model:x,scenario:f,resolution:1});return Be(T).then(P=>{const R=_e(P);if(!R)throw new Error("No data returned for chart request.");if(!n.chartPoint)throw new Error("No chart point selected");const k=In(R,n.chartVariable,P.shape,n.chartPoint);return{model:x,value:k,fallback:!0}})})),S=await Promise.allSettled(M);for(const x of S)if(x.status==="fulfilled"){const b=x.value;if(typeof b=="object"&&"fallback"in b&&b.fallback)d.push({scenario:f,model:b.model,rawValue:b.value,dateUsed:m});else{const T=b,P=T.values[0];if(P!==null&&isFinite(P)){const R=n.chartVariable==="hurs"?Math.min(P,100):P;d.push({scenario:f,model:T.model,rawValue:R,dateUsed:m})}}}else console.warn("Failed to fetch pixel data:",x.reason);n.chartLoadingProgress={total:c,done:n.chartLoadingProgress.done+i.length},he(Math.min(98,Math.round(n.chartLoadingProgress.done/c*100))),e(d)}else if(n.chartLocation==="Draw"&&n.chartPolygon&&n.chartPolygon.length>=3){const[p,v,M,S]=Dr(n.chartPolygon),x=Tr(n.chartPolygon,p,v,M,S);console.log(`Fetching aggregate data for polygon window [${p},${v},${M},${S}] for ${i.length} models`);try{const b=await xr({variable:n.chartVariable,models:i,x0:p,x1:v,y0:M,y1:S,start_date:m,end_date:m,scenario:mt(f),resolution:"low",step_days:1,mask:x});for(const T of i){const P=b.models[T];if(P){const R=P.values[0];if(R!==null&&isFinite(R)){const k=n.chartVariable==="hurs"?Math.min(R,100):R;d.push({scenario:f,model:T,rawValue:k,dateUsed:m})}}}n.chartLoadingProgress={total:c,done:n.chartLoadingProgress.done+i.length},he(Math.min(98,Math.round(n.chartLoadingProgress.done/c*100))),e(d)}catch(b){console.warn("Batch aggregate API failed, falling back to full map load:",b);for(const T of i){const P=we({variable:n.chartVariable,date:m,model:T,scenario:f,resolution:1}),R=await Be(P),k=_e(R);if(!k)continue;const _=pa(k,n.chartVariable,R.shape,n.chartPolygon);d.push({scenario:f,model:T,rawValue:_,dateUsed:m})}e(d)}}}catch(p){throw console.error("Error in pixel API path:",p),p}}}else for(const f of o){const m=$e(n.chartDate,qe(f));for(const p of i){const v=n.chartLoadingProgress.done;he(Math.min(95,Math.round((v+.1)/c*100)));const M=we({variable:n.chartVariable,date:m,model:p,scenario:f,resolution:1}),S=await Be(M),x=n.chartLoadingProgress.done+1;n.chartLoadingProgress={total:c,done:x},he(Math.min(98,Math.round(x/c*100))),e(d);const b=_e(S);if(!b)throw new Error("No data returned for chart request.");const T=ma(b,n.chartVariable);d.push({scenario:f,model:p,rawValue:T,dateUsed:m})}}n.chartSamples=d,n.chartBoxes=sn(d,n.chartVariable,n.chartUnit),n.chartLoadingProgress={total:c,done:c},he(100)}else{let s=$e(n.chartRangeStart,l),c=$e(n.chartRangeEnd,l);ne(s)>ne(c)&&([s,c]=[c,s]),n.chartRangeStart=s,n.chartRangeEnd=c;const d=us(s,c),u=s;if(!Um)if((n.chartLocation==="Point"||n.chartLocation==="Search")&&n.chartPoint?!0:n.chartLocation==="Draw"&&n.chartPolygon&&n.chartPolygon.length>=3){console.log("Using pixel-data API for range mode");const m=o.length*i.length;n.chartLoadingProgress={total:m,done:0},n.chartBoxes=null,Ue();const p=[];for(const v of i)for(const M of o){const S=qe(M),x=$e(s,S),b=$e(c,S);if(ne(x)>ne(b))continue;const T=n.chartLoadingProgress.done;he(Math.min(95,Math.round((T+.1)/m*100)));try{if((n.chartLocation==="Point"||n.chartLocation==="Search")&&n.chartPoint){const R=await ms({variable:n.chartVariable,model:v,scenario:M,point:n.chartPoint,rangeStart:s,rangeEnd:c,useFixedAnnualSamples:d,fixedReferenceDate:u});p.push(...R),e(p)}else if(n.chartLocation==="Draw"&&n.chartPolygon&&n.chartPolygon.length>=3){const[R,k,_,Y]=Dr(n.chartPolygon),K=Tr(n.chartPolygon,R,k,_,Y),U=(await xr({variable:n.chartVariable,models:[v],x0:R,x1:k,y0:_,y1:Y,start_date:x,end_date:b,scenario:mt(M),resolution:"low",step_days:1,mask:K})).models[v];if(U)for(let te=0;te<U.timestamps.length;te++){const J=U.timestamps[te];if(d&&!fs(J,u))continue;const w=U.values[te];if(w!==null&&isFinite(w)){const q=n.chartVariable==="hurs"?Math.min(w,100):w;p.push({scenario:M,model:v,rawValue:q,dateUsed:J})}}e(p)}}catch(R){console.warn("Pixel API failed, falling back to full map load:",R);const k=d?kr(u,x,b,50):$r(x,b,50);for(const _ of k){const Y=d?_:$e(_,S);if(d&&!Ca(Y,S))continue;const K=we({variable:n.chartVariable,date:Y,model:v,scenario:M,resolution:1});let z=null;try{z=await Be(K)}catch(J){console.warn("Range fallback request failed, skipping date:",J);continue}const U=_e(z);if(!U)continue;const te=n.chartLocation==="Draw"&&n.chartPolygon&&n.chartPolygon.length>=3?pa(U,n.chartVariable,z.shape,n.chartPolygon):(n.chartLocation==="Point"||n.chartLocation==="Search")&&n.chartPoint?In(U,n.chartVariable,z.shape,n.chartPoint):ma(U,n.chartVariable);p.push({scenario:M,model:v,rawValue:te,dateUsed:Y})}e(p)}const P=n.chartLoadingProgress.done+1;n.chartLoadingProgress={total:m,done:P},he(Math.min(98,Math.round(P/m*100))),e(p)}n.chartSamples=p,n.chartRangeSeries=Tt(p,n.chartVariable,n.chartUnit),n.chartLoadingProgress={total:m,done:m},he(100)}else{const m=d?kr(u,s,c,50):$r(s,c,50);if(!m.length){n.chartError="Enter a valid date range within the selected scenarios.",n.chartSamples=[],n.chartBoxes=null,n.chartRangeSeries=null,n.chartLoading=!1,n.chartLoadingProgress={total:0,done:0},Ue();return}const p=o.length*i.length*m.length;n.chartLoadingProgress={total:p,done:0},n.chartBoxes=null,Ue();const v=[];for(const M of i)for(const S of o){const x=qe(S);for(const b of m){const T=d?b:$e(b,x);if(d&&!Ca(T,x))continue;const P=n.chartLoadingProgress.done;he(Math.min(95,Math.round((P+.1)/p*100)));const R=we({variable:n.chartVariable,date:T,model:M,scenario:S,resolution:1});let k=null;try{k=await Be(R)}catch(z){console.warn("Range request failed, skipping date:",z);continue}const _=n.chartLoadingProgress.done+1;n.chartLoadingProgress={total:p,done:_},he(Math.min(98,Math.round(_/p*100))),e(v);const Y=_e(k);if(!Y)throw new Error("No data returned for chart request.");const K=n.chartLocation==="Draw"&&n.chartPolygon&&n.chartPolygon.length>=3?pa(Y,n.chartVariable,k.shape,n.chartPolygon):(n.chartLocation==="Point"||n.chartLocation==="Search")&&n.chartPoint?In(Y,n.chartVariable,k.shape,n.chartPoint):ma(Y,n.chartVariable);v.push({scenario:S,model:M,rawValue:K,dateUsed:T})}}n.chartSamples=v,n.chartRangeSeries=Tt(v,n.chartVariable,n.chartUnit),n.chartLoadingProgress={total:p,done:p},he(100)}}}catch(t){n.chartError=t instanceof Fe&&t.statusCode||t instanceof Error?t.message:String(t),n.chartSamples=[],n.chartBoxes=null,n.chartRangeSeries=null,n.chartLoadingProgress={total:1,done:1}}finally{n.chartLoading=!1,Ue()}}async function Ie(){if(n.__updatingMask){console.log("Skipping loadClimateData - mask update in progress");return}if(console.log("fetching"),n.canvasView!=="map")return;const e=++aa;n.isLoading=!0,he(5,!0),n.dataError=null;try{const t=await Ua();n.metaData=t,n.availableModels=t.models,he(20);let a=n.scenario;n.mode==="Compare"&&n.compareMode==="Scenarios"?a=n.compareScenarioA:n.mode==="Ensemble"&&(a=n.ensembleScenarios.length>0?n.ensembleScenarios[0]:n.scenario),n.timeRange=qe(a),he(30);const r=n.mode==="Compare"?await bp(a,he):n.mode==="Ensemble"?await vp(he):await(async()=>{he(40);const o=Je(n.date,a);o!==n.date&&(n.date=o);const i=we({variable:n.variable,date:o,model:n.model,scenario:n.scenario,resolution:n.resolution});he(55);let l=await Be(i);he(80);let s=_e(l);if(!s)throw new Error("No data returned for the selected parameters.");if(n.variable==="hurs"){const f=new Float32Array(s.length);let m=1/0,p=-1/0,v=0,M=0;for(let x=0;x<s.length;x++){const b=s[x];if(!isFinite(b)){f[x]=NaN;continue}const T=Math.min(b,100);f[x]=T,m=Math.min(m,T),p=Math.max(p,T),v+=T,M+=1}const S=M>0?v/M:NaN;return l={...l,data:f,data_encoding:"none"},s=f,{data:l,min:m,max:p,mean:S}}const{min:c,max:d}=Uo(s),u=ma(s,n.variable);return he(95),{data:l,min:c,max:d,mean:u}})();if(e!==aa)return;if(n.currentData=r.data,n.dataMin=r.min,n.dataMax=r.max,n.dataMean=r.mean,n.mode==="Explore"&&n.masks&&n.masks.length>0){const o=Je(n.date,a),i=new Set;for(const l of n.masks)l.variable&&l.variable!==n.variable&&i.add(l.variable);n.maskVariableData.clear(),n.maskVariableRanges.clear();for(const l of i)try{const s=we({variable:l,date:o,model:n.model,scenario:n.scenario,resolution:n.resolution}),c=await Be(s);let d=_e(c);if(l==="hurs")if(d){const u=new Float32Array(d.length);for(let f=0;f<d.length;f++){const m=d[f];isFinite(m)?u[f]=Math.min(m,100):u[f]=NaN}d=u,n.maskVariableData.set(l,{...c,data:u,data_encoding:"none"})}else n.maskVariableData.set(l,c);else n.maskVariableData.set(l,c);if(d){const{min:u,max:f}=Uo(d);n.maskVariableRanges.set(l,{min:u,max:f})}}catch(s){console.warn(`Failed to load data for mask variable ${l}:`,s)}}if(e!==aa)return;if(he(100),n.isLoading=!1,W(),ae){const o=ae.querySelector("#map-canvas");o&&_n(o)}}catch(t){if(e!==aa)return;t instanceof Fe&&t.statusCode?n.dataError=t.message:n.dataError=t instanceof Error?t.message:String(t),n.isLoading=!1,he(0,!0),n.currentData=null,n.dataMin=null,n.dataMax=null,n.dataMean=null,W()}}function wp(){return`
      <div style="${g(D.branding)}">
        <div data-role="brand-eye" style="${g(D.brandIcon)}">
          <svg viewBox="0 0 120 80" style="${g(D.brandSvg)}" aria-hidden="true">
            <defs>
              <clipPath id="brand-eye-clip">
                <rect x="0" y="0" width="120" height="80" style="${g(D.brandClipRect)}" />
              </clipPath>
            </defs>
            <g style="${g(D.brandLids)}">
              <path
                d="M10 40c10-15 30-30 50-30s40 15 50 30c-10 15-30 30-50 30S20 55 10 40Z"
                style="${g(D.brandOutline)}"
              />
            </g>
            <g data-role="brand-iris" style="${g(De(D.brandIrisGroup,D.brandEyeContent))}">
              <circle cx="60" cy="40" r="20" style="${g(D.brandIris)}" />
              <g data-role="brand-pupil" style="${g(D.brandPupilGroup)}">
                <circle cx="60" cy="40" r="10" style="${g(D.brandPupil)}" />
                <circle cx="72" cy="30" r="4" style="${g(D.brandHighlight)}" />
              </g>
            </g>
          </svg>
        </div>
        <span style="${g(D.brandName)}">Polyoracle</span>
      </div>
    `}function W(){if(!ae)return;const e=ae,t=Array.from(e.querySelectorAll(".custom-select-wrapper.open")).map(f=>f.getAttribute("data-key")).filter(f=>!!f),a=(n.resolution-1)/2*100,r=n.mode==="Explore"?"translateX(0%)":n.mode==="Compare"?"translateX(-33.333%)":"translateX(-66.666%)",o=n.mode==="Explore"?"translateX(0%)":n.mode==="Compare"?"translateX(100%)":"translateX(200%)",i=n.canvasView==="map"?"translateX(0%)":"translateX(100%)",l=n.panelTab==="Manual"?"translateX(0%)":"translateX(-50%)",s=n.mode==="Ensemble"&&n.masks.some(f=>f.kind==="probability");e.innerHTML=`
    <div style="${g(D.page)}">
      <div style="${g(D.bgLayer1)}"></div>
      <div style="${g(D.bgLayer2)}"></div>
      <div style="${g(D.bgOverlay)}"></div>
      ${wp()}
        ${n.canvasView==="map"&&n.dataMin!==null&&n.dataMax!==null?bm(s?"probability":n.mode==="Ensemble"?n.ensembleVariable:n.variable,s?0:n.dataMin,s?100:n.dataMax,n.metaData,s?void 0:n.mode==="Ensemble"?n.ensembleUnit:n.selectedUnit,n.mode==="Compare"||n.mode==="Ensemble"&&jr(n.ensembleStatistic),n.mapRangeOpen?70:0,s?{titleOverride:"Joint Probability",unitOverride:"%",skipConversion:!0,paletteControlHtml:Xo(),bottomControlsHtml:jo()}:{paletteControlHtml:Xo(),bottomControlsHtml:jo()}):""}
      <div style="${g(D.mapArea)}">
        ${n.canvasView==="map"?`
              <canvas
                id="map-canvas"
                style="position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; pointer-events: auto;"
              ></canvas>
              ${Dp()}
              ${Zm()}
              ${Jm()}
              ${ep()}
              ${tp()}
              ${Sp()}
              ${n.dataError?`<div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.8); z-index: 10;">
                      <div style="text-align: center; max-width: 600px; padding: 20px;">
                        <div style="${g(D.mapTitle)}">Error loading data</div>
                        <div style="${g(D.mapSubtitle)}">${n.dataError}</div>
                        ${n.apiAvailable===!1?`<div style="${g(De(D.mapSubtitle,{marginTop:12,fontSize:12}))}">
                                Make sure the Python API server is running. Check the terminal for connection details.
                              </div>`:""}
                      </div>
                    </div>`:""}
              ${!n.isLoading&&!n.dataError&&!n.currentData?`<div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); z-index: 5;">
                      <div style="text-align: center;">
                        <div style="${g(D.mapTitle)}">No data loaded</div>
                        <div style="${g(D.mapSubtitle)}">
                          Adjust parameters to load climate data
                        </div>
                      </div>
                    </div>`:""}
            `:'<div data-role="chart-container" style="pointer-events:auto; width:100%; display:flex; align-items:center; justify-content:center; padding:24px;"></div>'}
      </div>

      ${np()}

      <aside data-role="sidebar" class="sidebar" style="width: ${Ee}px; transform: ${n.sidebarOpen?"translateX(0)":`translateX(${Ee+24}px)`}; pointer-events: ${n.sidebarOpen?"auto":"none"}" aria-hidden="${!n.sidebarOpen}">
        <div class="sidebar-top">
          <div class="sidebar-brand">
            <div class="logo-dot"></div>
          </div>
          <div class="tab-switch" style="${g(D.tabSwitch)}">
            ${["Manual","Chat"].map(f=>$p(f,n.panelTab===f?D.tabBtnActive:void 0,"panel-tab")).join("")}
          </div>
        </div>

        <div class="sidebar-content">
          <div class="tab-viewport">
            <div data-role="tab-track" class="tab-track" style="transform: ${l}">
              <div class="tab-pane">
                ${n.canvasView==="map"?kp({modeTransform:r,resolutionFill:a,modeIndicatorTransform:o}):Tp()}
              </div>
              <div class="tab-pane">
                ${Lp()}
              </div>
            </div>
          </div>
        </div>
      </aside>

      <div data-role="canvas-toggle" style="${g({...D.canvasToggle,right:n.sidebarOpen?Ee+24:24})}">
        <div style="${g(D.canvasSwitch)}">
          <div data-role="canvas-indicator" style="${g({...D.canvasIndicator,transform:i})}"></div>
          <button
            type="button"
            aria-label="Show map canvas"
            data-action="set-canvas"
            data-value="map"
            style="${g(De(D.canvasBtn,n.canvasView==="map"?D.canvasBtnActive:void 0))}"
          >
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.6">
              <path d="M4 6.5 9 4l6 2.5L20 4v14l-5 2.5L9 18 4 20.5V6.5Z" />
              <path d="m9 4v14m6-11.5v14" />
            </svg>
          </button>
          <button
            type="button"
            aria-label="Show chart canvas"
            data-action="set-canvas"
            data-value="chart"
            style="${g(De(D.canvasBtn,n.canvasView==="chart"?D.canvasBtnActive:void 0))}"
          >
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.8">
              <path d="M4 18h16" />
              <path d="M6 18 11 9l4 5 3-6" />
              <circle cx="6" cy="18" r="1.2" />
              <circle cx="11" cy="9" r="1.2" />
              <circle cx="15" cy="14" r="1.2" />
              <circle cx="18" cy="8" r="1.2" />
            </svg>
          </button>
        </div>
      </div>

      ${Km(n)}

      ${om(n.sidebarOpen)}

      ${n.canvasView==="map"&&!n.mapRangeOpen?Bm({date:n.mode=="Ensemble"?n.ensembleDate:n.date,timeRange:n.timeRange,sidebarOpen:n.sidebarOpen,sidebarWidth:Ee,mode:n.mode,compareMode:n.compareMode,compareDateStart:n.compareDateStart,compareDateEnd:n.compareDateEnd}):""}

      ${um()}
      ${dm(it())}
    </div>
  `,Rp();const c=e.querySelector(".tutorial-box");if(c){const f=c.getBoundingClientRect(),m=16;let p=0,v=0;if(f.right>window.innerWidth-m?p=window.innerWidth-m-f.right:f.left<m&&(p=m-f.left),f.bottom>window.innerHeight-m?v=window.innerHeight-m-f.bottom:f.top<m&&(v=m-f.top),p!==0||v!==0){const M=c.style.transform||"";c.style.transform=`${M} translate(${p}px, ${v}px)`}}if(t.forEach(f=>{const m=e.querySelector(`.custom-select-wrapper[data-key="${f}"]`);m&&m.classList.add("open")}),ve=ae.querySelector("#map-canvas"),ve&&n.currentData&&!n.dataError&&n.dataMin!==null&&n.dataMax!==null)try{_n(ve),Tn(n.currentData,ve,ue,n.mapPalette,n.dataMin,n.dataMax,n.mode==="Ensemble"?n.ensembleVariable:n.variable,n.mode==="Ensemble"?n.ensembleUnit:n.selectedUnit,n.masks,n.mode==="Ensemble"?n.ensembleStatistics:null,n.mode==="Ensemble",n.mode==="Explore"?n.maskVariableData:void 0,n.mode==="Ensemble"?n.ensembleStatisticsByVariable:null,n.mode==="Ensemble"?n.ensembleRawSamplesByVariable:null);const f=ue.find(m=>m.name===n.mapPalette)||ue[0];Dn("legend-gradient-canvas",f.colors),(n.drawState.active||n.mapPolygon!==null&&n.mapPolygon.length>=3)&&requestAnimationFrame(qa)}catch(f){console.error("Map render failed (e.g. changing display variable with masks):",f)}const d=(n.sidebarOpen?Ee+24:24)+8,u=n.sidebarOpen?1:.9;Gi(d,u),ts(),n.canvasView==="chart"&&Ue()}function Sp(){if(!n.isLoading)return"";const e=Math.max(0,Math.min(100,Math.round(n.loadingProgress)));return`
      <div style="${g(D.loadingIndicator)}">
        <div style="${g(D.loadingSpinner)}"></div>
        <div style="${g(D.loadingTextGroup)}">
          <div style="${g(D.loadingText)}">Loading data · ${e}%</div>
          <div style="${g(D.loadingBar)}">
            <div style="${g({...D.loadingBarFill,width:`${e}%`})}"></div>
          </div>
          <div style="${g(D.loadingSubtext)}">Fetching climate tiles</div>
        </div>
      </div>
    `}function Mp(){return`
      <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none;">
      </div>
    `}function Gr(e){if(!Number.isFinite(e))return"-";const t=Math.abs(e);return t>=1e3?e.toFixed(0):t>=100?e.toFixed(1):t>=1?e.toFixed(2):e.toPrecision(2)}function Wo(e,t){if(!e.length)return`<div style="${g(D.chartEmpty)}">No chart data loaded yet.</div>`;const a=[...e].sort((_,Y)=>Re.indexOf(_.scenario)-Re.indexOf(Y.scenario)),r=ue.find(_=>_.name===n.chartPalette)||ue[0],o=t?.lightToDarkNoDarkest&&r.colors.length>2?r.colors.slice(1).reverse():t?.lightToDarkNoDarkest?[...r.colors].reverse():r.colors,i=o.length?o:r.colors,l=900,s=440,c={top:26,right:36,bottom:70,left:86},d=l-c.left-c.right,u=s-c.top-c.bottom,f=a.flatMap(_=>[_.stats.min,_.stats.max]),m=Math.min(...f),p=Math.max(...f),v=Math.max(Math.abs(p-m)*.12,1e-6),M=Ba().domain([m-v,p+v]).range([u,0]),S=M.ticks(6),x=d/(a.length+1),b=S.map(_=>{const Y=M(_)+c.top;return`
        <g>
          <line x1="${c.left}" x2="${l-c.right}" y1="${Y}" y2="${Y}" stroke="rgba(255,255,255,0.08)" />
          <text x="${c.left-10}" y="${Y+4}" fill="var(--text-secondary)" font-size="11" text-anchor="end">
            ${Gr(_)}
          </text>
        </g>
      `}).join(""),T=a.map((_,Y)=>{const K=c.left+x*(Y+1),z=a.length===1?Math.floor(i.length/2):Y%i.length,U=i[z],{min:te,q1:J,median:w,q3:q,max:I,mean:X}=_.stats,A=M(q)+c.top,H=M(J)+c.top,G=Math.max(2,H-A),h=M(te)+c.top,y=M(I)+c.top;return`
        <g data-boxplot-idx="${Y}" class="boxplot-group">
          <line x1="${K}" x2="${K}" y1="${h}" y2="${y}" stroke="${U}" stroke-width="2" stroke-linecap="round" />
          <rect x="${K-24}" y="${A}" width="48" height="${G}" fill="rgba(255,255,255,0.06)" stroke="${U}" stroke-width="2" rx="6" />
          <line x1="${K-24}" x2="${K+24}" y1="${M(w)+c.top}" y2="${M(w)+c.top}" stroke="${U}" stroke-width="2.4" />
          <circle cx="${K}" cy="${M(X)+c.top}" r="4" fill="${U}" stroke="rgba(0,0,0,0.55)" stroke-width="1" />
          <text x="${K}" y="${s-c.bottom+32}" fill="var(--text-primary)" font-weight="700" font-size="12" text-anchor="middle">${_.scenario}</text>
          <text x="${K}" y="${s-c.bottom+48}" fill="var(--text-secondary)" font-size="11" text-anchor="middle">${_.samples.length} model${_.samples.length===1?"":"s"}</text>
          <rect x="${K-35}" y="${c.top}" width="70" height="${u}" fill="transparent" class="boxplot-hover-area" style="cursor: pointer; pointer-events: all;" />
        </g>
      `}).join(""),P=a.map((_,Y)=>{const z=c.left+x*(Y+1)+30,U=z,te=z+6,J=te+6,w=_.samples.map(A=>{const H=M(A.value)+c.top;return{model:A.model,value:A.value,y:H}}).sort((A,H)=>A.y-H.y),q=12,I=[];return w.forEach((A,H)=>{if(H===0)I.push({...A,adjustedY:A.y});else{const h=I[H-1].adjustedY+q;I.push({...A,adjustedY:Math.max(A.y,h)})}}),I.map(A=>{const H=A.adjustedY||A.y;return`
                    <g class="model-indicator" data-boxplot-idx="${Y}">
                      <line x1="${U}" x2="${te}" y1="${A.y}" y2="${A.y}" stroke="white" stroke-width="1" stroke-linecap="round" />
                      <text x="${J}" y="${H+4}" fill="white" font-size="10" font-weight="300" opacity="0.95">${A.model}</text>
                    </g>
                  `}).join("")}).join(""),R=`
      <line
        x1="${c.left}"
        x2="${c.left}"
        y1="${c.top}"
        y2="${s-c.bottom}"
        stroke="rgba(255,255,255,0.65)"
        stroke-width="1.2"
      />
    `,k=`
      <text
        x="${c.left-70}"
        y="${c.top+u/2}"
        fill="var(--text-secondary)"
        font-size="12"
        text-anchor="middle"
        transform="rotate(-90 ${c.left-70} ${c.top+u/2})"
      >
        ${n.chartUnit}
      </text>
    `;return`
      <div style="position:relative; width:100%;">
        <div style="position:absolute; top:10px; right:12px; z-index:2;">
          ${za("chartPalette",n.chartPalette)}
        </div>
        <svg viewBox="0 0 ${l} ${s}" role="img" aria-label="Global box plots" preserveAspectRatio="xMidYMid meet" style="width:100%; height:auto;">
          ${R}
          ${b}
          ${T}
          <g class="boxplot-hover-overlay" style="opacity: 0; pointer-events: none;">
            ${P}
          </g>
          ${k}
        </svg>
      </div>
    `}function Yo(e,t,a){if(!e.length)return`<div style="${g(D.chartEmpty)}">No chart data loaded yet.</div>`;const r=[...e].sort((k,_)=>Re.indexOf(k.scenario)-Re.indexOf(_.scenario)),o=ue.find(k=>k.name===a)||ue[0],i=o.colors.length>2?o.colors.slice(1).reverse():[...o.colors].reverse(),l=i.length?i:o.colors,s=560,c=300,d={top:18,right:16,bottom:52,left:48},u=s-d.left-d.right,f=c-d.top-d.bottom,m=r.flatMap(k=>[k.stats.min,k.stats.max]),p=Math.min(...m),v=Math.max(...m),M=Math.max(Math.abs(v-p)*.12,1e-6),S=Ba().domain([p-M,v+M]).range([f,0]),x=S.ticks(4),b=u/(r.length+1),T=x.map(k=>{const _=S(k)+d.top;return`
        <g>
          <line x1="${d.left}" x2="${s-d.right}" y1="${_}" y2="${_}" stroke="rgba(255,255,255,0.06)" />
          <text x="${d.left-8}" y="${_+3}" fill="var(--text-secondary)" font-size="9" text-anchor="end">
            ${Gr(k)}
          </text>
        </g>
      `}).join(""),P=r.map((k,_)=>{const Y=d.left+b*(_+1),K=r.length===1?Math.floor(l.length/2):_%l.length,z=l[K],{min:U,q1:te,median:J,q3:w,max:q,mean:I}=k.stats,X=S(w)+d.top,A=S(te)+d.top,H=Math.max(2,A-X);return`
        <g>
          <line x1="${Y}" x2="${Y}" y1="${S(U)+d.top}" y2="${S(q)+d.top}" stroke="${z}" stroke-width="1.6" stroke-linecap="round" />
          <rect x="${Y-16}" y="${X}" width="32" height="${H}" fill="rgba(255,255,255,0.06)" stroke="${z}" stroke-width="1.6" rx="5" />
          <line x1="${Y-16}" x2="${Y+16}" y1="${S(J)+d.top}" y2="${S(J)+d.top}" stroke="${z}" stroke-width="2" />
          <circle cx="${Y}" cy="${S(I)+d.top}" r="3.2" fill="${z}" stroke="rgba(0,0,0,0.55)" stroke-width="0.8" />
          <text x="${Y}" y="${c-d.bottom+26}" fill="var(--text-primary)" font-weight="700" font-size="10" text-anchor="middle">${k.scenario}</text>
          <text x="${Y}" y="${c-d.bottom+40}" fill="var(--text-secondary)" font-size="9" text-anchor="middle">${k.samples.length} model${k.samples.length===1?"":"s"}</text>
        </g>
      `}).join(""),R=`
      <line
        x1="${d.left}"
        x2="${d.left}"
        y1="${d.top}"
        y2="${c-d.bottom}"
        stroke="rgba(255,255,255,0.55)"
        stroke-width="1"
      />
    `;return`
      <svg viewBox="0 0 ${s} ${c}" role="img" aria-label="Mini box plots" preserveAspectRatio="xMidYMid meet" style="width:100%; height:auto;">
        ${R}
        ${T}
        ${P}
        <text x="${d.left}" y="${d.top-6}" fill="var(--text-secondary)" font-size="9">${ye(t)}</text>
      </svg>
    `}function Ia(e,t){if(!e.length)return`<div style="${g(D.chartEmpty)}">No chart data loaded yet.</div>`;const a=t?.paletteName??n.chartPalette,r=ue.find(h=>h.name===a)||ue[0],o=t?.lightToDarkNoDarkest&&r.colors.length>2?r.colors.slice(1).reverse():t?.lightToDarkNoDarkest?[...r.colors].reverse():r.colors,i=o.length?o:r.colors,l=t?.compact??!1,s=t?.unitLabel??n.chartUnit,c=960,d=l?220:460,u=l?{top:24,right:26,bottom:64,left:70}:{top:28,right:32,bottom:82,left:86},f=c-u.left-u.right,m=d-u.top-u.bottom,p=l?10:11,v=l?10.5:11.5,M=l?54:70,S=e.flatMap(h=>h.points),x=S.map(h=>ne(h.date)),b=Ls(x),T=Ts(x);if(!b||!T)return`<div style="${g(D.chartEmpty)}">No chart data loaded yet.</div>`;const P=1440*60*1e3,R=new Date(b.getTime()-P*.25),k=new Date(T.getTime()+P*.25),_=qf().domain([R,k]).range([0,f]),Y=_.ticks(l?5:6),K=Hr("%b %Y"),z=S.flatMap(h=>[h.stats.min,h.stats.max]),U=Math.min(...z),te=Math.max(...z),J=Math.max(Math.abs(te-U)*.12,1e-6),w=Ba().domain([U-J,te+J]).range([m,0]),I=w.ticks(6).map(h=>{const y=w(h)+u.top;return`
        <g>
          <line x1="${u.left}" x2="${c-u.right}" y1="${y}" y2="${y}" stroke="rgba(255,255,255,0.08)" />
          <text x="${u.left-10}" y="${y+4}" fill="var(--text-secondary)" font-size="${p}" text-anchor="end">
            ${Gr(h)}
          </text>
        </g>
      `}).join(""),X=Y.map(h=>{const y=_(h)+u.left;return`
        <g>
          <line x1="${y}" x2="${y}" y1="${u.top}" y2="${d-u.bottom}" stroke="rgba(255,255,255,0.06)" />
          <text x="${y}" y="${d-u.bottom+26}" fill="var(--text-secondary)" font-size="${p}" text-anchor="middle">
            ${K(h)}
          </text>
        </g>
      `}).join(""),A=Math.max(ke.length,4),H=e.map((h,y)=>{if(!h.points.length)return"";const $=i[y%i.length],N=h.points.map(E=>{const O=Array.from({length:A+1},(j,L)=>{const Q=L/A;return E.stats.min+(E.stats.max-E.stats.min)*Q});return{point:E,levels:O}}),F=E=>{const O=N.map(({point:L,levels:Q})=>{const Z=_(ne(L.date))+u.left,se=w(Q[E+1])+u.top;return`${Z},${se}`}).join(" L "),j=[...N].reverse().map(({point:L,levels:Q})=>{const Z=_(ne(L.date))+u.left,se=w(Q[E])+u.top;return`${Z},${se}`}).join(" L ");return`M ${O} L ${j} Z`},B=Array.from({length:A},(E,O)=>{const j=F(O),L=A/2,Z=.55*(1-Math.min(Math.abs(O+.5-L)/L,1))+.08;return`<path d="${j}" fill="${$}" fill-opacity="${Z.toFixed(3)}" stroke="none" />`}).join(""),C=h.points.map((E,O)=>{const j=_(ne(E.date))+u.left,L=w(E.stats.median)+u.top;return`${O===0?"M":"L"} ${j} ${L}`}).join(" "),V=h.points.map((E,O)=>{const j=_(ne(E.date))+u.left,L=w(E.stats.mean)+u.top;return`${O===0?"M":"L"} ${j} ${L}`}).join(" ");return`
        <g>
          ${B}
          <path d="${C}" fill="none" stroke="${$}" stroke-width="2.2" />
          <path d="${V}" fill="none" stroke="${$}" stroke-width="1.6" stroke-dasharray="6 6" stroke-opacity="0.9" />
          <circle cx="${_(ne(h.points[h.points.length-1].date))+u.left}" cy="${w(h.points[h.points.length-1].stats.median)+u.top}" r="4" fill="${$}" stroke="rgba(0,0,0,0.4)" stroke-width="1" />
        </g>
      `}).join(""),G=`
      <text
        x="${u.left-M}"
        y="${u.top+m/2}"
        fill="var(--text-secondary)"
        font-size="${l?11:12}"
        text-anchor="middle"
        transform="rotate(-90 ${u.left-M} ${u.top+m/2})"
      >
        ${s}
      </text>
    `;return`
      <div style="width:100%; display:flex; flex-direction:column; gap:12px; align-items:center;">
        <div style="position:relative; width:100%; display:flex; justify-content:center;">
          <div style="position:absolute; top:10px; right:16px; display:flex; gap:12px; align-items:center; color:var(--text-secondary); font-size:${v}px; z-index:2;">
            ${l?"":`<div>${za("chartPalette",n.chartPalette)}</div>`}
            <div style="display:flex; align-items:center; gap:6px;">
              <span style="display:inline-block; width:26px; height:0; border-top:1px solid var(--text-primary);"></span>
              <span>Median</span>
            </div>
            <div style="display:flex; align-items:center; gap:6px;">
              <span style="display:inline-block; width:26px; height:0; border-top:1px dashed var(--text-primary);"></span>
              <span>Mean</span>
            </div>
          </div>
          <svg viewBox="0 0 ${c} ${d}" role="img" aria-label="Distribution over time" preserveAspectRatio="xMidYMid meet" style="width:100%; height:${l?"100%":"auto"};">
            ${I}
            ${X}
            <path
              d="M ${u.left} ${u.top} L ${u.left} ${d-u.bottom} L ${c-u.right} ${d-u.bottom}"
              fill="none"
              stroke="rgba(255,255,255,0.6)"
              stroke-width="1.2"
              stroke-linecap="round"
            />
            ${H}
            ${G}
          </svg>
        </div>
        ${l?"":`<div style="${g(D.chartLegend)}">
          ${e.map((h,y)=>`
            <div style="display:flex; align-items:center; gap:8px; font-size:12; color:var(--text-secondary);">
              <span style="display:inline-block; width:16px; height:8px; background:${i[y%i.length]}; border-radius:999px;"></span>
              <span style="color:var(--text-primary); font-weight:700;">${h.scenario}</span>
            </div>
          `).join("")}
        </div>`}
      </div>
    `}function ce(e,t){return`
    <div style="${g(D.field)}">
      ${e?`<div style="${g(D.fieldLabel)}">${e}</div>`:""}
      ${t}
    </div>
  `}function st(e,t,a){const r=a?.type??"date",o=a?.dataKey??e,i=a?.min?`min="${a.min}"`:"",l=a?.max?`max="${a.max}"`:"",s=a?.dataRole?`data-role="${a.dataRole}"`:"";return`
    <input
      type="${r}"
      value="${t}"
      data-action="update-input"
      data-key="${o}"
      ${i}
      ${l}
      ${s}
    />
  `}function oe(e,t,a,r){const o=r?.dataKey??e,i=r?.disabled?"disabled":"",l=`custom-select-${o}-${Math.random().toString(36).substr(2,9)}`,s=r?.infoType,c=ye(r?.selectedLabel??a),d=r?.extraContent??"",u=r?.dataRole?`data-role="${r.dataRole}"`:"";return`
    <div class="custom-select-container">
      <div class="custom-select-info-panel" id="${l}-info" role="tooltip"></div>
      <div class="custom-select-wrapper" ${u} data-key="${o}" ${i?'data-disabled="true"':""} ${s?`data-info-type="${s}"`:""}>
        <div class="custom-select-trigger" data-action="update-select" data-key="${o}" id="${l}-trigger" ${i?'aria-disabled="true"':""} tabindex="${i?"-1":"0"}">
          <span class="custom-select-value">${c}</span>
          <svg class="custom-select-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="custom-select-dropdown" id="${l}-dropdown" role="listbox">
          ${t.map(f=>`
                <div class="custom-select-option ${f===a?"selected":""}" 
                     data-value="${f}" 
                     data-action="update-select" 
                     data-key="${o}"
                     role="option"
                     ${f===a?'aria-selected="true"':""}
                     tabindex="0">
                  ${o==="ensembleStatistic"||o==="maskStatistic"?f==="mean"?"Mean":f==="median"?"Median":f==="std"?"Std":f==="iqr"?"IQR":f==="percentile"?"Percentile":f==="extremes"?"Extremes":f:f}
                </div>
              `).join("")}
          ${d}
        </div>
      </div>
    </div>
  `}function Xo(){const e=`legend-palette-${Math.random().toString(36).substr(2,9)}`;return`
    <div class="custom-select-container">
      <div class="custom-select-wrapper legend-palette-wrapper" data-key="mapPalette" data-role="palette-selector">
        <button
          type="button"
          class="custom-select-trigger legend-palette-trigger"
          data-action="update-select"
          data-key="mapPalette"
          id="${e}-trigger"
          aria-label="Select color palette"
        >
          <span class="custom-select-value legend-palette-current">${ye(n.mapPalette)}</span>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 4a8 8 0 1 0 0 16h1.2c1.4 0 2.3-1.5 1.6-2.7-.6-1-.2-2.3.9-2.8 1.1-.5 2.3.2 2.4 1.4.1 1.2 1.1 2.1 2.3 2.1H21a3 3 0 0 0 3-3c0-6.1-5.4-11-12-11Z" stroke="currentColor" stroke-width="1.6"/>
            <circle cx="7.3" cy="11.2" r="1.1" fill="currentColor"/>
            <circle cx="10.1" cy="8.2" r="1.1" fill="currentColor"/>
            <circle cx="14.1" cy="8.6" r="1.1" fill="currentColor"/>
            <circle cx="16.8" cy="11.7" r="1.1" fill="currentColor"/>
          </svg>
        </button>
        <div class="custom-select-dropdown legend-palette-dropdown" id="${e}-dropdown" role="listbox">
          ${ue.map(t=>`
            <div class="custom-select-option ${t.name===n.mapPalette?"selected":""}"
                 data-value="${t.name}"
                 data-action="update-select"
                 data-key="mapPalette"
                 role="option"
                 ${t.name===n.mapPalette?'aria-selected="true"':""}
                 tabindex="0">
              <div class="legend-palette-option-content">
                <div class="legend-palette-swatches">
                  ${t.colors.slice(0,4).map(a=>`<span class="legend-palette-dot" style="background:${a};"></span>`).join("")}
                </div>
                <span class="legend-palette-name">${ye(t.name)}</span>
              </div>
            </div>
          `).join("")}
        </div>
      </div>
    </div>
  `}function za(e,t){const a=`overlay-palette-${e}-${Math.random().toString(36).substr(2,9)}`;return`
    <div class="custom-select-container">
      <div class="custom-select-wrapper overlay-palette-wrapper" data-key="${e}">
        <button
          type="button"
          class="custom-select-trigger overlay-palette-trigger"
          data-action="update-select"
          data-key="${e}"
          id="${a}-trigger"
          aria-label="Select color palette"
        >
          <span class="custom-select-value">${ye(t)}</span>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 4a8 8 0 1 0 0 16h1.2c1.4 0 2.3-1.5 1.6-2.7-.6-1-.2-2.3.9-2.8 1.1-.5 2.3.2 2.4 1.4.1 1.2 1.1 2.1 2.3 2.1H21a3 3 0 0 0 3-3c0-6.1-5.4-11-12-11Z" stroke="currentColor" stroke-width="1.6"/>
            <circle cx="7.3" cy="11.2" r="1.1" fill="currentColor"/>
            <circle cx="10.1" cy="8.2" r="1.1" fill="currentColor"/>
            <circle cx="14.1" cy="8.6" r="1.1" fill="currentColor"/>
            <circle cx="16.8" cy="11.7" r="1.1" fill="currentColor"/>
          </svg>
        </button>
        <div class="custom-select-dropdown overlay-palette-dropdown" id="${a}-dropdown" role="listbox">
          ${ue.map(r=>`
            <div class="custom-select-option ${r.name===t?"selected":""}"
                 data-value="${r.name}"
                 data-action="update-select"
                 data-key="${e}"
                 role="option"
                 ${r.name===t?'aria-selected="true"':""}
                 tabindex="0">
              <div class="legend-palette-option-content">
                <div class="legend-palette-swatches">
                  ${r.colors.slice(0,4).map(o=>`<span class="legend-palette-dot" style="background:${o};"></span>`).join("")}
                </div>
                <span class="legend-palette-name">${ye(r.name)}</span>
              </div>
            </div>
          `).join("")}
        </div>
      </div>
    </div>
  `}function jo(){const e=n.mode==="Ensemble",t=e?"ensembleUnit":"unit",a=e?n.ensembleUnit:n.selectedUnit,r=e?n.ensembleVariable:n.variable;return`
    <div class="legend-unit-select">
      ${oe(t,Oe(r).map(o=>o.label),a,{dataKey:t,dataRole:"unit-selector"})}
    </div>
  `}function $p(e,t,a="panel-tab"){return`
    <button
      type="button"
      data-action="set-tab"
      data-key="${a}"
      data-value="${e}"
      style="${g(De(D.tabBtn,t))}"
    >
      ${e}
    </button>
  `}function kp(e){const{modeTransform:t,resolutionFill:a,modeIndicatorTransform:r}=e,o=n.mode==="Ensemble"&&n.masks.some(s=>s.kind==="probability"),i=(s,c,d,u,f)=>`
          <div style="${g({border:"1px solid var(--border-medium)",borderRadius:12,background:"var(--bg-subtle)",padding:"10px 12px"})}">
            <button
              type="button"
              data-action="toggle-collapse"
              data-key="${f}"
              style="${g({display:"flex",justifyContent:"space-between",alignItems:"center",width:"100%",background:"transparent",border:"none",color:"var(--text-primary)",fontWeight:700,fontSize:13,cursor:"pointer",padding:0})}"
            >
              <span>${s}</span>
              <span style="${g({color:"var(--text-secondary)",fontWeight:600,fontSize:12})}">${d} ${c?"▴":"▾"}</span>
            </button>
            ${c?`<div style="${g({marginTop:10,display:"flex",flexWrap:"wrap",gap:8})}">${u}</div>`:""}
          </div>
        `,l=n.compareMode==="Models"?[ce("Scenario",oe("scenario",Re,n.scenario,{infoType:"scenario"})),ce("Date",st("date",n.date))]:n.compareMode==="Dates"?[ce("Scenario",oe("scenario",Re,n.scenario,{infoType:"scenario"})),ce("Model",oe("model",Se,n.model,{infoType:"model"}))]:[ce("Model",oe("model",Se,n.model,{infoType:"model"})),ce("Date",st("date",n.date))];return`
    <div style="${g(D.modeSwitch)}">
      <div data-role="mode-indicator" style="${g({...D.modeIndicator,transform:r})}"></div>
      ${["Explore","Compare","Ensemble"].map(s=>`
            <button
              type="button"
              class="mode-btn"
              data-action="set-mode"
              data-value="${s}"
              style="${g(De(D.modeBtn,n.mode===s?D.modeBtnActive:void 0))}"
            >
              ${s}
            </button>
          `).join("")}
    </div>

    <div style="${g(D.modeViewport)}">
      <div data-role="mode-track" style="${g({...D.modeTrack,transform:t})}">
        <div class="mode-pane-scrollable" style="${g(D.modePane)}">
          <div style="${g({display:"flex",flexDirection:"column",gap:8})}">
            <div style="${g(D.sectionTitle)}">Parameters</div>
            <div style="${g(D.paramGrid)}">
              ${ce("Scenario",oe("scenario",Re,n.scenario,{infoType:"scenario",dataRole:"scenario-selector"}))}
              ${ce("Model",oe("model",Se,n.model,{infoType:"model",dataRole:"model-selector"}))}
              ${ce("Date",(()=>{const s=qe(n.scenario);return st("date",n.date,{min:s.start,max:s.end,dataRole:"date-picker"})})())}
              ${ce("Variable",oe("variable",ke,n.variable,{infoType:"variable",dataRole:"variable-selector"}))}
            </div>
          </div>

          <div style="margin-top:14px">
            <div style="${g({display:"flex",flexDirection:"column",gap:8})}">
              <div style="${g(D.sectionTitle)}">Resolution</div>
              <div style="${g(D.resolutionRow)}">
                <input
                  type="range"
                  min="1"
                  max="3"
                  step="1"
                  value="${n.resolution}"
                  data-action="set-resolution"
                  class="resolution-slider"
                  style="${g(De(D.range,{"--slider-fill":`${a}%`}))}"
                />
                <div data-role="resolution-value" style="${g(D.resolutionValue)}">${n.resolution===1?"Low":n.resolution===2?"Medium":"High"}</div>
              </div>
            </div>
          </div>

          <div style="margin-top:14px">
            <div style="${g({display:"flex",flexDirection:"column",gap:8})}">
              <div style="${g(D.sectionTitle)}">Mask</div>
              ${n.masks.length>0?`
                      <div style="${g({display:"flex",flexDirection:"column",gap:8})}">
                        ${n.masks.map((s,c)=>{const d=s.variable||(n.mode==="Ensemble"?n.ensembleVariable:n.variable),u=s.unit||(n.mode==="Ensemble"?n.ensembleUnit:Ne(d).label),f=n.mode==="Explore"?fa(d,u):null,m=n.mode==="Ensemble"?s.kind==="probability"?Dt(d,u):kt(s.statistic||"mean",d,u):null,p=n.mode==="Ensemble"?m?.min??null:f?.min??(d===n.variable?n.dataMin:null),v=n.mode==="Ensemble"?m?.max??null:f?.max??(d===n.variable?n.dataMax:null);return`
                          ${n.mode==="Ensemble"?`
                                  <div style="${g({display:"flex",alignItems:"center",gap:8,marginBottom:4})}">
                                    ${s.kind==="probability"?"":oe("maskStatistic",["mean","std","median","iqr","percentile","extremes"],s.statistic||"mean",{dataKey:"maskStatistic",selectedLabel:s.statistic==="mean"?"Mean":s.statistic==="std"?"Std":s.statistic==="median"?"Median":s.statistic==="iqr"?"IQR":s.statistic==="percentile"?"Percentile":s.statistic==="extremes"?"Extremes":"Mean"}).replace('class="custom-select-wrapper"',`class="custom-select-wrapper" data-mask-index="${c}" style="width: 100px;"`)}
                                    ${oe("maskVariable",ke,d,{dataKey:"maskVariable",infoType:"variable"}).replace('class="custom-select-wrapper"',`class="custom-select-wrapper" data-mask-index="${c}" style="width: 90px;"`)}
                                    ${oe("maskUnit",Oe(d).map(M=>M.label),u,{dataKey:"maskUnit"}).replace('class="custom-select-wrapper"',`class="custom-select-wrapper" data-mask-index="${c}" style="width: 120px;"`)}
                                  </div>
                                  `:n.mode==="Explore"?`
                                  <div style="${g({display:"flex",alignItems:"center",gap:8,marginBottom:4})}">
                                    ${oe("maskVariable",ke,s.variable||n.variable,{dataKey:"maskVariable",infoType:"variable"}).replace('class="custom-select-wrapper"',`class="custom-select-wrapper" data-mask-index="${c}" style="width: 90px;"`)}
                                    ${oe("maskUnit",Oe(s.variable||n.variable).map(M=>M.label),s.unit||Ne(s.variable||n.variable).label,{dataKey:"maskUnit"}).replace('class="custom-select-wrapper"',`class="custom-select-wrapper" data-mask-index="${c}" style="width: 120px;"`)}
                                  </div>
                                  `:""}
                          <div style="${g({display:"flex",alignItems:"center",gap:8})}">
                            <input
                              type="number"
                              step="any"
                              value="${s.lowerEdited&&s.lowerBound!==null?s.lowerBound:""}"
                              data-action="update-mask-bound"
                              data-mask-index="${c}"
                              data-bound="lower"
                              placeholder="${en(p)}"
                              style="${g({width:"90px",background:"var(--gradient-bg)",border:"1px solid var(--border-strong)",borderRadius:8,color:"var(--text-primary)",padding:"6px 10px",fontSize:12.5,fontWeight:600,fontFamily:"var(--font-geist-sans)",letterSpacing:.25,minHeight:32,boxShadow:"inset 0 1px 0 var(--inset-light)"})}"
                            />
                            <span style="${g({fontSize:12.5,color:"var(--text-secondary)",minWidth:"20px",textAlign:"center"})}">to</span>
                            <input
                              type="number"
                              step="any"
                              value="${s.upperEdited&&s.upperBound!==null?s.upperBound:""}"
                              data-action="update-mask-bound"
                              data-mask-index="${c}"
                              data-bound="upper"
                              placeholder="${en(v)}"
                              style="${g({width:"90px",background:"var(--gradient-bg)",border:"1px solid var(--border-strong)",borderRadius:8,color:"var(--text-primary)",padding:"6px 10px",fontSize:12.5,fontWeight:600,fontFamily:"var(--font-geist-sans)",letterSpacing:.25,minHeight:32,boxShadow:"inset 0 1px 0 var(--inset-light)"})}"
                            />
                            <button
                              type="button"
                              data-action="remove-mask"
                              data-mask-index="${c}"
                              style="${g({width:28,height:28,padding:0,borderRadius:6,border:"1px solid var(--border-medium)",background:"var(--bg-transparent)",color:"var(--text-secondary)",fontSize:16,fontWeight:600,cursor:"pointer",transition:"all 0.15s ease",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0})}"
                              onmouseover="this.style.borderColor='var(--border-bright)'; this.style.background='var(--bg-medium)'"
                              onmouseout="this.style.borderColor='var(--border-medium)'; this.style.background='var(--bg-transparent)'"
                            >
                              −
                            </button>
                          </div>
                        `}).join("")}
                        <button
                          type="button"
                          data-action="apply-masks"
                          style="${g({padding:"10px 16px",borderRadius:10,border:"1px solid var(--border-strong)",background:"var(--gradient-primary)",color:"white",fontSize:12.5,fontWeight:700,cursor:"pointer",transition:"all 0.15s ease",textAlign:"center",width:"100%",marginTop:8,boxShadow:"var(--shadow-combined)"})}"
                          onmouseover="this.style.borderColor='var(--accent-border-bright)'; this.style.boxShadow='var(--shadow-elevated)'"
                          onmouseout="this.style.borderColor='var(--border-strong)'; this.style.boxShadow='var(--shadow-combined)'"
                        >
                          Apply Masks
                        </button>
                        <button
                          type="button"
                          data-action="add-mask"
                          style="${g({padding:"8px 14px",borderRadius:10,border:"1px solid var(--border-subtle)",background:"var(--bg-transparent)",color:"var(--text-secondary)",fontSize:12.5,fontWeight:600,cursor:"pointer",transition:"all 0.15s ease",textAlign:"left",width:"100%",marginTop:4})}"
                          onmouseover="this.style.borderColor='var(--border-medium)'; this.style.background='var(--bg-subtle)'"
                          onmouseout="this.style.borderColor='var(--border-subtle)'; this.style.background='var(--bg-transparent)'"
                        >
                          + Add Mask
                        </button>
                        ${n.mode==="Ensemble"?`
                        <button
                          type="button"
                          data-action="add-probability-mask"
                          style="${g({padding:"8px 14px",borderRadius:10,border:"1px solid var(--border-subtle)",background:"var(--bg-transparent)",color:"var(--text-secondary)",fontSize:12.5,fontWeight:600,cursor:"pointer",transition:"all 0.15s ease",textAlign:"left",width:"100%",marginTop:4})}"
                          onmouseover="this.style.borderColor='var(--border-medium)'; this.style.background='var(--bg-subtle)'"
                          onmouseout="this.style.borderColor='var(--border-subtle)'; this.style.background='var(--bg-transparent)'"
                        >
                          + Add Probability Mask
                        </button>
                        `:""}
                      </div>
                      `:`
                      <button
                        type="button"
                        data-action="add-mask"
                        style="${g({padding:"8px 14px",borderRadius:10,border:"1px solid var(--border-subtle)",background:"var(--bg-transparent)",color:"var(--text-secondary)",fontSize:12.5,fontWeight:600,cursor:"pointer",transition:"all 0.15s ease",textAlign:"left",width:"100%"})}"
                        onmouseover="this.style.borderColor='var(--border-medium)'; this.style.background='var(--bg-subtle)'"
                        onmouseout="this.style.borderColor='var(--border-subtle)'; this.style.background='var(--bg-transparent)'"
                      >
                        + Add Mask
                      </button>
                      ${n.mode==="Ensemble"?`
                      <button
                        type="button"
                        data-action="add-probability-mask"
                        style="${g({padding:"8px 14px",borderRadius:10,border:"1px solid var(--border-subtle)",background:"var(--bg-transparent)",color:"var(--text-secondary)",fontSize:12.5,fontWeight:600,cursor:"pointer",transition:"all 0.15s ease",textAlign:"left",width:"100%",marginTop:4})}"
                        onmouseover="this.style.borderColor='var(--border-medium)'; this.style.background='var(--bg-subtle)'"
                        onmouseout="this.style.borderColor='var(--border-subtle)'; this.style.background='var(--bg-transparent)'"
                      >
                        + Add Probability Mask
                      </button>
                      `:""}
                      `}
            </div>
          </div>
        </div>

                <div class="mode-pane-scrollable" style="${g(D.modePane)}">
                    <div data-role="compare-parameters" style="${g({display:"flex",flexDirection:"column",gap:14})}">
            <div style="${g({display:"flex",flexDirection:"column",gap:8})}">
              <div style="${g(D.sectionTitle)}">Compare</div>
              <div style="${g(D.paramGrid)}">
                ${ce("What do you want to compare?",oe("compareMode",["Scenarios","Models","Dates"],n.compareMode,{dataKey:"compareMode"}))}
              </div>

              ${n.compareMode==="Scenarios"?`
                      <div style="${g(D.paramGrid)}">
                        ${ce("Scenario A",oe("compareScenarioA",["SSP245","SSP370","SSP585"],n.compareScenarioA,{dataKey:"compareScenarioA",infoType:"scenario"}))}
                        ${ce("Scenario B",oe("compareScenarioB",["SSP245","SSP370","SSP585"],n.compareScenarioB,{dataKey:"compareScenarioB",infoType:"scenario"}))}
                      </div>
                    `:""}

              ${n.compareMode==="Models"?`
                      <div style="${g(D.paramGrid)}">
                        ${ce("Model A",oe("compareModelA",(()=>{const s=Se.filter(c=>c!==n.compareModelB);return s.includes(n.compareModelA)?s:[n.compareModelA,...s]})(),n.compareModelA,{dataKey:"compareModelA",infoType:"model"}))}
                        ${ce("Model B",oe("compareModelB",(()=>{const s=Se.filter(c=>c!==n.compareModelA);return s.includes(n.compareModelB)?s:[n.compareModelB,...s]})(),n.compareModelB,{dataKey:"compareModelB",infoType:"model"}))}
                      </div>
                    `:""}

              ${n.compareMode==="Dates"?`
                      <div style="${g(D.paramGrid)}">
                        ${ce("Start date",st("compareDateStart",n.compareDateStart,{dataKey:"compareDateStart"}))}
                        ${ce("End date",st("compareDateEnd",n.compareDateEnd,{dataKey:"compareDateEnd"}))}
  </div>
`:""}

              <div style="${g(D.paramGrid)}">
                ${l.join("")}
                ${ce("Variable",oe("variable",ke,n.variable,{infoType:"variable"}))}
              </div>

              <div style="margin-top:14px">
                <div style="${g({display:"flex",flexDirection:"column",gap:8})}">
                  <div style="${g(D.sectionTitle)}">Resolution</div>
                  <div style="${g(D.resolutionRow)}">
                    <input
                      type="range"
                      min="1"
                      max="3"
                      step="1"
                      value="${n.resolution}"
                      data-action="set-resolution"
                      class="resolution-slider"
                      style="${g(De(D.range,{"--slider-fill":`${a}%`}))}"
                    />
                    <div data-role="resolution-value" style="${g(D.resolutionValue)}">${n.resolution===1?"Low":n.resolution===2?"Medium":"High"}</div>
                  </div>
                </div>
              </div>

              <div style="margin-top:14px">
                <div style="${g({display:"flex",flexDirection:"column",gap:8})}">
                  <div style="${g(D.sectionTitle)}">Mask</div>
                  ${n.masks.length>0?`
                          <div style="${g({display:"flex",flexDirection:"column",gap:8})}">
                            ${n.masks.map((s,c)=>{const d=s.variable||(n.mode==="Ensemble"?n.ensembleVariable:n.variable),u=s.unit||(n.mode==="Ensemble"?n.ensembleUnit:Ne(d).label),f=n.mode==="Explore"?fa(d,u):null,m=n.mode==="Ensemble"?s.kind==="probability"?Dt(d,u):kt(s.statistic||"mean",d,u):null,p=n.mode==="Ensemble"?m?.min??null:f?.min??(d===n.variable?n.dataMin:null),v=n.mode==="Ensemble"?m?.max??null:f?.max??(d===n.variable?n.dataMax:null);return`
                              <div style="${g({display:"flex",alignItems:"center",gap:8})}">
                                ${n.mode==="Ensemble"?(s.kind==="probability"?"":oe("maskStatistic",["mean","std","median","iqr","percentile","extremes"],s.statistic||"mean",{dataKey:"maskStatistic",selectedLabel:s.statistic==="mean"?"Mean":s.statistic==="std"?"Std":s.statistic==="median"?"Median":s.statistic==="iqr"?"IQR":s.statistic==="percentile"?"Percentile":s.statistic==="extremes"?"Extremes":"Mean"}).replace('data-key="maskStatistic"',`data-key="maskStatistic" data-mask-index="${c}"`).replace('class="custom-select-wrapper"',`class="custom-select-wrapper" data-mask-index="${c}"`))+oe("maskVariable",ke,d,{dataKey:"maskVariable",infoType:"variable"}).replace('class="custom-select-wrapper"',`class="custom-select-wrapper" data-mask-index="${c}" style="width: 90px;"`)+oe("maskUnit",Oe(d).map(M=>M.label),u,{dataKey:"maskUnit"}).replace('class="custom-select-wrapper"',`class="custom-select-wrapper" data-mask-index="${c}" style="width: 120px;"`):n.mode==="Explore"?`
                                            ${oe("maskVariable",ke,s.variable||n.variable,{dataKey:"maskVariable",infoType:"variable"}).replace('class="custom-select-wrapper"',`class="custom-select-wrapper" data-mask-index="${c}" style="width: 90px;"`)}
                                            ${oe("maskUnit",Oe(s.variable||n.variable).map(M=>M.label),s.unit||Ne(s.variable||n.variable).label,{dataKey:"maskUnit"}).replace('class="custom-select-wrapper"',`class="custom-select-wrapper" data-mask-index="${c}" style="width: 120px;"`)}
                                          `:""}
                                <input
                                  type="number"
                                  step="any"
                                  value="${s.lowerEdited&&s.lowerBound!==null?s.lowerBound:""}"
                                  data-action="update-mask-bound"
                                  data-mask-index="${c}"
                                  data-bound="lower"
                                  placeholder="${en(p)}"
                                  style="${g({width:"90px",background:"var(--gradient-bg)",border:"1px solid var(--border-strong)",borderRadius:8,color:"var(--text-primary)",padding:"6px 10px",fontSize:12.5,fontWeight:600,fontFamily:"var(--font-geist-sans)",letterSpacing:.25,minHeight:32,boxShadow:"inset 0 1px 0 var(--inset-light)"})}"
                                />
                                <span style="${g({fontSize:12.5,color:"var(--text-secondary)",minWidth:"20px",textAlign:"center"})}">to</span>
                                <input
                                  type="number"
                                  step="any"
                                  value="${s.upperEdited&&s.upperBound!==null?s.upperBound:""}"
                                  data-action="update-mask-bound"
                                  data-mask-index="${c}"
                                  data-bound="upper"
                                  placeholder="${en(v)}"
                                  style="${g({width:"90px",background:"var(--gradient-bg)",border:"1px solid var(--border-strong)",borderRadius:8,color:"var(--text-primary)",padding:"6px 10px",fontSize:12.5,fontWeight:600,fontFamily:"var(--font-geist-sans)",letterSpacing:.25,minHeight:32,boxShadow:"inset 0 1px 0 var(--inset-light)"})}"
                                />
                                <button
                                  type="button"
                                  data-action="remove-mask"
                                  data-mask-index="${c}"
                                  style="${g({width:28,height:28,padding:0,borderRadius:6,border:"1px solid var(--border-medium)",background:"var(--bg-transparent)",color:"var(--text-secondary)",fontSize:16,fontWeight:600,cursor:"pointer",transition:"all 0.15s ease",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0})}"
                                  onmouseover="this.style.borderColor='var(--border-bright)'; this.style.background='var(--bg-medium)'"
                                  onmouseout="this.style.borderColor='var(--border-medium)'; this.style.background='var(--bg-transparent)'"
                                >
                                  −
                                </button>
                              </div>
                            `}).join("")}
                            <button
                              type="button"
                              data-action="add-mask"
                              style="${g({padding:"8px 14px",borderRadius:10,border:"1px solid var(--border-subtle)",background:"var(--bg-transparent)",color:"var(--text-secondary)",fontSize:12.5,fontWeight:600,cursor:"pointer",transition:"all 0.15s ease",textAlign:"left",width:"100%",marginTop:4})}"
                              onmouseover="this.style.borderColor='var(--border-medium)'; this.style.background='var(--bg-subtle)'"
                              onmouseout="this.style.borderColor='var(--border-subtle)'; this.style.background='var(--bg-transparent)'"
                            >
                              + Add Mask
                            </button>
                            ${n.mode==="Ensemble"?`
                            <button
                              type="button"
                              data-action="add-probability-mask"
                              style="${g({padding:"8px 14px",borderRadius:10,border:"1px solid var(--border-subtle)",background:"var(--bg-transparent)",color:"var(--text-secondary)",fontSize:12.5,fontWeight:600,cursor:"pointer",transition:"all 0.15s ease",textAlign:"left",width:"100%",marginTop:4})}"
                              onmouseover="this.style.borderColor='var(--border-medium)'; this.style.background='var(--bg-subtle)'"
                              onmouseout="this.style.borderColor='var(--border-subtle)'; this.style.background='var(--bg-transparent)'"
                            >
                              + Add Probability Mask
                            </button>
                            `:""}
                          </div>
                          `:`
                          <button
                            type="button"
                            data-action="add-mask"
                            style="${g({padding:"8px 14px",borderRadius:10,border:"1px solid var(--border-subtle)",background:"var(--bg-transparent)",color:"var(--text-secondary)",fontSize:12.5,fontWeight:600,cursor:"pointer",transition:"all 0.15s ease",textAlign:"left",width:"100%"})}"
                            onmouseover="this.style.borderColor='var(--border-medium)'; this.style.background='var(--bg-subtle)'"
                            onmouseout="this.style.borderColor='var(--border-subtle)'; this.style.background='var(--bg-transparent)'"
                          >
                            + Add Mask
                          </button>
                          ${n.mode==="Ensemble"?`
                          <button
                            type="button"
                            data-action="add-probability-mask"
                            style="${g({padding:"8px 14px",borderRadius:10,border:"1px solid var(--border-subtle)",background:"var(--bg-transparent)",color:"var(--text-secondary)",fontSize:12.5,fontWeight:600,cursor:"pointer",transition:"all 0.15s ease",textAlign:"left",width:"100%",marginTop:4})}"
                            onmouseover="this.style.borderColor='var(--border-medium)'; this.style.background='var(--bg-subtle)'"
                            onmouseout="this.style.borderColor='var(--border-subtle)'; this.style.background='var(--bg-transparent)'"
                          >
                            + Add Probability Mask
                          </button>
                          `:""}
                          `}
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="mode-pane-scrollable" style="${g(D.modePane)}">
          <div style="${g({display:"flex",flexDirection:"column",gap:8})}">
            <div style="${g(D.sectionTitle)}">Parameters</div>
            <div style="${g(D.paramGrid)}">
              ${ce("Date",(()=>{const s=mn(n.ensembleScenarios.length?n.ensembleScenarios:Re);return st("ensembleDate",n.ensembleDate,{dataKey:"ensembleDate",min:s.start,max:s.end})})())}
              ${ce("Variable",oe("ensembleVariable",ke,n.ensembleVariable,{dataKey:"ensembleVariable",infoType:"variable",disabled:o,selectedLabel:o?"Probability":void 0}))}
            </div>
          </div>

          <div style="margin-top:14px">
            <div style="${g({display:"flex",flexDirection:"column",gap:8})}">
              <div style="${g(D.sectionTitle)}">Statistic</div>
              ${ce("",oe("ensembleStatistic",["mean","median","std","iqr","percentile","extremes"],n.ensembleStatistic,{dataKey:"ensembleStatistic",selectedLabel:n.ensembleStatistic==="mean"?"Mean":n.ensembleStatistic==="median"?"Median":n.ensembleStatistic==="std"?"Std Deviation":n.ensembleStatistic==="iqr"?"IQR (Interquartile Range)":n.ensembleStatistic==="percentile"?"Percentile Band (90th-10th)":"Extremes (Max-Min)"}))}
            </div>
          </div>

          <div style="margin-top:14px">
            ${i("Scenarios",n.ensembleDropdown.scenariosOpen,`${n.ensembleScenarios.length} selected`,an(n.metaData?.scenarios?.length?Array.from(new Set(n.metaData.scenarios.map(Ke))):Re,n.ensembleScenarios,"ensembleScenarios"),"ensembleScenarios")}
          </div>

          <div style="margin-top:14px">
            ${i("Models",n.ensembleDropdown.modelsOpen,`${n.ensembleModels.length} selected`,an(n.metaData?.models?.length?n.metaData.models:Se,n.ensembleModels,"ensembleModels"),"ensembleModels")}
          </div>

          <div style="margin-top:14px">
            <div style="${g({display:"flex",flexDirection:"column",gap:8})}">
              <div style="${g(D.sectionTitle)}">Resolution</div>
              <div style="${g(D.resolutionRow)}">
                <input
                  type="range"
                  min="1"
                  max="3"
                  step="1"
                  value="${n.resolution}"
                  data-action="set-resolution"
                  class="resolution-slider"
                  style="${g(De(D.range,{"--slider-fill":`${a}%`}))}"
                />
                <div data-role="resolution-value" style="${g(D.resolutionValue)}">${n.resolution===1?"Low":n.resolution===2?"Medium":"High"}</div>
              </div>
            </div>
          </div>

          <div style="margin-top:14px">
            <div style="${g({display:"flex",flexDirection:"column",gap:8})}">
              <div style="${g(D.sectionTitle)}">Mask</div>
              ${n.masks.length>0?`
                      <div style="${g({display:"flex",flexDirection:"column",gap:8})}">
                        ${n.masks.map((s,c)=>{const d=s.variable||(n.mode==="Ensemble"?n.ensembleVariable:n.variable),u=s.unit||(n.mode==="Ensemble"?n.ensembleUnit:Ne(d).label),f=n.mode==="Explore"?fa(d,u):null,m=n.mode==="Ensemble"?s.kind==="probability"?Dt(d,u):kt(s.statistic||"mean",d,u):null,p=n.mode==="Ensemble"?m?.min??null:f?.min??(d===n.variable?n.dataMin:null),v=n.mode==="Ensemble"?m?.max??null:f?.max??(d===n.variable?n.dataMax:null);return`
                          ${n.mode==="Ensemble"?`
                                  <div style="${g({display:"flex",alignItems:"center",gap:8,marginBottom:4})}">
                                    ${s.kind==="probability"?"":oe("maskStatistic",["mean","std","median","iqr","percentile","extremes"],s.statistic||"mean",{dataKey:"maskStatistic",selectedLabel:s.statistic==="mean"?"Mean":s.statistic==="std"?"Std":s.statistic==="median"?"Median":s.statistic==="iqr"?"IQR":s.statistic==="percentile"?"Percentile":s.statistic==="extremes"?"Extremes":"Mean"}).replace('class="custom-select-wrapper"',`class="custom-select-wrapper" data-mask-index="${c}" style="width: 100px;"`)}
                                    ${oe("maskVariable",ke,d,{dataKey:"maskVariable",infoType:"variable"}).replace('class="custom-select-wrapper"',`class="custom-select-wrapper" data-mask-index="${c}" style="width: 90px;"`)}
                                    ${oe("maskUnit",Oe(d).map(M=>M.label),u,{dataKey:"maskUnit"}).replace('class="custom-select-wrapper"',`class="custom-select-wrapper" data-mask-index="${c}" style="width: 120px;"`)}
                                  </div>
                                  `:n.mode==="Explore"?`
                                  <div style="${g({display:"flex",alignItems:"center",gap:8,marginBottom:4})}">
                                    ${oe("maskVariable",ke,s.variable||n.variable,{dataKey:"maskVariable",infoType:"variable"}).replace('class="custom-select-wrapper"',`class="custom-select-wrapper" data-mask-index="${c}" style="width: 90px;"`)}
                                    ${oe("maskUnit",Oe(s.variable||n.variable).map(M=>M.label),s.unit||Ne(s.variable||n.variable).label,{dataKey:"maskUnit"}).replace('class="custom-select-wrapper"',`class="custom-select-wrapper" data-mask-index="${c}" style="width: 120px;"`)}
                                  </div>
                                  `:""}
                          <div style="${g({display:"flex",alignItems:"center",gap:8})}">
                            <input
                              type="number"
                              step="any"
                              value="${s.lowerEdited&&s.lowerBound!==null?s.lowerBound:""}"
                              data-action="update-mask-bound"
                              data-mask-index="${c}"
                              data-bound="lower"
                              placeholder="${en(p)}"
                              style="${g({width:"90px",background:"var(--gradient-bg)",border:"1px solid var(--border-strong)",borderRadius:8,color:"var(--text-primary)",padding:"6px 10px",fontSize:12.5,fontWeight:600,fontFamily:"var(--font-geist-sans)",letterSpacing:.25,minHeight:32,boxShadow:"inset 0 1px 0 var(--inset-light)"})}"
                            />
                            <span style="${g({fontSize:12.5,color:"var(--text-secondary)",minWidth:"20px",textAlign:"center"})}">to</span>
                            <input
                              type="number"
                              step="any"
                              value="${s.upperEdited&&s.upperBound!==null?s.upperBound:""}"
                              data-action="update-mask-bound"
                              data-mask-index="${c}"
                              data-bound="upper"
                              placeholder="${en(v)}"
                              style="${g({width:"90px",background:"var(--gradient-bg)",border:"1px solid var(--border-strong)",borderRadius:8,color:"var(--text-primary)",padding:"6px 10px",fontSize:12.5,fontWeight:600,fontFamily:"var(--font-geist-sans)",letterSpacing:.25,minHeight:32,boxShadow:"inset 0 1px 0 var(--inset-light)"})}"
                            />
                            <button
                              type="button"
                              data-action="remove-mask"
                              data-mask-index="${c}"
                              style="${g({width:28,height:28,padding:0,borderRadius:6,border:"1px solid var(--border-medium)",background:"var(--bg-transparent)",color:"var(--text-secondary)",fontSize:16,fontWeight:600,cursor:"pointer",transition:"all 0.15s ease",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0})}"
                              onmouseover="this.style.borderColor='var(--border-bright)'; this.style.background='var(--bg-medium)'"
                              onmouseout="this.style.borderColor='var(--border-medium)'; this.style.background='var(--bg-transparent)'"
                            >
                              −
                            </button>
                          </div>
                        `}).join("")}
                        <button
                          type="button"
                          data-action="apply-masks"
                          style="${g({padding:"10px 16px",borderRadius:10,border:"1px solid var(--border-strong)",background:"var(--gradient-primary)",color:"white",fontSize:12.5,fontWeight:700,cursor:"pointer",transition:"all 0.15s ease",textAlign:"center",width:"100%",marginTop:8,boxShadow:"var(--shadow-combined)"})}"
                          onmouseover="this.style.borderColor='var(--accent-border-bright)'; this.style.boxShadow='var(--shadow-elevated)'"
                          onmouseout="this.style.borderColor='var(--border-strong)'; this.style.boxShadow='var(--shadow-combined)'"
                        >
                          Apply Masks
                        </button>
                        <button
                          type="button"
                          data-action="add-mask"
                          style="${g({padding:"8px 14px",borderRadius:10,border:"1px solid var(--border-subtle)",background:"var(--bg-transparent)",color:"var(--text-secondary)",fontSize:12.5,fontWeight:600,cursor:"pointer",transition:"all 0.15s ease",textAlign:"left",width:"100%",marginTop:4})}"
                          onmouseover="this.style.borderColor='var(--border-medium)'; this.style.background='var(--bg-subtle)'"
                          onmouseout="this.style.borderColor='var(--border-subtle)'; this.style.background='var(--bg-transparent)'"
                        >
                          + Add Mask
                        </button>
                        ${n.mode==="Ensemble"?`
                        <button
                          type="button"
                          data-action="add-probability-mask"
                          style="${g({padding:"8px 14px",borderRadius:10,border:"1px solid var(--border-subtle)",background:"var(--bg-transparent)",color:"var(--text-secondary)",fontSize:12.5,fontWeight:600,cursor:"pointer",transition:"all 0.15s ease",textAlign:"left",width:"100%",marginTop:4})}"
                          onmouseover="this.style.borderColor='var(--border-medium)'; this.style.background='var(--bg-subtle)'"
                          onmouseout="this.style.borderColor='var(--border-subtle)'; this.style.background='var(--bg-transparent)'"
                        >
                          + Add Probability Mask
                        </button>
                        `:""}
                      </div>
                      `:`
                      <button
                        type="button"
                        data-action="add-mask"
                        style="${g({padding:"8px 14px",borderRadius:10,border:"1px solid var(--border-subtle)",background:"var(--bg-transparent)",color:"var(--text-secondary)",fontSize:12.5,fontWeight:600,cursor:"pointer",transition:"all 0.15s ease",textAlign:"left",width:"100%"})}"
                        onmouseover="this.style.borderColor='var(--border-medium)'; this.style.background='var(--bg-subtle)'"
                        onmouseout="this.style.borderColor='var(--border-subtle)'; this.style.background='var(--bg-transparent)'"
                      >
                        + Add Mask
                      </button>
                      ${n.mode==="Ensemble"?`
                      <button
                        type="button"
                        data-action="add-probability-mask"
                        style="${g({padding:"8px 14px",borderRadius:10,border:"1px solid var(--border-subtle)",background:"var(--bg-transparent)",color:"var(--text-secondary)",fontSize:12.5,fontWeight:600,cursor:"pointer",transition:"all 0.15s ease",textAlign:"left",width:"100%",marginTop:4})}"
                        onmouseover="this.style.borderColor='var(--border-medium)'; this.style.background='var(--bg-subtle)'"
                        onmouseout="this.style.borderColor='var(--border-subtle)'; this.style.background='var(--bg-transparent)'"
                      >
                        + Add Probability Mask
                      </button>
                      `:""}
                      `}
            </div>
          </div>
        </div>
      </div>
    </div>
  `}function an(e,t,a){const r=new Set(t);return`
      <div style="${g(D.chipRow)}">
        ${e.map(o=>{const i=r.has(o);return`
                  <button
                    type="button"
                    data-action="toggle-multi"
                    data-key="${a}"
                    data-value="${o}"
                    style="${g(De(D.chip,i?D.chipActive:void 0))}"
                  >
                    ${o}
                  </button>
                `}).join("")}
      </div>
    `}function Ko(){const e=n.chartLocationSearchResults.length>0?n.chartLocationSearchResults.map(r=>`
                <button
                  type="button"
                  class="location-search-result"
                  data-role="location-search-result"
                  data-name="${ye(r.displayName)}"
                  data-lat="${r.lat}"
                  data-lon="${r.lon}"
                >
                  <div class="location-search-result-name">${ye(r.displayName)}</div>
                  <div class="location-search-result-coord">
                    ${r.lat.toFixed(3)}, ${r.lon.toFixed(3)}
                  </div>
                </button>
              `).join(""):"",t=n.chartLocationSearchQuery.trim().length>0,a=n.chartLocationSearchError?`<div class="location-search-error">${ye(n.chartLocationSearchError)}</div>`:n.chartLocationSearchLoading?'<div class="location-search-status">Searching...</div>':n.chartLocationSearchResults.length===0&&t?'<div class="location-search-status">No places found. Try refining your query.</div>':"";return`
      <div class="custom-select-extra" data-role="chart-location-search">
        <div class="location-search-row">
          <input
            type="text"
            class="location-search-input"
            value="${ye(n.chartLocationSearchQuery)}"
            placeholder="Search a place (e.g. Aachen)"
            data-role="location-search-input"
          />
        </div>
        ${a}
        <div class="location-search-results" data-role="location-search-results">
          ${e||""}
        </div>
      </div>
    `}function Dp(){if(n.canvasView!=="map")return"";const e=n.mapLocationSearchResults.length>0?n.mapLocationSearchResults.map(l=>`
                <button
                  type="button"
                  class="location-search-result"
                  data-role="map-location-search-result"
                  data-name="${ye(l.displayName)}"
                  data-lat="${l.lat}"
                  data-lon="${l.lon}"
                >
                  <div class="location-search-result-name">${ye(l.displayName)}</div>
                  <div class="location-search-result-coord">
                    ${l.lat.toFixed(3)}, ${l.lon.toFixed(3)}
                  </div>
                </button>
              `).join(""):"",t=n.mapLocationSearchQuery.trim().length>0,a=n.mapLocationSearchError?`<div class="location-search-error">${ye(n.mapLocationSearchError)}</div>`:n.mapLocationSearchLoading?'<div class="location-search-status">Searching...</div>':n.mapLocationSearchResults.length===0&&t&&!n.mapLocationSearchSelection?'<div class="location-search-status">No places found. Try refining your query.</div>':"",r=!!(e||a&&!n.mapLocationSearchLoading),o=n.sidebarOpen?-Ee/2:0,i=De(D.mapSearchWrap,{top:18,transform:`translateX(calc(-50% + ${o}px))`});return`
      <div data-role="map-location-search" style="${g(i)}">
        <div class="location-search-row" style="display: flex; align-items: center; gap: 8px;">
          <input
            type="text"
            class="location-search-input"
            value="${ye(n.mapLocationSearchQuery)}"
            placeholder="Search a place (e.g. Aachen)"
            data-role="map-location-search-input"
            style="flex: 1;"
          />
          <button
            type="button"
            data-action="toggle-map-draw"
            aria-label="${n.drawState.active?"Stop drawing":"Start drawing"}"
            style="
              display: flex;
              align-items: center;
              justify-content: center;
              width: 36px;
              height: 36px;
              padding: 0;
              border: 1px solid rgba(148, 163, 184, 0.3);
              border-radius: 6px;
              background: ${n.drawState.active?"rgba(52, 211, 153, 0.1)":"rgba(15, 23, 42, 0.85)"};
              color: ${n.drawState.active?"#34d399":"var(--text-secondary)"};
              cursor: pointer;
              transition: all 0.2s ease;
            "
            onmouseover="this.style.background='rgba(52, 211, 153, 0.2)';this.style.color='#34d399';"
            onmouseout="this.style.background='${n.drawState.active?"rgba(52, 211, 153, 0.1)":"rgba(15, 23, 42, 0.85)"}';this.style.color='${n.drawState.active?"#34d399":"var(--text-secondary)"}';"
          >
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
          </button>
        </div>
        ${n.mapLocationSearchLoading?a:""}
        ${r?`
        ${n.mapLocationSearchLoading?"":a}
        <div
          class="location-search-results"
          data-role="map-location-search-results"
          style="${g(D.mapSearchResults)}"
        >
          ${e||""}
        </div>`:""}
      </div>
    `}function Tp(){console.log("Rendering chart section with state:",n);const e=n.chartMode==="single"?"translateX(0%)":"translateX(100%)",t=n.metaData?.scenarios?.length?Array.from(new Set(n.metaData.scenarios.map(Ke))):Re,a=n.metaData?.models?.length?n.metaData.models:Se,r=mn(n.chartScenarios.length?n.chartScenarios:t),o=(s,c,d,u,f)=>`
          <div style="${g({border:"1px solid var(--border-medium)",borderRadius:12,background:"var(--bg-subtle)",padding:"10px 12px"})}">
            <button
              type="button"
              data-action="toggle-collapse"
              data-key="${f}"
              style="${g({display:"flex",justifyContent:"space-between",alignItems:"center",width:"100%",background:"transparent",border:"none",color:"var(--text-primary)",fontWeight:700,fontSize:13,cursor:"pointer",padding:0})}"
            >
              <span>${s}</span>
              <span style="${g({color:"var(--text-secondary)",fontWeight:600,fontSize:12})}">${d} ${c?"▴":"▾"}</span>
            </button>
            ${c?`<div style="${g({marginTop:10,display:"flex",flexWrap:"wrap",gap:8})}">${u}</div>`:""}
          </div>
        `,i=`
      <div style="${g(D.paramGrid)}">
        ${ce("Date",st("chartDate",n.chartDate,{dataKey:"chartDate",min:r.start,max:r.end}))}
        ${ce("Variable",oe("chartVariable",ke,n.chartVariable,{dataKey:"chartVariable",infoType:"variable"}))}
      </div>
    
      <div style="margin-top:10px">
        ${ce("Location",oe("chartLocation",["World","Draw","Point"],n.chartLocation,{dataKey:"chartLocation",selectedLabel:n.chartLocation==="Search"&&n.chartLocationName?`Search: ${n.chartLocationName}`:n.chartLocation,extraContent:Ko()}))}
      </div>

      <div style="margin-top:14px">
        ${o("Scenarios",n.chartDropdown.scenariosOpen,`${n.chartScenarios.length} selected`,an(t,n.chartScenarios,"chartScenarios"),"chartScenarios")}
      </div>

      <div style="margin-top:14px">
        ${o("Models",n.chartDropdown.modelsOpen,`${n.chartModels.length} selected`,an(a,n.chartModels,"chartModels"),"chartModels")}
      </div>

      <div style="margin-top:14px">
        <div style="${g(D.sectionTitle)}">Unit</div>
        ${ce("",oe("chartUnit",Oe(n.chartVariable).map(s=>s.label),n.chartUnit,{dataKey:"chartUnit"}))}
      </div>
    `,l=`
      <div style="${g(D.paramGrid)}">
        ${ce("Start date",st("chartRangeStart",n.chartRangeStart,{dataKey:"chartRangeStart",min:r.start,max:r.end}))}
        ${ce("End date",st("chartRangeEnd",n.chartRangeEnd,{dataKey:"chartRangeEnd",min:r.start,max:r.end}))}
      </div>

      <div style="${g(De(D.paramGrid,{marginTop:12}))}">
        ${ce("Variable",oe("chartVariable",ke,n.chartVariable,{dataKey:"chartVariable",infoType:"variable"}))}
      </div>

      <div style="margin-top:10px">
        ${ce("Location",oe("chartLocation",["World","Draw","Point"],n.chartLocation,{dataKey:"chartLocation",selectedLabel:n.chartLocation==="Search"&&n.chartLocationName?`Search: ${n.chartLocationName}`:n.chartLocation,extraContent:Ko()}))}
      </div>

      <div style="margin-top:14px">
        ${o("Scenarios",n.chartDropdown.scenariosOpen,`${n.chartScenarios.length} selected`,an(t,n.chartScenarios,"chartScenarios"),"chartScenarios")}
      </div>

      <div style="margin-top:14px">
        ${o("Models",n.chartDropdown.modelsOpen,`${n.chartModels.length} selected`,an(a,n.chartModels,"chartModels"),"chartModels")}
      </div>

      <div style="margin-top:14px">
        <div style="${g(D.sectionTitle)}">Unit</div>
        ${ce("",oe("chartUnit",Oe(n.chartVariable).map(s=>s.label),n.chartUnit,{dataKey:"chartUnit"}))}
      </div>
    `;return`
      <div style="${g(D.modeSwitch)}">
        <div data-role="chart-mode-indicator" style="${g({...D.modeIndicator,transform:e})}"></div>
        ${["single","range"].map(s=>{const c=s==="single"?"Single dates":"Range";return`
              <button
                type="button"
                class="mode-btn"
                data-action="set-chart-mode"
                data-value="${s}"
                style="${g(De(D.modeBtn,n.chartMode===s?D.modeBtnActive:void 0))}"
              >
                ${c}
              </button>
            `}).join("")}
      </div>

      <div class="mode-pane-scrollable" style="${g(D.modePane)}">
        ${n.chartMode==="single"?i:l}
      </div>
    `}function Lp(){return`
    <div data-role="chat-section" style="${g({display:"flex",flexDirection:"column",gap:8})}">
      <div style="${g(D.sectionTitle)}">Chat</div>
      ${tm(n.chatMessages,n.chatInput,n.chatIsLoading)}
    </div>
  `}function Go(e,t,a){const r=Math.hypot(e,t);if(!r||!isFinite(r)||a<=0)return{x:0,y:0};const o=Math.min(1,a/r);return{x:e*o,y:t*o}}function Ep(e){ea&&(ea(),ea=null),Ct!==null&&(cancelAnimationFrame(Ct),Ct=null),vt!==null&&(cancelAnimationFrame(vt),vt=null),It!==null&&(clearTimeout(It),It=null),rt!==null&&(clearTimeout(rt),rt=null);const t=e.querySelector('[data-role="brand-eye"]');if(!t)return;let a={x:0,y:0},r={x:0,y:0},o={x:0,y:0},i={x:0,y:0},l=1,s=!1;const c=3e4,d=(b,T)=>{const P=t.getBoundingClientRect(),R=P.left+P.width/2,k=P.top+P.height/2,_=b-R,Y=T-k,z=Math.min(P.width,P.height)*.14,U=z*.6;a=Go(_,Y,z),r=Go(_,Y,U)},u=b=>{l=Math.max(0,Math.min(1,b)),t.style.setProperty("--blink-open",`${l}`)},f=()=>{rt!==null&&clearTimeout(rt),rt=window.setTimeout(()=>{a={x:0,y:0},r={x:0,y:0}},c)},m=()=>{o.x+=(a.x-o.x)*.28,o.y+=(a.y-o.y)*.28,i.x+=(r.x-i.x)*.32,i.y+=(r.y-i.y)*.32,t.style.setProperty("--iris-x",`${o.x}px`),t.style.setProperty("--iris-y",`${o.y}px`),t.style.setProperty("--pupil-x",`${i.x}px`),t.style.setProperty("--pupil-y",`${i.y}px`),Ct=requestAnimationFrame(m)},p=()=>{if(s)return;s=!0;const b=[{t:0,v:1},{t:.16,v:.08},{t:.26,v:.02},{t:.4,v:1}],T=350,P=performance.now(),R=k=>{const _=k-P,Y=Math.min(1,_/T);let K=b[0],z=b[b.length-1];for(let q=0;q<b.length-1;q++){const I=b[q],X=b[q+1];if(Y>=I.t&&Y<=X.t){K=I,z=X;break}}const U=z.t-K.t||1,te=Math.min(1,Math.max(0,(Y-K.t)/U)),J=1-Math.pow(1-te,2),w=K.v+(z.v-K.v)*J;u(w),Y<1?vt=requestAnimationFrame(R):(u(1),s=!1,v())};vt=requestAnimationFrame(R)},v=()=>{const b=3e3+Math.random()*15e3;It=window.setTimeout(p,b)},M=()=>{const b=t.getBoundingClientRect();d(b.left+b.width/2,b.top+b.height/2)},S=b=>{d(b.clientX,b.clientY),f()},x=()=>M();M(),m(),v(),f(),window.addEventListener("pointermove",S),window.addEventListener("pointerleave",x),ea=()=>{window.removeEventListener("pointermove",S),window.removeEventListener("pointerleave",x),Ct!==null&&(cancelAnimationFrame(Ct),Ct=null),vt!==null&&(cancelAnimationFrame(vt),vt=null),It!==null&&(clearTimeout(It),It=null),rt!==null&&(clearTimeout(rt),rt=null)}}function Rp(e){if(!ae)return;const t=ae;Ep(t),t.querySelectorAll('[data-action="update-mask-bound"]').forEach(h=>{h.__isMaskInput=!0;const y=$=>{$&&($.stopPropagation(),$.preventDefault(),$.stopImmediatePropagation());const N=h.dataset.bound,F=h.dataset.maskIndex;if(!N||F===void 0)return;const B=Number.parseInt(F,10);if(Number.isNaN(B)||B<0||B>=n.masks.length)return;const C=h.value.trim(),V=C===""?null:Number.parseFloat(C);if(C===""||!Number.isNaN(V)){const E=n.masks[B];let O=!1;N==="lower"?E.lowerBound!==V&&(E.lowerBound=V,E.lowerEdited=C!=="",O=!0):E.upperBound!==V&&(E.upperBound=V,E.upperEdited=C!=="",O=!0),O&&(n.__updatingMask=!0,W(),setTimeout(()=>{n.__updatingMask=!1},0))}};h.addEventListener("blur",$=>{y($)},{capture:!0}),h.addEventListener("keydown",$=>{$.key==="Enter"&&($.preventDefault(),$.stopPropagation(),$.stopImmediatePropagation(),y($),h.blur())},{capture:!0})}),rm({root:t,getSidebarOpen:()=>n.sidebarOpen,setSidebarOpen:h=>{n.sidebarOpen=h},onTimeSliderUpdate:h=>{Fm(h,Ee)},onCanvasToggleUpdate:h=>{const y=n.sidebarOpen?1:.9;Gi(h+8,y),ts()}}),t.querySelectorAll('[data-action="set-canvas"]').forEach(h=>h.addEventListener("click",()=>{const y=h.dataset.value;if(y){if(y===n.canvasView)return;const N=n.canvasView==="map"?"translateX(0%)":"translateX(100%)",F=y==="map"?"translateX(0%)":"translateX(100%)";n.canvasView=y,y==="chart"&&(n.panelTab="Manual");const B=it();B.active&&B.currentStep===13&&y==="chart"&&Vt(),W(),y==="map"?Ie():Ze();const C=t.querySelector('[data-role="canvas-indicator"]');if(!C)return;C.style.removeProperty("transition"),C.style.transform=N,C.offsetHeight,C.getBoundingClientRect(),requestAnimationFrame(()=>{C.style.transition="transform 180ms ease",C.style.transform=F})}})),t.querySelectorAll('[data-action="set-mode"]').forEach(h=>h.addEventListener("click",()=>{const y=h.dataset.value;if(y){if(y===n.mode)return;const $=n.mode,N=$==="Explore"?"translateX(0%)":$==="Compare"?"translateX(-33.333%)":"translateX(-66.666%)",F=$==="Explore"?"translateX(0%)":$==="Compare"?"translateX(100%)":"translateX(200%)",B=y==="Explore"?"translateX(0%)":y==="Compare"?"translateX(-33.333%)":"translateX(-66.666%)",C=y==="Explore"?"translateX(0%)":y==="Compare"?"translateX(100%)":"translateX(200%)";if(n.mode=y,y==="Compare"){const j=n.date;n.compareDateStart=Je(j,n.scenario),n.compareDateEnd=Je(Zi(j,30),n.scenario)}y==="Ensemble"&&(n.ensembleDate=n.date);const V=it();V.active&&V.currentStep===9&&y==="Compare"&&Vt(),W();const E=t.querySelector('[data-role="mode-track"]'),O=t.querySelector('[data-role="mode-indicator"]');if(!E||!O)return;E.style.transition="none",O.style.transition="none",E.style.transform=N,O.style.transform=F,E.offsetHeight,E.style.transition="transform 220ms ease",O.style.transition="transform 200ms ease",E.style.transform=B,O.style.transform=C}n.canvasView==="map"&&Ie()})),t.querySelectorAll('[data-action="set-chart-mode"]').forEach(h=>h.addEventListener("click",()=>{const y=h.dataset.value;if(!y||y===n.chartMode)return;const N=n.chartMode==="single"?"translateX(0%)":"translateX(100%)",F=y==="single"?"translateX(0%)":"translateX(100%)";n.chartMode=y,W();const B=t.querySelector('[data-role="chart-mode-indicator"]');B&&(B.style.removeProperty("transition"),B.style.transform=N,B.offsetHeight,requestAnimationFrame(()=>{B.style.transition="transform 200ms ease",B.style.transform=F})),n.canvasView==="chart"&&Ze()})),t.querySelectorAll('[data-action="set-tab"]').forEach(h=>h.addEventListener("click",()=>{const y=h.dataset.value;if(y){if(y===n.panelTab)return;const N=n.panelTab==="Manual"?"translateX(0%)":"translateX(-50%)",F=y==="Manual"?"translateX(0%)":"translateX(-50%)";n.panelTab=y;const B=it();B.active&&B.currentStep===11&&y==="Chat"&&Vt(),W();const C=t.querySelector('[data-role="tab-track"]');if(!C)return;C.style.removeProperty("transition"),C.style.transform=N,C.offsetHeight,C.getBoundingClientRect(),requestAnimationFrame(()=>{C.style.transition="transform 220ms ease",C.style.transform=F})}}));const s=t.querySelectorAll(".custom-select-wrapper");let c=document.querySelector(".custom-select-info-panel-shared");c||(c=document.createElement("div"),c.className="custom-select-info-panel custom-select-info-panel-shared",c.setAttribute("role","tooltip"),document.body.appendChild(c));const d=h=>{h.target.closest(".custom-select-wrapper")||(s.forEach($=>{$.classList.remove("open")}),c&&c.classList.remove("visible"))},u=h=>{h.key==="Escape"&&(s.forEach(y=>{y.classList.remove("open")}),c&&c.classList.remove("visible"))};document.addEventListener("click",d),document.addEventListener("keydown",u),s.forEach(h=>{const y=h.querySelector(".custom-select-trigger"),$=h.querySelector(".custom-select-dropdown"),N=h.querySelectorAll(".custom-select-option"),F=h.dataset.key,B=h.dataset.infoType,C=h.dataset.disabled==="true";if(!y||!$||C)return;const V=c,E=(L,Q)=>{if(!V||!B)return;let Z="",se=L;if(B==="scenario"?Z=qm[L]||"":B==="variable"?(Z=Hm[L]||"",se=zm[L]||L):B==="model"&&(Z=Wm[L]||""),Z){if(V.innerHTML=`
                    <div class="custom-select-info-panel-title">${se}</div>
                    <div class="custom-select-info-panel-content">${Z}</div>
                `,Q||y){const ee=Q||y;if(ee){const re=ee.getBoundingClientRect();V.style.left=`${re.left-272}px`,V.style.top=`${re.top}px`}}V.classList.add("visible")}},O=()=>{V&&V.classList.remove("visible")};y.addEventListener("click",L=>{if(L.stopPropagation(),C)return;const Q=h.classList.contains("open");s.forEach(se=>{se!==h&&se.classList.remove("open")}),h.classList.toggle("open",!Q),it().active&&setTimeout(()=>{W()},50)}),y.addEventListener("keydown",L=>{if(!C&&(L.key==="Enter"||L.key===" "||L.key==="ArrowDown")){L.preventDefault(),h.classList.add("open");const Q=N[0];Q&&Q.focus()}}),N.forEach(L=>{L.addEventListener("click",Q=>{Q.stopPropagation();const Z=L.dataset.value;if(!Z||!F)return;N.forEach(ge=>{ge.classList.remove("selected"),ge.removeAttribute("aria-selected")}),L.classList.add("selected"),L.setAttribute("aria-selected","true");const se=y.querySelector(".custom-select-value");se&&(se.textContent=Z),h.classList.remove("open"),O();const ee=h.dataset.maskIndex;f(F,Z,ee);const re=it();re.active&&{1:"scenario",2:"model",4:"variable",5:"unit",6:"mapPalette"}[re.currentStep]===F&&setTimeout(()=>{Vt(),W()},100)}),B&&(L.addEventListener("mouseenter",()=>{const Q=L.dataset.value;Q&&E(Q,L)}),L.addEventListener("mouseleave",()=>{O()})),L.addEventListener("keydown",Q=>{const Z=Array.from(N).indexOf(L);if(Q.key==="Enter"||Q.key===" ")Q.preventDefault(),L.click();else if(Q.key==="ArrowDown"){Q.preventDefault();const se=(Z+1)%N.length;N[se]?.focus()}else if(Q.key==="ArrowUp"){Q.preventDefault();const se=Z===0?N.length-1:Z-1;N[se]?.focus()}else Q.key==="Escape"?(Q.preventDefault(),h.classList.remove("open"),O(),y.focus()):Q.key==="Home"?(Q.preventDefault(),N[0]?.focus()):Q.key==="End"&&(Q.preventDefault(),N[N.length-1]?.focus())})}),new MutationObserver(L=>{L.forEach(Q=>{Q.type==="attributes"&&Q.attributeName==="class"&&(h.classList.contains("open")||O())})}).observe(h,{attributes:!0})});const f=async(h,y,$)=>{if(!h)return;let N=!1,F=!1;switch(h){case"scenario":n.scenario=y,n.date=Ln(y),n.ensembleDate=n.date,n.timeRange=qe(y),N=!0;break;case"model":n.model=y,N=!0;break;case"variable":n.variable=y,n.selectedUnit=Ne(y).label,N=!0;break;case"unit":if(n.selectedUnit=y,W(),n.currentData&&ae&&n.dataMin!==null&&n.dataMax!==null){const C=ae.querySelector("#map-canvas");if(C)try{ve=C,_n(C),Tn(n.currentData,ve,ue,n.mapPalette,n.dataMin,n.dataMax,n.variable,n.selectedUnit,n.masks,null,!1,n.mode==="Explore"?n.maskVariableData:void 0);const V=ue.find(E=>E.name===n.mapPalette)||ue[0];Dn("legend-gradient-canvas",V.colors)}catch(V){console.error("Map redraw (unit change) failed:",V)}}if(n.mapMarker){if(n.mapInfoOpen)if(n.mapInfoSamples.length){const{variable:C,unit:V}=tt();n.mapInfoBoxes=sn(n.mapInfoSamples,C,V),W()}else n.mapInfoLoading||Ft();if(n.mapRangeOpen)if(n.mapRangeSamples.length){const{variable:C,unit:V}=jt();n.mapRangeSeries=Tt(n.mapRangeSamples,C,V),W()}else n.mapRangeLoading||En()}return;case"mapPalette":if(n.mapPalette=y,W(),n.canvasView==="map"&&n.currentData&&ae&&n.dataMin!==null&&n.dataMax!==null){const C=ae.querySelector("#map-canvas");if(C){ve=C,Tn(n.currentData,ve,ue,n.mapPalette,n.dataMin,n.dataMax,n.variable,n.selectedUnit,n.masks,null,!1,n.mode==="Explore"?n.maskVariableData:void 0);const V=ue.find(E=>E.name===n.mapPalette)||ue[0];Dn("legend-gradient-canvas",V.colors)}}return;case"mapInfoPalette":n.mapInfoPalette=y,W();return;case"mapRangePalette":n.mapRangePalette=y,W();return;case"chartPalette":n.chartPalette=y,W();return;case"compareMode":n.compareMode=y,N=!0;break;case"compareScenarioA":y===n.compareScenarioB&&(n.compareScenarioB=n.compareScenarioA),n.compareScenarioA=y,N=!0;break;case"compareScenarioB":y===n.compareScenarioA&&(n.compareScenarioA=n.compareScenarioB),n.compareScenarioB=y,N=!0;break;case"compareModelA":y===n.compareModelB&&(n.compareModelB=n.compareModelA),n.compareModelA=y,N=!0;break;case"compareModelB":y===n.compareModelA&&(n.compareModelA=n.compareModelB),n.compareModelB=y,N=!0;break;case"chartVariable":n.chartVariable=y,n.chartUnit=Ne(y).label,F=!0;break;case"chartUnit":n.chartUnit=y,n.chartSamples.length&&(n.chartMode==="range"?(n.chartRangeSeries=Tt(n.chartSamples,n.chartVariable,n.chartUnit),n.chartBoxes=null):n.chartBoxes=sn(n.chartSamples,n.chartVariable,n.chartUnit)),W();return;case"ensembleVariable":if(n.mode==="Ensemble"&&n.masks.some(C=>C.kind==="probability"))return;n.ensembleVariable=y,n.ensembleUnit=Ne(y).label,N=!0;break;case"ensembleUnit":if(n.ensembleUnit=y,W(),n.currentData&&ae&&n.dataMin!==null&&n.dataMax!==null&&n.mode==="Ensemble"){const C=ae.querySelector("#map-canvas");if(C){ve=C,_n(C),Tn(n.currentData,ve,ue,n.mapPalette,n.dataMin,n.dataMax,n.ensembleVariable,n.ensembleUnit,n.masks,n.ensembleStatistics,!0,void 0,n.ensembleStatisticsByVariable,n.ensembleRawSamplesByVariable);const V=ue.find(E=>E.name===n.mapPalette)||ue[0];Dn("legend-gradient-canvas",V.colors)}}if(n.mapMarker&&n.mapInfoOpen)if(n.mapInfoSamples.length){const{variable:C,unit:V}=tt();n.mapInfoBoxes=sn(n.mapInfoSamples,C,V),W()}else n.mapInfoLoading||Ft();if(n.mapRangeOpen)if(n.mapRangeSamples.length){const{variable:C,unit:V}=jt();n.mapRangeSeries=Tt(n.mapRangeSamples,C,V),W()}else n.mapRangeLoading||En();return;case"ensembleStatistic":n.ensembleStatistic=y,N=!0;break;case"maskStatistic":{if($!==void 0){const C=Number.parseInt($,10);if(!Number.isNaN(C)&&C>=0&&C<n.masks.length){const V=y,E=n.masks[C];if(E.statistic=V,n.mode==="Ensemble"){const O=E.variable||n.ensembleVariable,j=E.unit||n.ensembleUnit,L=E.kind==="probability"?Dt(O,j):kt(V,O,j);E.lowerBound=L.min,E.upperBound=L.max,E.lowerEdited=!1,E.upperEdited=!1}W(),n.mode==="Ensemble"&&n.canvasView==="map"&&Ie()}}return}case"maskVariable":{if($!==void 0){const C=Number.parseInt($,10);if(!Number.isNaN(C)&&C>=0&&C<n.masks.length){const V=n.masks[C];if(V.variable=y,V.unit=Ne(y).label,n.mode==="Ensemble"){const E=V.statistic||"mean",O=V.kind==="probability"?Dt(V.variable,V.unit):kt(E,V.variable,V.unit);V.lowerBound=O.min,V.upperBound=O.max,V.lowerEdited=!1,V.upperEdited=!1}else V.lowerBound=null,V.upperBound=null,V.lowerEdited=!1,V.upperEdited=!1;W(),(n.mode==="Explore"||n.mode==="Ensemble")&&n.canvasView==="map"&&(Ie(),W())}}return}case"maskUnit":{if($!==void 0){const C=Number.parseInt($,10);if(!Number.isNaN(C)&&C>=0&&C<n.masks.length){const V=n.masks[C];if(V.unit=y,n.mode==="Ensemble"){const E=V.kind==="probability"?Dt(V.variable||n.ensembleVariable,V.unit):kt(V.statistic||"mean",V.variable||n.ensembleVariable,V.unit);V.lowerBound=E.min,V.upperBound=E.max,V.lowerEdited=!1,V.upperEdited=!1}if(W(),n.mode==="Ensemble"&&n.canvasView==="map"&&n.currentData&&ae&&n.dataMin!==null&&n.dataMax!==null){const E=ae.querySelector("#map-canvas");if(E){ve=E,_n(E),Tn(n.currentData,ve,ue,n.mapPalette,n.dataMin,n.dataMax,n.ensembleVariable,n.ensembleUnit,n.masks,n.ensembleStatistics,!0,void 0,n.ensembleStatisticsByVariable,n.ensembleRawSamplesByVariable);const O=ue.find(j=>j.name===n.mapPalette)||ue[0];Dn("legend-gradient-canvas",O.colors)}}}}return}case"chartLocation":if(y==="Draw"){qo();return}if(y==="Point"){zo();return}if(y==="Search"){n.chartLocation="Search",n.chartPolygon=null,n.pointSelectActive=!1,n.drawState=Et(),n.chartError=null,n.chartLocationName=null,n.chartLocationSearchError=null,n.chartLocationSearchResults=[],n.chartLocationSearchQuery="",n.chartLocationSearchLoading=!1,n.canvasView="chart",Ra(),Pa(),W();return}n.chartLocation="World",n.chartPolygon=null,n.chartPoint=null,n.chartLocationName=null,n.chartLocationSearchError=null,n.chartLocationSearchResults=[],n.chartLocationSearchQuery="",n.chartLocationSearchLoading=!1,Ra(),Pa(),F=!0;break}const B=()=>{if(W(),n.canvasView==="map"&&N){Ie();const C=n.mapMarker!==null,V=n.mapPolygon!==null&&n.mapPolygon.length>=3;(C||V)&&n.mapInfoOpen&&Ft(),C&&n.mapRangeOpen&&En()}n.canvasView==="chart"&&(F||N)&&Ze()};N||F?setTimeout(B,0):B()},m=t.querySelector('.custom-select-wrapper[data-key="chartLocation"]');if(m){let h=function(){const C=ae?.querySelector('.custom-select-wrapper[data-key="chartLocation"]');if(!C)return;const V=C.querySelector('[data-role="location-search-input"]');V&&(V.value=n.chartLocationSearchQuery);const E=C.querySelector('[data-role="location-search-results-container"]');if(E){if(E.innerHTML="",n.chartLocationSearchLoading)E.innerHTML='<div class="search-loading">Loading...</div>';else if(n.chartLocationSearchError)E.innerHTML=`<div class="search-error">${n.chartLocationSearchError}</div>`;else if(n.chartLocationSearchResults.length>0)for(const O of n.chartLocationSearchResults){const j=document.createElement("div");j.className="custom-select-option search-result",j.setAttribute("data-role","location-search-result"),j.setAttribute("data-lat",String(O.lat)),j.setAttribute("data-lon",String(O.lon)),j.setAttribute("data-name",O.displayName||"Selected place"),j.textContent=O.displayName||`${O.lat}, ${O.lon}`,j.addEventListener("click",()=>{C.classList.remove("open"),Ho({displayName:O.displayName||"Selected place",lat:O.lat,lon:O.lon})}),E.appendChild(j)}}};m.querySelectorAll(".custom-select-option").forEach(C=>{C.addEventListener("click",()=>{const V=C.dataset.value;V==="Draw"&&n.chartLocation==="Draw"?qo():V==="Point"&&n.chartLocation==="Point"&&zo()})});const $=m.querySelectorAll('[data-role="location-search-input"]'),N=m.querySelectorAll('[data-role="location-search-result"]'),F=()=>{Ot!==null&&(window.clearTimeout(Ot),Ot=null)},B=C=>{F(),ip(C)};if($.forEach(C=>{C.addEventListener("input",()=>{const V=n.chartLocationSearchResults.length>0,E=n.chartLocationSearchLoading,O=!!n.chartLocationSearchError;if(n.chartLocationSearchQuery=C.value,n.chartLocationSearchError=null,F(),!C.value.trim()){n.chartLocationSearchResults=[],n.chartLocationSearchLoading=!1,h();return}(V||E||O)&&(n.chartLocationSearchResults=[],n.chartLocationSearchLoading=!1,h()),Ot=window.setTimeout(()=>{B(C.value)},Fo)}),C.addEventListener("keydown",V=>{V.key==="Enter"&&(V.preventDefault(),F(),B(C.value))})}),N.forEach(C=>{C.addEventListener("click",()=>{const V=Number(C.dataset.lat),E=Number(C.dataset.lon),O=C.dataset.name??"Selected place";!Number.isFinite(V)||!Number.isFinite(E)||(m.classList.remove("open"),Ho({displayName:O,lat:V,lon:E}))})}),n.chartLocation==="Search"){const C=m.querySelector('[data-role="location-search-input"]');C&&setTimeout(()=>C.focus(),0)}}const p=t.querySelectorAll('[data-role="map-location-search-input"]'),v=t.querySelectorAll('[data-role="map-location-search-result"]'),M=()=>{qt!==null&&(window.clearTimeout(qt),qt=null)},S=h=>{M(),lp(h)};if(p.forEach(h=>{h.addEventListener("focus",()=>{n.mapLocationSearchFocused=!0});const y=()=>{const $=h.selectionStart??h.value.length,N=h.selectionEnd??h.value.length;n.mapLocationSearchCursor={start:$,end:N}};h.addEventListener("input",()=>{const $=n.mapLocationSearchResults.length>0,N=n.mapLocationSearchLoading,F=!!n.mapLocationSearchError;if(n.mapLocationSearchQuery=h.value,n.mapLocationSearchError=null,n.mapLocationSearchSelection=null,n.mapLocationSearchFocused=!0,y(),M(),!h.value.trim()){n.mapLocationSearchResults=[],n.mapLocationSearchLoading=!1,W();return}($||N||F)&&(n.mapLocationSearchResults=[],n.mapLocationSearchLoading=!1,W()),qt=window.setTimeout(()=>{S(h.value)},Fo)}),h.addEventListener("keyup",y),h.addEventListener("click",y),h.addEventListener("select",y),h.addEventListener("keydown",$=>{$.key==="Enter"&&($.preventDefault(),M(),S(h.value))})}),v.forEach(h=>{h.addEventListener("click",()=>{const y=Number(h.dataset.lat),$=Number(h.dataset.lon),N=h.dataset.name??"Selected place";!Number.isFinite(y)||!Number.isFinite($)||sp({displayName:N,lat:y,lon:$})})}),n.mapLocationSearchFocused){const h=t.querySelector('[data-role="map-location-search-input"]');if(h){setTimeout(()=>h.focus(),0);const{start:y,end:$}=n.mapLocationSearchCursor,N=Math.min(y,h.value.length),F=Math.min($,h.value.length);setTimeout(()=>h.setSelectionRange(N,F),0)}}t.querySelectorAll('select[data-action="update-select"]').forEach(h=>h.addEventListener("change",async()=>{const y=h.dataset.key,$=h.value;y&&await f(y,$)})),t.querySelectorAll('[data-action="toggle-multi"]').forEach(h=>h.addEventListener("click",()=>{const y=h.dataset.key,$=h.dataset.value;if(!(!y||!$)){if(y==="chartScenarios"){const N=n.metaData?.scenarios?.length&&n.metaData.scenarios?Array.from(new Set(n.metaData.scenarios.map(Ke))):Re,F=$==="Historical",B=new Set(n.chartScenarios);B.has($)?B.delete($):F?(B.clear(),B.add("Historical")):(B.delete("Historical"),B.add($)),B.size===0&&B.add(F?"Historical":$),n.chartScenarios=Array.from(B).filter(V=>N.includes(V));const C=mn(n.chartScenarios);n.chartDate=$e(n.chartDate,C),n.chartRangeStart=$e(n.chartRangeStart,C),n.chartRangeEnd=$e(n.chartRangeEnd,C)}if(y==="chartModels"){const N=n.metaData?.models?.length&&n.metaData.models?n.metaData.models:Se,F=new Set(n.chartModels);F.has($)?F.delete($):F.add($),n.chartModels=F.size?Array.from(F):[...N]}if(y==="ensembleScenarios"){const N=n.metaData?.scenarios?.length&&n.metaData.scenarios?Array.from(new Set(n.metaData.scenarios.map(Ke))):Re,F=$==="Historical",B=new Set(n.ensembleScenarios);B.has($)?B.delete($):F?(B.clear(),B.add("Historical")):(B.delete("Historical"),B.add($)),B.size===0&&B.add(F?"Historical":$),n.ensembleScenarios=Array.from(B).filter(V=>N.includes(V));const C=mn(n.ensembleScenarios);n.ensembleDate=$e(n.ensembleDate,C)}if(y==="ensembleModels"){const N=n.metaData?.models?.length?n.metaData.models:Se,F=new Set(n.ensembleModels);F.has($)?F.delete($):F.add($),n.ensembleModels=F.size?Array.from(F):[...N]}W(),n.canvasView==="chart"?Ze():n.canvasView==="map"&&n.mode==="Ensemble"&&Ie()}})),t.querySelectorAll('[data-action="toggle-collapse"]').forEach(h=>h.addEventListener("click",()=>{const y=h.dataset.key;y&&(y==="chartScenarios"&&(n.chartDropdown.scenariosOpen=!n.chartDropdown.scenariosOpen),y==="chartModels"&&(n.chartDropdown.modelsOpen=!n.chartDropdown.modelsOpen),y==="ensembleScenarios"&&(n.ensembleDropdown.scenariosOpen=!n.ensembleDropdown.scenariosOpen),y==="ensembleModels"&&(n.ensembleDropdown.modelsOpen=!n.ensembleDropdown.modelsOpen),W())})),t.querySelectorAll('[data-action="update-input"]').forEach(h=>{let y=!1,$=null;const N=()=>{const B=h.value;!(/^\d{4}-\d{2}-\d{2}$/.test(B)&&!isNaN(new Date(B).getTime()))&&B.length>0?h.style.borderColor="rgba(239, 68, 68, 0.6)":h.style.borderColor=""},F=()=>{const B=h.dataset.key;if(!B)return;const C=h.value;if(!(/^\d{4}-\d{2}-\d{2}$/.test(C)&&!isNaN(new Date(C).getTime()))){const Z=B==="date"?n.date:B==="compareDateStart"?n.compareDateStart:B==="compareDateEnd"?n.compareDateEnd:B==="chartRangeStart"?n.chartRangeStart:B==="chartRangeEnd"?n.chartRangeEnd:n.chartDate;h.value=Z,h.style.borderColor="";return}h.style.borderColor="";let j=C;if(B==="date"&&(j=Je(C,n.scenario),j!==C&&(h.value=j)),(B==="date"?n.date:B==="compareDateStart"?n.compareDateStart:B==="compareDateEnd"?n.compareDateEnd:B==="chartRangeStart"?n.chartRangeStart:B==="chartRangeEnd"?n.chartRangeEnd:n.chartDate)===j)return;switch(B){case"date":n.date=j,n.ensembleDate=j;break;case"compareDateStart":n.compareDateStart=C;break;case"compareDateEnd":n.compareDateEnd=C;break;case"chartDate":n.chartDate=C;break;case"chartRangeStart":n.chartRangeStart=C;break;case"chartRangeEnd":n.chartRangeEnd=C;break;case"ensembleDate":n.ensembleDate=C;break}const Q=it();if(B==="date"&&Q.active&&Q.currentStep===3&&setTimeout(()=>{Vt(),W()},100),W(),B==="date"||n.mode==="Compare"&&(B==="compareDateStart"||B==="compareDateEnd")||n.mode==="Ensemble"&&B==="ensembleDate"){Ie();const Z=n.mapMarker!==null,se=n.mapPolygon!==null&&n.mapPolygon.length>=3;(Z||se)&&n.mapInfoOpen&&Ft()}n.canvasView==="chart"&&(B==="chartDate"||B==="chartRangeStart"||B==="chartRangeEnd")&&Ze()};h.addEventListener("input",()=>{y=!0,N(),$!==null&&window.clearTimeout($),$=window.setTimeout(()=>{y=!1},300)}),h.addEventListener("blur",B=>{B.target.__isMaskInput||(y=!1,$!==null&&(window.clearTimeout($),$=null),F())}),h.addEventListener("keydown",B=>{B.key==="Enter"&&(B.preventDefault(),y=!1,$!==null&&(window.clearTimeout($),$=null),F(),h.blur())}),h.addEventListener("change",()=>{y||F()})});const R=t.querySelectorAll('[data-action="set-resolution"]'),k=t.querySelectorAll('[data-role="resolution-value"]'),_=h=>{const y=(h-1)/2*100,$=h===1?"Low":h===2?"Medium":"High";R.forEach(N=>{N.value=String(h),N.style.setProperty("--slider-fill",`${y}%`)}),k.forEach(N=>{N.textContent=$})};R.forEach(h=>h.addEventListener("input",()=>{const y=Number.parseInt(h.value,10);Number.isNaN(y)||(n.resolution=y,_(y),n.canvasView==="map"&&Ie())}));const Y=h=>{if(h==="probability"&&n.mode!=="Ensemble")return;let y=n.dataMin,$=n.dataMax;if(n.mode==="Explore"){const F=fa(n.variable,n.selectedUnit);F&&(y=F.min,$=F.max)}else if(n.mode==="Ensemble"){const F=h==="probability"?Dt(n.ensembleVariable,n.ensembleUnit):kt("mean",n.ensembleVariable,n.ensembleUnit);y=F.min,$=F.max}const N={id:Ym++,lowerBound:y,upperBound:$,lowerEdited:!1,upperEdited:!1,kind:h};n.mode==="Ensemble"&&(N.statistic="mean",N.variable=n.ensembleVariable,N.unit=n.ensembleUnit),n.mode==="Explore"&&(N.variable=n.variable,N.unit=n.selectedUnit),n.masks.push(N),W()};t.querySelectorAll('[data-action="add-mask"]').forEach(h=>{h.addEventListener("click",()=>{Y("binary")})}),t.querySelectorAll('[data-action="add-probability-mask"]').forEach(h=>{h.addEventListener("click",()=>{Y("probability")})}),t.querySelectorAll('[data-action="remove-mask"]').forEach(h=>{h.addEventListener("click",()=>{const y=h.dataset.maskIndex;if(y===void 0)return;const $=Number.parseInt(y,10);!Number.isNaN($)&&$>=0&&$<n.masks.length&&(n.masks.splice($,1),W())})}),t.querySelector('[data-action="apply-masks"]')?.addEventListener("click",()=>{n.canvasView==="map"&&Ie()}),t.querySelector('[data-action="open-compare-info"]')?.addEventListener("click",()=>{n.compareInfoOpen=!0,W()}),t.querySelectorAll('[data-action="close-compare-info"]').forEach(h=>h.addEventListener("click",()=>{n.compareInfoOpen=!1,W()})),t.querySelector('[data-action="close-map-info"]')?.addEventListener("click",h=>{h.preventDefault(),up()}),t.querySelector('[data-action="close-map-range"]')?.addEventListener("click",h=>{h.preventDefault(),Kr()}),t.querySelector('[data-action="open-map-info-chart"]')?.addEventListener("click",h=>{if(h.preventDefault(),!n.mapMarker&&!n.mapPolygon)return;n.canvasView="chart",n.chartMode="single",n.chartPalette=n.mapInfoPalette,n.mapPolygon&&n.mapPolygon.length>=3?(n.chartLocation="Draw",n.chartPolygon=n.mapPolygon,n.chartPoint=null,n.chartLocationName=null):n.mapMarker&&(n.chartLocation="Point",n.chartPoint={lat:n.mapMarker.lat,lon:n.mapMarker.lon},n.chartLocationName=n.mapMarker.name??null,n.chartPolygon=null);const{variable:y,unit:$}=tt();n.chartVariable=y,n.chartUnit=$,n.chartDate=n.mode==="Ensemble"?n.ensembleDate:n.date,n.chartError=null,W(),Ze()});const A=t.querySelector("#map-info-panel"),H=A?.querySelector(".map-info-header");if(A&&H){A.addEventListener("pointerdown",$=>{$.stopPropagation()});const h=$=>{if(!Ce.active||Ce.pointerId!==null&&$.pointerId!==Ce.pointerId)return;$.preventDefault();const F=A.offsetParent?.getBoundingClientRect(),B=F?.left??0,C=F?.top??0,V=ve?.getBoundingClientRect()??F??A.getBoundingClientRect(),E=F?V.left-F.left:0,O=F?V.top-F.top:0,j=A.getBoundingClientRect(),L=j.width||A.offsetWidth||360,Q=j.height||A.offsetHeight||240,Z=12,se=n.sidebarOpen?Ee:0;let ee=$.clientX-B-Ce.offsetX,re=$.clientY-C-Ce.offsetY;const ge=E+Z,He=E+V.width-L-Z-se,hn=O+Z,gn=O+V.height-Q-Z;He<ge?ee=ge:ee=Math.max(ge,Math.min(ee,He)),gn<hn?re=hn:re=Math.max(hn,Math.min(re,gn)),A.style.left=`${ee}px`,A.style.top=`${re}px`,Bt={left:ee,top:re}},y=$=>{Ce.active&&(Ce.pointerId!==null&&$.pointerId!==Ce.pointerId||(Ce.active=!1,Ce.pointerId=null,H.style.cursor="grab",A.classList.remove("is-dragging"),A.releasePointerCapture?.($.pointerId),document.body.style.userSelect="",window.removeEventListener("pointermove",h),window.removeEventListener("pointerup",y)))};H.addEventListener("pointerdown",$=>{if($.button!==0||$.target?.closest("button, .custom-select-wrapper, .custom-select-dropdown, .custom-select-option"))return;$.preventDefault(),$.stopPropagation();const F=A.getBoundingClientRect();Ce.active=!0,Ce.pointerId=$.pointerId,Ce.offsetX=$.clientX-F.left,Ce.offsetY=$.clientY-F.top,H.style.cursor="grabbing",A.classList.add("is-dragging"),A.setPointerCapture?.($.pointerId),document.body.style.userSelect="none",window.addEventListener("pointermove",h),window.addEventListener("pointerup",y)})}t.querySelector('[data-action="toggle-map-draw"]')?.addEventListener("click",h=>{h.preventDefault(),n.drawState.active?rp():ap()}),Vm({root:t,getTimeRange:()=>n.timeRange,onDateChange:h=>{n.date=h,n.ensembleDate=h,Ie();const y=n.mapMarker!==null,$=n.mapPolygon!==null&&n.mapPolygon.length>=3;(y||$)&&n.mapInfoOpen&&Ft(),y&&n.mapRangeOpen&&En()},getMode:()=>n.mode,getCompareMode:()=>n.compareMode,getCompareDates:()=>({start:n.compareDateStart,end:n.compareDateEnd}),onDateRangeChange:(h,y)=>{n.compareDateStart=h,n.compareDateEnd=y,Ie()}}),nm(t,n)}async function Qo(){if(ae=document.querySelector("#app"),!ae)throw new Error("Root element #app not found");Zf(e=>{if(Object.assign(n,e),W(),n.canvasView==="map"){const t=e.date||e.model||e.scenario||e.variable,a=e.ensembleDate||e.ensembleModels||e.ensembleScenarios||e.ensembleVariable||e.ensembleUnit||e.mode==="Ensemble",r=e.compareMode||e.compareScenarioA||e.compareScenarioB||e.compareModelA||e.compareModelB||e.compareDateStart||e.compareDateEnd||e.mode==="Compare";(t||a||r)&&Ie()}else e.mapPalette&&n.currentData&&W();n.canvasView==="chart"&&(e.chartDate||e.chartRangeStart||e.chartRangeEnd)&&Ze()}),W(),Gm().then(()=>{W(),n.canvasView==="map"&&n.mode==="Explore"&&Ie()}),ae.addEventListener("click",e=>{const t=e.target,a=t.closest("[data-action]"),r=a?.getAttribute("data-action");if(r==="tutorial-continue"){e.preventDefault(),e.stopPropagation();const o=it(),i=Hn[o.currentStep]?.id??"";if(i==="compare-switch"){const l=document.querySelector('[data-action="set-mode"][data-value="Compare"]');if(l){l.click();return}}if(i==="chat-switch"){const l=document.querySelector('[data-action="set-tab"][data-value="Chat"]');if(l){l.click();return}}if(i==="analysis-switch"){const l=document.querySelector('[data-action="set-canvas"][data-value="chart"]');if(l){l.click();return}}Vt(),W();return}if(r==="close-tutorial"){e.preventDefault(),e.stopPropagation(),Bi(),W();return}if(r==="start-tutorial"){e.preventDefault(),e.stopPropagation(),n.canvasView="map",n.mode="Explore",n.panelTab="Manual",im(),W();return}if(r==="update-select"){const o=it();if(o.active){const i=a?.getAttribute("data-key");(t.classList.contains("custom-select-trigger")||t.closest(".custom-select-trigger"))&&setTimeout(()=>{W()},50),{1:"scenario",2:"model",4:"variable",5:"unit",6:"mapPalette"}[o.currentStep]===i&&(t.classList.contains("custom-select-option")||t.closest(".custom-select-option"))&&setTimeout(()=>{Vt(),W()},100)}}})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Qo):Qo();
